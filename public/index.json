[{"content":"task 1 é™æ€å›¾ The table below shows how the UK unemployed spent their time last year.\nSummarise the information by selecting and reporting the main features, and make comparisons where relevant.\nThe table illustrates the things unemployed spent time on last year in UK.\nOverall, people prefer handling stuff in morning rather than afternoon, such as doing housework, shopping and job hunting. Whatsmore, the choice is different in some fields by gender.\nOn the one hand, 68% of unemployed intent to do housework in morning, much higher than that in the afternoon, with only 28%. Shopping is another similar circumstance, 20% declined in the afternoon compare with 46% on first half of day. However, there is a exception, both men and women tend to watch TV in the afternoon, with 10% increasing along the day.\nOn the other hand, some arrangements are varied between men and women. 49% of women spent time on housework, while only 19% men interested in that. Opposite with housework, men showed more passion than women in gardening, 27% versus 5% in a whole day. At the same time, job hunting and sitting around have little difference in gender, separately within 6% and 3%.\nEvaluation: Task Achievement: 6.0 The candidate addresses the general topic of how unemployed people in the UK spent their time last year, distinguishing between activities preferred in the morning versus the afternoon and differences between gender. However, the response lacks overall clarity in presenting precise data comparison. Some statistical details mentioned do not relate directly to the task\u0026rsquo;s requirement to discuss the table effectively. The emphasis on time slots is appropriate, but a lack of clarity in summarizing and comparing critical data lowers the score.\nCoherence and Cohesion: 6.5 The structure of the essay shows a basic logical flow, distinguishing between morning activities and gender differences. However, the transitions between ideas are sometimes abrupt, and the linking phrases like \u0026ldquo;Whatsmore\u0026rdquo; and \u0026ldquo;On the one hand\u0026rdquo; are used awkwardly. The use of paragraphs is clear, but better cohesion could be achieved by smoother transitions and a clearer linkage between the data presented and the tasks outlined in the table.\nLexical Resource: 6.0 The use of vocabulary is adequate with terms like \u0026ldquo;intent\u0026rdquo;, \u0026ldquo;declined\u0026rdquo;, and \u0026ldquo;varied\u0026rdquo; appropriately used. Some phrases and word choices are awkward or incorrect (\u0026ldquo;intent\u0026rdquo; should be \u0026ldquo;intend\u0026rdquo;, \u0026ldquo;Whatsmore\u0026rdquo; is unconventional). There is a limited range of vocabulary to describe statistical data, and some repetition of words like \u0026ldquo;morning\u0026rdquo; and \u0026ldquo;afternoon\u0026rdquo; could be replaced with synonyms to enhance lexical range.\nGrammatical Range and Accuracy: 5.5 The response includes a mix of complex and simple sentences. There are several grammatical errors (\u0026ldquo;68% of unemployed intent to do housework\u0026rdquo; should be \u0026ldquo;intend\u0026rdquo;, \u0026ldquo;separately within 6% and 3%\u0026rdquo; is unclear and should be rephrased for clarity). These mistakes hinder the clarity and accuracy of the response. Punctuation is generally handled well, but sentence structure issues detract from the overall grammatical quality.\nOverall Remarks: The response provides a basic analysis of the table\u0026rsquo;s data concerning unemployed peoples\u0026rsquo; time utilization in the UK, categorized by time of day and gender differences. Although it captures fundamental distinctions, it struggles with clarity in data presentation and accuracy in language use. The essay would benefit from fewer grammatical errors, a better range of vocabulary concerning data description, and improved logical sequencing of ideas for higher coherence. The overall grade reflects these areas of strength and needed improvements.\nOverall Grade: 6.0\nAIæ¶¦è‰² The table illustrates how unemployed individuals in the UK spent their time last year. Overall, people tend to engage in activities more frequently in the morning than in the afternoon, such as housework, shopping, and job hunting. Furthermore, there are gender differences in activity preferences.\nOn one hand, 68% of unemployed individuals prefer doing housework in the morning, a much higher percentage compared to the afternoon, which stands at only 28%. A similar pattern is observed for shopping, with a 20% decrease in the afternoon compared to 46% in the first half of the day. However, there is an exception as both men and women tend to watch TV more in the afternoon, with a 10% increase as the day progresses.\nOn the other hand, there are variations in activity choices between men and women. For instance, 49% of women spend time on housework, whereas only 19% of men are interested in this activity. In contrast, men show a greater interest in gardening compared to women, with 27% versus 5% spending time on this activity throughout the day. Additionally, there is little difference in gender when it comes to job hunting and leisure time, with only a 6% and 3% variance, respectively.\nåŠ¨æ€å›¾ The graph below gives information about the percentage of the population in four Asian countries living in cities from 1970 to 2020, with predictions for 2030 and 2040.\nSummarise the information by selecting and reporting the main features, and make comparisons where relevant.\nThe line graph shows the percentage of people who live in cities in four Asian nations between 1970 and 2020, and predicts the data in 2030 and 2040.\nOverall, population in all four countires have increased more or few comparing with 50 years ago and the growing trend will be continued until 20 years later at least.\nIn 1970s, urban citizens in Thailand and Indonesia are under one fifth of total number, while the data are little bit higher in Philippines and Malaysia, around 30%. After 50 years development, population in cities of Malaysia have reached over 80%, which is the highest among the four. As Indonesia, which is the least one, raised rapidly over years and surpassed Philippines and Thailand after 2010.\nWith the prediction, the proportion of urban citizens will continuously increase after 2020, and Malaysia will keep it leading position. The urban population of all four countries will exceed a half amount in 2040.\nEvaluation: Task Achievement: 6.5 The candidate provides a clear overview of the line graph, addressing the main trends in urban population growth across four Asian nations from 1970 to 2020, along with predictions for 2030 and 2040. However, while the response mentions key data points, it lacks specific numerical details that would enhance the analysis. The statement about Malaysia having the highest urban population is accurate, but the comparison with Indonesia, the Philippines, and Thailand could be more explicitly detailed. Overall, the response captures the essence of the task but could benefit from more precise data references and a clearer summary of trends.\nCoherence and Cohesion: 6.0 The structure of the response is generally logical, with a clear progression from past data to future predictions. However, the use of cohesive devices is somewhat limited, and transitions between ideas could be smoother. Phrases like \u0026ldquo;In 1970s\u0026rdquo; and \u0026ldquo;After 50 years development\u0026rdquo; could be better integrated into the flow of the text. The candidate uses paragraphs effectively, but clearer signposting would improve the overall coherence of the response.\nLexical Resource: 6.5 The vocabulary used is appropriate for the task, with terms like \u0026ldquo;urban citizens,\u0026rdquo; \u0026ldquo;population,\u0026rdquo; and \u0026ldquo;predictions\u0026rdquo; effectively conveying the intended meaning. However, there are instances of awkward phrasing, such as \u0026ldquo;under one fifth of total number\u0026rdquo; and \u0026ldquo;little bit higher,\u0026rdquo; which detract from the overall quality. The candidate demonstrates a reasonable range of vocabulary but could enhance their lexical resource by incorporating more varied expressions and avoiding repetition.\nGrammatical Range and Accuracy: 6.0 The response includes a mix of simple and complex sentences, demonstrating a fair range of grammatical structures. However, there are several grammatical errors, such as \u0026ldquo;the population in all four countries have increased more or few\u0026rdquo; (should be \u0026ldquo;more or less\u0026rdquo;) and \u0026ldquo;the data are little bit higher\u0026rdquo; (should be \u0026ldquo;a little bit higher\u0026rdquo;). These errors affect clarity and accuracy. Punctuation is generally correct, but some sentences could be restructured for better grammatical precision.\nOverall Remarks: The response effectively summarizes the trends in urban population growth in four Asian nations, providing a clear overview of the data presented in the line graph. While it captures the main points, the analysis would benefit from more specific numerical references, improved cohesion, and greater grammatical accuracy. The overall grade reflects these strengths and areas for improvement.\nOverall Grade: 6.0\nAIæ¶¦è‰² The line graph illustrates the percentage of urban residents in four Asian nations from 1970 to 2020, with projections for 2030 and 2040.\nOverall, the urban population has increased in all four countries compared to 50 years ago, and this upward trend is expected to continue for at least the next 20 years.\nIn the 1970s, the proportion of urban dwellers in Thailand and Indonesia was less than one-fifth of the total population, slightly higher in the Philippines and Malaysia at around 30%. Over the 50-year period, Malaysia\u0026rsquo;s urban population surged to over 80%, the highest among the four countries. Indonesia, initially the lowest, experienced rapid growth and surpassed the Philippines and Thailand after 2010.\nLooking ahead, the percentage of urban residents is projected to keep rising after 2020, with Malaysia maintaining its leading position. By 2040, the urban population in all four nations is anticipated to exceed half of the total population.\ntask 2 è§‚ç‚¹ï¼ˆäºŒé€‰ä¸€ï¼‰ The most important aim of science should be to improve people\u0026rsquo;s lives.\nTo what extent do you agree or disagree with this statement?\nThere is a statement claim that we should view improving people\u0026rsquo;s lives as the most important aim of science. I strongly agree with it for three aspects in economy, ethical problem and feasibility.\nFirst of all, enonomy influences both our lives and science. Over last a hundred year, human society evoluted rapidly with the assistance of science, which brings a numerous amount of fortunes to all people in the world. As the result, with the substaintial money created with high productivity, scientist have a better condition for research, which can be help them to make a further step in science.\nBesides, ethical issues should be took into consideration. Science is a double sword, if we can not estimate the influence, it will bring disaster to human. As we all know, the initial usage of bomb is for road creating through mountains. Unfortunately, it becomes a killer in war with the abuse using, brings millions of death and sorrow for family. So we must keep \u0026lsquo;improving human\u0026rsquo;s lives\u0026rsquo; as the main aim of science.\nSome people may think we should develop science as fast as we can no matter what. However, take the one under control and keep the aim on benefiting human is a more feasible way. We can gather strength and motivation effectively under a clear direction, just like driving on the express way.\nIn short, I believe the first and foremost aim of science is to benefit people. We should take science as an assistant for us rather than serving it. Science without people is nothing.\nEvaluation: Task Achievement: 6.5 The candidate strongly agrees with the statement regarding the importance of improving people\u0026rsquo;s lives as the primary goal of science. The response addresses the three aspects of economy, ethical issues, and feasibility to support this viewpoint. The candidate effectively presents a clear position and develops ideas coherently and logically. Relevant examples and evidence are provided to strengthen the argument. However, some parts of the response could be more refined to fully answer the question and avoid repetition. While the conclusion is effective, a more comprehensive analysis of the statement\u0026rsquo;s implications would enhance the score.\nCoherence and Cohesion: 6.5 The response is structured logically, with a clear introduction, body, and conclusion discussing the various aspects of the statement. Transition phrases like \u0026ldquo;First of all,\u0026rdquo; \u0026ldquo;Besides,\u0026rdquo; and \u0026ldquo;In short\u0026rdquo; help guide the reader through the argument. The paragraphs are well-organized, but some sentences could be more succinct for better cohesion. Maintaining the central theme and ensuring each paragraph has a clear topic sentence would strengthen coherence.\nLexical Resource: 6.0 The vocabulary used is generally appropriate, with terms like \u0026ldquo;fortunes,\u0026rdquo; \u0026ldquo;feasibility,\u0026rdquo; and \u0026ldquo;substantial money\u0026rdquo; effectively conveying the candidate\u0026rsquo;s ideas. However, there are instances of awkward phrasing (\u0026ldquo;evoluted rapidly\u0026rdquo;) and grammatical errors that impact the lexical quality. More precise and accurate vocabulary choices could enhance the overall lexical resource, along with increased variety and idiomatic expressions.\nGrammatical Range and Accuracy: 5.5 The response includes a mix of simple and complex sentence structures, demonstrating an attempt at grammatical variety. However, there are several grammatical errors throughout the response, such as \u0026ldquo;enonomy\u0026rdquo; (economy), \u0026ldquo;substaintial\u0026rdquo; (substantial), and \u0026ldquo;be took\u0026rdquo; (be taken), affecting clarity and accuracy. Punctuation use is adequate, but improvements in sentence structure and grammatical precision are needed for a higher score.\nOverall Remarks: The response effectively argues for considering the improvement of people\u0026rsquo;s lives as the central aim of science, with supporting points related to economy, ethics, and feasibility. While the response is well-structured and coherent, there are areas for improvement in the clarity and accuracy of language use, as well as grammatical precision. Enhancing vocabulary range and addressing grammatical errors would elevate the overall quality of the response.\nOverall Grade: 6.0\nAIæ¶¦è‰² There is a statement that we should view improving people\u0026rsquo;s lives as the most important aim of science. I strongly agree with this for three reasons: economic impact, ethical considerations, and feasibility.\nFirst of all, the economy significantly influences both our lives and the field of science. Over the last hundred years, human society has evolved rapidly with the assistance of scientific advancements, generating substantial wealth for people worldwide. As a result, with the substantial financial resources created through high productivity, scientists have better conditions for research, enabling them to make further advancements in their fields.\nFurthermore, ethical issues must be taken into consideration. Science is a double-edged sword; if we cannot assess its consequences, it can lead to disastrous outcomes for humanity. For instance, the original purpose of explosives was to facilitate road construction through mountains. Unfortunately, these same explosives have been weaponized in warfare, leading to millions of deaths and immense sorrow for countless families. Therefore, we must prioritize \u0026ldquo;improving human lives\u0026rdquo; as the primary aim of science.\nSome may argue that we should advance science as rapidly as possible, regardless of the consequences. However, maintaining control and focusing on benefiting humanity is a more feasible approach. With a clear direction, we can effectively harness our collective strength and motivation, much like driving on a well-maintained expressway.\nIn conclusion, I believe the foremost aim of science should be to benefit people. We should view science as an ally rather than something to be served. After all, science without humanity is meaningless.\n","permalink":"http://localhost:1313/posts/iltes/%E9%9B%85%E6%80%9D%E5%86%99%E4%BD%9C/","summary":"åˆç¨¿ã€aiè¯„åˆ†ã€aiæ¶¦è‰²","title":"é›…æ€å†™ä½œç»ƒä¹ è®°å½•"},{"content":"å¬åŠ› å¯¹è¯ä¸­çš„é€»è¾‘è¯\nç•™æ„butã€soã€anotherã€particularlyç­‰å¼ºè°ƒè¯ï¼Œåè¾¹çš„å¾ˆå¤§å¯èƒ½æ˜¯é‡ç‚¹ æŠ€å·§\nåŒä¹‰æ›¿æ¢ã€å‡ºç°åŸè¯å¯èƒ½æ˜¯é™·é˜± new xxx æ„å‘³ç€å¯èƒ½æœ‰old é€»è¾‘è¯ã€è¿æ¥è¯ æŒ‰é¢˜å·é¡ºåºç­”é¢˜ å¡«ç©ºé¢˜ æ³¨æ„å‡ ä¸ªwordï¼Œæœ‰æ²¡æœ‰number è‡³å°‘çœ‹ç©ºæ ¼å‰ä¸€ä¸ªè¯ï¼ŒçŒœè¯æ€§ çœ‹ç‰¹è‰²è¯ï¼ˆå¿½ç•¥é‡å¤å‡ºç°çš„è¯ï¼‰ã€ä¸“æœ‰åè¯ã€ä»‹è¯ã€æ•°å­—ç­‰æ–¹ä¾¿å®šä½ çœ‹æ®µè½ç¬¦å·ï¼Œç¡®å®šé€»è¾‘å…³ç³»ï¼ˆé€šè¿‡å¯¹è¯ä¸­è¿æ¥è¯è¿›è¡Œå®šä½ï¼‰ æ ‡é¢˜ã€å°æ ‡é¢˜ åœ°å›¾é¢˜ æ–¹ä½ å·²çŸ¥åœ°ç‚¹ï¼ˆå›¾ä¸­å’Œé¢˜ç›®ï¼‰ å¸¸è¯†æ€§æ ‡æ³¨ï¼ˆçœ‹ç”»ã€å°è®°å·ï¼‰ æ‰«ä¸€éå­—æ¯ é…å¯¹é¢˜ ç«–å‘æ¯”è¾ƒ é˜…è¯» å¦‚ä½•è¯»å¾—å¿«ï¼š\nå…³é”®è¯ ä¸è¦ä¸€ä¸ªä¸€ä¸ªè¯è¯»ï¼Œä¸€ä¸ªå—ä¸€èµ·çœ‹ è¯»ä¸æ‡‚çš„è¯»å¿«ï¼Œè¯»å¾—æ‡‚çš„è®¤çœŸè¯» é€»è¾‘è¯ï¼š\nè½¬æŠ˜ï¼šåè¾¹é‡ç‚¹ å¹¶åˆ—ï¼šå®šä½ å› æœ ä¸¾ä¾‹å­ï¼šå‰è¾¹è§‚ç‚¹ å¡«ç©ºé¢˜å®šä½æ–¹æ³•ï¼š\nåŒä¹‰æ›¿æ¢ å¹¶åˆ—å…³ç³» å› æœå…³ç³» è½¬æŠ˜å…³ç³» ä¸»è¢«åŠ¨æ”¹å†™ è¯æ€§ å† è¯ã€æ•°å­— ä»å¥ ä»‹ç»ä¸“æœ‰åè¯æ—¶ åˆ¤æ–­é¢˜å‡ ç§æƒ…å†µï¼š True:\nåŒä¹‰æ›¿æ¢ æ ¹æ®å‡ å¥è¯æ€»ç»“ False:\nåŒä¹‰æ›¿æ¢+æ„æ€ç›¸å Not Given\nå†…å®¹æœªæåŠï¼ˆç‰¹ä¾‹ï¼šé¢˜ç›®ä¸­æåˆ°mostã€moreä¹‹ç±»çš„æ¯”è¾ƒçº§ï¼Œä½†åŸæ–‡å¹¶æ²¡æœ‰ï¼Œä¹Ÿæ˜¯ï¼‰ æåˆ°å†…å®¹ï¼Œä½†å…¶é€»è¾‘å…³ç³»æœªæåŠ å¹³è¡Œé˜…è¯»æ³• é€‚ç”¨èŒƒå›´ï¼šåŒ¹é…é¢˜å’Œé¡ºåºé¢˜åŒæ—¶å‡ºç°æ—¶ï¼ˆä¸€èˆ¬passage2ï¼‰\nå®šä½å¡«ç©ºé¢˜å¼€å§‹ä½ç½®ï¼ˆæ‰¾å®šä½è¯ï¼Œæ‰¾ä¸åˆ°è¦è®°ä½ï¼‰ï¼Œé€šè¯»æ–‡ç« ï¼Œéšè¯»éšåšæ®µè½åŒ¹é…ï¼Œå‘ç°å¡«ç©ºé¢˜å°±åšå¹¶çœ‹ä¸‹ä¸€ä¸ªå¾…åšé¢˜ã€‚\nåˆ¤æ–­é¢˜å¯ä»¥çœ‹ä¸¤ä¸ªï¼Œé¿å…ng\nå†™ä½œ å°ä½œæ–‡ ä¸‰ç§ï¼šå›¾è¡¨ã€æµç¨‹å›¾ã€åœ°å›¾\nå›¾è¡¨ åŠ¨æ€å›¾ vs é™æ€å›¾\nä¾§é‡ç‚¹ï¼šåŠ¨æ€å›¾ä½“ç°è¶‹åŠ¿ï¼ˆchangeï¼‰ï¼Œé™æ€å›¾ä½“ç°å¯¹æ¯”ï¼ˆdifferenceï¼‰ æŒ‡ä»¤ï¼šsummarize the information by selecting and reporting the main features, and make comparisons where relevant.\né€‰æ‹© select æè¿° report æ¯”è¾ƒ compare æ€»ä½“æ€è·¯ é€šè¿‡ä½œæ¯”è¾ƒ**é€‰æ‹©å‡ºç›¸å¯¹åº”çš„æ•°æ®ï¼ŒåŸºäºæ­¤è¿›è¡Œæè¿°\nå“ªå‡ æ–¹é¢ä½œæ¯”è¾ƒï¼š æ•°å€¼ï¼šæœ€å¤§å€¼ æœ€å°å€¼ ç­‰å€¼ å·®å€¼ å€æ•° å¤§äº å°äº è¶‹åŠ¿ï¼šä¸Šå‡ ä¸‹é™ æ³¢åŠ¨ ç¨³å®š ï¼ˆåªå­˜åœ¨äºåŠ¨æ€å›¾ï¼‰ å¹…åº¦ï¼šå‰§çƒˆ å¹³ç¼“ ä½œæ–‡ç»“æ„ï¼šå››æ®µå¼ ç¬¬ä¸€æ®µï¼šæ”¹å†™é¢˜ç›®ä¸­çš„å›¾è¡¨æè¿°ï¼ˆ1-2å¥ï¼‰\næŸç§å›¾showsæŸç§æ•°æ®åœ¨æŸç§æ¡ä»¶ä¸‹\næ”¹å†™ä¸‰ç§æ–¹æ³•ï¼šæ¢è¯ã€æ¢ä½ç½®ã€æ¦‚æ‹¬\nbetween 19xx and 20xx ==\u0026gt; over a period of xx years ç¬¬äºŒæ®µï¼šå®è§‚æ¦‚è¿°ï¼ˆ2-3å¥ï¼‰\nçœ‹æ•´ä½“å½¢çŠ¶ï¼ŒåŠ¨æ€å›¾\u0026ndash;è¶‹åŠ¿ï¼Œé™æ€å›¾\u0026ndash;å·®å¼‚ ç¬¬ä¸‰æ®µï¼šç»†èŠ‚æè¿°ï¼ˆ4-5å¥ï¼‰\nç¬¬å››æ®µï¼šç»†èŠ‚æè¿°ï¼ˆ4-5å¥ï¼‰\nåˆ†ç»„æè¿°ï¼šæ—¶é—´ã€æ’åã€è‡ªèº«ç‰¹ç‚¹ã€æ¯”è¾ƒç»´åº¦ã€å›¾è¡¨æ•°é‡ ç»†èŠ‚æ®µå¼•å¯¼è¯ ä¸¤ç§ä¸åŒæ•°æ®ï¼šAs for x, Concerning X\nç›¸ä¼¼/ç›¸åï¼šsimilarly, likewise / by comparison, by contrast, on the other hand\nä¸¤å¼ å›¾è¡¨ï¼šas shown in the first/second chart\né€»è¾‘è¿æ¥è¯ å¹¶åˆ—ï¼šin addition, moreover, furthermore\nç±»æ¯”ï¼šsimilarly, likewise\nè½¬æŠ˜ã€å¯¹æ¯”ï¼šwhile, whereas, on the otherhand, by contrast, on the contrary, but, however\næè¿°æŠ€å·§ ä»xxxåˆ°xxxä¸€ç›´æ˜¯é€’å¢çš„\nå®Œæˆè¿›è¡Œæ—¶: have been doing till xxx (by now). ï¼ˆæ—¶æ€æ ¹æ®åˆ°xxxçš„æ—¶é—´ï¼‰ ä¸»è¾…ç»“åˆï¼Œä¸€å¥è¯æè¿°ä¸¤ä¸‰ä¸ªæ•°æ®è¦ç‚¹\nå†…å®¹ç»„åˆï¼š å‰åç»“åˆï¼ˆä¸¤æ®µè¶‹åŠ¿ï¼‰ã€æ–‡ç†ç»“åˆï¼ˆå¯¹æ•°æ®çš„æ¦‚æ‹¬ï¼Œé¿å…ä¸»è§‚ï¼‰ã€åŠ¨é™ç»“åˆï¼ˆæ•°æ®+è¶‹åŠ¿ï¼‰ã€å®å¾®ç»“åˆï¼ˆå¾®è§‚æè¿°å®è§‚æ¯”è¾ƒï¼‰\næµç¨‹å›¾ æŒ‰æ­¥éª¤æè¿°\nä¸»è¦åˆ†ç±»ï¼šå·¥åºæµç¨‹å›¾ã€ç”Ÿç‰©ç”Ÿé•¿è¿‡ç¨‹å›¾\nè¯­æ€ï¼š\nå·¥åºï¼šè¢«åŠ¨è¯­æ€ï¼Œä¸€èˆ¬ç°åœ¨æ—¶ ç”Ÿé•¿ï¼šä¸»åŠ¨è¯­æ€ï¼Œä¸€èˆ¬ç°åœ¨æ—¶ ä½œæ–‡ç»“æ„ï¼šå››æ®µå¼ ç¬¬ä¸€æ®µï¼šæ”¹å†™é¢˜ç›®ä¸­çš„å›¾è¡¨æè¿°ï¼ˆ1-2å¥ï¼‰\nç¬¬äºŒæ®µï¼šå‰ä¸€åŠæµç¨‹æè¿°ï¼ˆ5-6å¥ï¼‰\nç¬¬ä¸‰æ®µï¼šåä¸€åŠæµç¨‹æè¿°ï¼ˆ5-6å¥ï¼‰\nç¬¬å››æ®µï¼šæ¦‚è¿°ï¼ˆ1-2å¥ï¼‰\næ¦‚æ‹¬æµç¨‹çš„æ­¥éª¤æ•°é‡å’Œæ¦‚å†µ æè¿°æŠ€å·§ å›¾å½¢æ•´ä½“+ç»†èŠ‚\nè¡¥å……æ–‡å­—+æ•°å­—\nä¸»è¾…ç»“åˆï¼šfirst å¯¹Açš„æè¿°, followed immediately by å¯¹æ­¥éª¤Bçš„æè¿°\né€»è¾‘è¿æ¥è¯ initially, the following stage, enterting the final phase\nåœ°å›¾ ä¸»è¦åˆ†ç±»ï¼šé€‰å€ã€å˜åŒ–\nå…³é”®è¯ ç»å¯¹ä½ç½®ï¼ˆä¸œå—è¥¿åŒ—ï¼‰east west south north ç›¸å¯¹ä½ç½®ï¼ˆä¸´è¿‘ã€å¯¹ä¾§ã€ç¯ç»•ï¼‰adjacent,opposite,surround åŒºåŸŸçš„å½¢çŠ¶ï¼ˆé•¿æ–¹å½¢ã€ä¸‰è§’å½¢ã€Lå‹ï¼‰rectangle,triangle,L-shaped é“è·¯çš„å½¢æ€ï¼ˆç›´æ¥è½¬å¼¯ã€èœ¿èœ’æ›²æŠ˜ï¼‰direct sharp turn, winding ä½¿ç”¨çŠ¶æ€ï¼ˆä½¿ç”¨ä¸­ã€åºŸå¼ƒï¼‰in use, abandoned æ¤è¢«ï¼ˆè¦†ç›–ã€ç©ºç©ºå¦‚ä¹Ÿï¼‰covered, barren è®¾æ–½å»ºè®¾ï¼ˆå»ºç«‹ã€æ‹†é™¤ï¼‰establish, demolish å»ºç­‘æ”¹é€ ï¼ˆæ‰©å»ºã€ç¼©å°ã€ç§»ä½ï¼‰expand,reduce,relocate å˜åŒ–ç±»åœ°å›¾ä½œæ–‡ç»“æ„ ç¬¬ä¸€æ®µï¼šæ”¹å†™é¢˜ç›®ä¸­çš„å›¾è¡¨æè¿°ï¼ˆ1-2å¥ï¼‰\nç¬¬äºŒæ®µï¼šå˜åŒ–å‰\nç¬¬ä¸‰æ®µï¼šå˜åŒ–å\næŒ‰ç…§å›¾ä¸­ä¸°å¯Œç¨‹åº¦ç¡®å®šäºŒä¸‰æ®µå¥æ•° å°ºåº¦æè¿° éµå¾ªä¸€å®šé¡ºåºæè¿°ï¼ˆex.ä»å…¥å£ç”±è¥¿å‘ä¸œï¼‰ ç¬¬å››æ®µï¼šæ€»ç»“ï¼ˆ1-2å¥ï¼‰\næ¦‚æ‹¬æµç¨‹çš„æ­¥éª¤æ•°é‡å’Œæ¦‚å†µ å¤§ä½œæ–‡ è¯„åˆ† è§‚ç‚¹ã€é€»è¾‘ã€ç”¨è¯ã€è¯­æ³•\nåˆ†ç±» è§‚ç‚¹å‹ï¼ˆ1-4ï¼‰ã€åˆ†æå‹ï¼ˆ5ï¼‰ã€æ··æ­å‹ï¼ˆ6ï¼‰\nDoÂ youÂ thinkÂ thisÂ isÂ aÂ positiveÂ orÂ negativeÂ development?Â è®¤ä¸ºè¯é¢˜ä¸­çš„ç¤¾ä¼šç°è±¡æ˜¯ä¸€ä¸ªå¥½çš„å‘å±•è¶‹åŠ¿è¿˜æ˜¯åçš„å‘å±•è¶‹åŠ¿ï¼Ÿ\nToÂ whatÂ extentÂ doÂ youÂ agreeÂ orÂ disagree? ä½ åœ¨å¤šå¤§ç¨‹åº¦ä¸ŠåŒæ„ã€ä¸åŒæ„è¯é¢˜ä¸­çš„è§‚ç‚¹ï¼Ÿ\nSomeÂ peopleÂ think..Â otherÂ peopleÂ think\u0026hellip; DiscussÂ bothÂ viewÂ andÂ giveÂ yourÂ ownÂ opinion. è®¨è®ºè¯é¢˜ä¸­çš„ä¸¤ä¸ªè§‚ç‚¹ï¼Œå¹¶ç»™å‡ºè‡ªå·±çš„è§‚ç‚¹\nDoÂ youÂ thinkÂ theÂ advantagesÂ ofÂ thisÂ trendÂ outweighÂ theÂ disadvantages? ä½ è®¤ä¸ºè¯é¢˜ä¸­çš„ç¤¾ä¼šç°è±¡çš„ä¼˜ç‚¹æ˜¯å¦è¶…è¿‡æˆ–å¤§äºä»–çš„ç¼ºç‚¹ï¼Ÿ\nWhy What How WhyÂ hasÂ thisÂ happened?\nWhatÂ canÂ beÂ doneÂ toÂ dealÂ withÂ this?\né’ˆå¯¹è¿™ç§ç¤¾ä¼šç°è±¡ï¼Œä»–çš„åŸå› \\ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿä»–çš„è§£å†³æ–¹æ¡ˆåˆæ˜¯ä»€ä¹ˆ?\nWhatÂ areÂ theÂ reasonsÂ andÂ consequencesÂ ofÂ thisÂ trend?\nè¿™ç§ç¤¾ä¼šç°è±¡çš„åŸå› å’Œå½±å“åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼ŸÂ æ··æ­ why what how + your view æ—¶é—´åˆ†é… 10 min æ„æ€\n5 + 10 + 5 min å†™ä½œ\nå¦‚ä½•æ„æ€ brainstorm å†™ä¸‹èƒ½æƒ³åˆ°çš„ä»»ä½•è§‚ç‚¹ develop ideas in detail keep asking \u0026lsquo;why\u0026rsquo;? æƒ³èƒ½å¤Ÿæ”¯æ’‘è§‚ç‚¹çš„ä¾‹å­ å½’çº³åˆ†ç»„è§‚ç‚¹ï¼ˆç¼–å·ï¼‰ è§‚ç‚¹å‹é¢˜ç›®ï¼ˆDiscussÂ bothÂ viewï¼‰è¡Œæ–‡ç»“æ„ (å››æ®µå¼) Introduction è½¬è¿°é¢˜ç›® + è§‚ç‚¹ People have different views about (opinion 1,2). While (op 1) can sometime xxx, I believe that (op 2) is more xxx. One view On the one hand, ä¸‹è¾¹å•æ–¹è§‚ç‚¹çš„è®ºç†+è®ºè¯ other view (my view) On the other hand, è®ºç†+è®ºè¯, This is the attitude that I believe (op 2). Instead of (op 1), xxxx. é©³æ–¥op1 Conclusion ä¸€ä¸¤å¥è¯æ€»ç»“ In conclusion, I can understand (op1), but it seems to me that (op2) is much more xxx. è§‚ç‚¹å‹é¢˜ç›®ï¼ˆå•æ–¹è§‚ç‚¹ï¼‰è¡Œæ–‡ç»“æ„ (äº”æ®µå¼) the beginning å¼€å¤´ hook + transition + points hook é¢„åŸ‹ä¸€äº›åæ–¹è§‚ç‚¹(appears xxx, simply due to xxx) It is hard to deny that (opposite detail) and such a fact leads impressionable people to generate the opinion that (opposite response) However, such a statement suffers from both logical and factual fallacies, and it should be examined meticulously. As far as (Point 1) (Point 2) and (Point 3) are concerned, I strongly hold that (our response). point1 + reasoning è®ºç†è®ºè¿° ä»é«˜åˆ°ä½ã€å±‚å±‚é€’è¿›ï¼ˆé‡‘å­—å¡”ï¼‰high - mid - detail coherent adequate consistent (è¿è´¯ã€å……å®ã€åˆ‡é¢˜) why? how? what? å¦‚ä½•å†™factï¼šfollow and/or fight è¿›ä¸€æ­¥è§£é‡Šæˆ–é©³æ–¥åæ–¹è§‚ç‚¹æˆ–ç»“åˆä½¿ç”¨ optional fillerï¼ˆå‡‘å­—æ•°ç”¨çš„ï¼‰ï¼šæ€»ç»“ã€å‡è®¾ã€å°ä¾‹å­ ä¸è¦listingï¼ First and foremost (point 1) as (fact 1-1) For instance / to illustrate / to be more specific, (fact 1-2); In addition / not to mentione that / furthermore, (fact 1-3) (optional filler) point2 + exemplification ä¸¾ä¾‹è®ºè¯ ä¾‹å­è¦æœ‰æ™®é€‚æ€§ï¼ˆä¸ªä½“blabla Ã— ç¾¤ä½“ä¸­çš„ä¸ªä½“blabla âˆšï¼‰ Furthermore, the fact that (point 2 mid level) indicates that (our response) Take the case of (character), who / which (process). As a result, (result). Had it not been for (process paraphrase), (character) would never (result paraphrase). point3 + concession é©³æ–¥åæ–¹è§‚ç‚¹ Nevertheless, a voice arises that (opposite response and point in grand opening). Ironically, (fact(s) against opposite detail). Therefore, (point3) the end ç»“å°¾ æ€»ç»“ï¼Œå¯ä»¥ä¸quote In a nutshell, I maintain that (response). Admittedly, as my favorite quote from (A famous person) goes, (person says \u0026#34;people have different opinions\u0026#34;), and some people may oppose me. However, I believe they will compromise after being exposed to my article. planning æ‰¾æ ¸å¿ƒè§‚ç‚¹ -\u0026gt; ç¡®å®šæ­£åä¸¤è§‚ç‚¹ -\u0026gt; ç¡®å®šç«‹åœº -\u0026gt; æå‡ºä¸‰ä¸ªè®ºç‚¹ä»¥åŠä¸€ä¸ªåæ–¹è®ºç‚¹\ntipsï¼š\né€‰ä¸€ä¸ªå¥½è¯´çš„ç«‹åœº ä¸è¦æ‹˜æ³¥äºç»†èŠ‚ åˆ†æå‹é¢˜ç›®ï¼ˆä¸¤é—®ï¼‰è¡Œæ–‡ç»“æ„ï¼ˆå››æ®µå¼ï¼‰ Introduction è½¬è¿°é¢˜ç›®+æ‰¿è®¤é—®é¢˜ It is true that xxx. There are a variety of possible reasons for this, but steps can definitely be taken to tackle the problem. Q1 topic sentence + è®ºç†è®ºè¯ In my opinion, xxx. Firstly, Secondly, Finally... Q2 topic sentence + è®ºç†è®ºè¯ (åšå‡ºå›ç­”). Start with, Also, At the same time. Conclusion å›ç­”é—®é¢˜å’Œå½’çº³æ­¥éª¤ å¥½è¯å¥½å¥ form a virtuous cycle in xxx lift people out of poverty å£è¯­ è¯„åˆ†æ ‡å‡†ï¼šæµåˆ©ã€é€»è¾‘è¿è´¯ã€å‘éŸ³ã€è¯æ±‡è¯­æ³•å‡†ç¡®æ€§\n","permalink":"http://localhost:1313/posts/iltes/%E9%9B%85%E6%80%9D%E6%8A%80%E5%B7%A7/","summary":"ç½‘è¯¾ç¬”è®°æ€»ç»“","title":"é›…æ€å¬è¯´è¯»å†™æŠ€å·§"},{"content":"pythonå…¥é—¨ åŠ¨æ€è¯­è¨€ åœ¨è¿è¡Œæ—¶ç¡®å®šå˜é‡ç±»å‹\nä¼˜åŠ¿ï¼šçµæ´»ã€ç®€æ´ã€æ›´å¿«çš„å¼€å‘å‘¨æœŸ åŠ£åŠ¿ï¼šç¼ºä¹ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥å®¹æ˜“å‡ºé”™ ç‰¹æ€§ åŠ¨æ€æ·»åŠ å±æ€§å’Œæ–¹æ³•ã€åŠ¨æ€ç±»å‹ç»‘å®šã€åå°„å’Œå…ƒç¼–ç¨‹\nåº•å±‚å®ç° æœ‰ä¸€ä¸ªåŸºç±»æ‰¿æ¥æ‰€æœ‰å¯¹è±¡ï¼Œä»è€Œå®ç°åŠ¨æ€ç±»å‹\næ•°æ®ç±»å‹ åŸºæœ¬ç±»å‹ å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€å¸ƒå°”å€¼(True, False)ã€ç©ºå€¼(None)\nä¸€äº›è¿ç®—ç¬¦ï¼š\n// ä¸ / ï¼šå‰è€…ä¿ç•™å•†çš„æ•´æ•°éƒ¨åˆ†ï¼Œåè€…æ˜¯floatç±»å‹çš„å•† é€»è¾‘è¿ç®—ç¬¦ï¼šand or not List å£°æ˜æ–¹å¼ï¼šlist = [1, '2', xxx]\nç”Ÿæˆå¼å£°æ˜ï¼šlist = [expr for iter_var in iterable if cond_expr]\nListä¸­å¯ä»¥å­˜å„ç§ç±»å‹çš„å…ƒç´ \nç›¸å…³æ“ä½œ Listæˆªå–ä¸goä¸­åˆ‡ç‰‡è¯­æ³•ç±»ä¼¼ [:]\nè¿½åŠ .append\næŒ‡å®šä½ç½®æ’å…¥.insert\nè¿½åŠ å¦ä¸€ä¸ªlist.extend æˆ– list1 + list2\nä¸‰ç§ç§»é™¤æ–¹å¼ .popã€.removeã€del list[idx]\næ˜¯å¦åŒ…å« x in list\nTuple å£°æ˜æ–¹å¼ï¼š tuple = (1, '2', xxx) å•å…ƒç´ å£°æ˜ï¼š tuple = (1,)\nå•å…ƒç´ å£°æ˜è¦å¸¦é€—å·ï¼Œå¦åˆ™ä¼šè¢«è®¤ä¸ºæ˜¯è¯¥å•å…ƒç´ çš„æ•°æ®ç±»å‹\nä¸Listä¸åŒçš„æ˜¯Tupleæ˜¯ä¸å¯å˜çš„ï¼Œä½†ä¹Ÿä¸æ˜¯å®Œå…¨ä¸å¯å˜ï¼š\nä¸å¯å˜æŒ‡ï¼šTupleçš„æ¯ä¸ªå…ƒç´ ï¼ŒæŒ‡å‘æ°¸è¿œä¸å˜ã€‚ä½†æ˜¯å¯ä»¥æ”¹å˜Tupleä¸­å…ƒç´ çš„å…ƒç´ ï¼ˆä¾‹å¦‚å…ƒç´ Listä¸­å†è¿½åŠ ã€æ”¹å˜å…ƒç´ çš„å±æ€§ç­‰ï¼‰\nå…¶ä»–ç›¸å…³æ“ä½œé™¤äº†æ²¡æœ‰ä¿®æ”¹ä¹‹å¤–ä¸Listç›¸åŒ\nDict å£°æ˜æ–¹å¼ï¼š dict = {1 : xx, 'yy' : 2}\nkeyå¿…é¡»æ˜¯ä¸å¯å˜çš„ï¼šæ•°å­—ï¼Œå­—ç¬¦ä¸²æˆ–å…ƒç»„\nç›¸å…³æ“ä½œ .clear æ¸…ç©º\n.items ä»¥åˆ—è¡¨è¿”å›å¯éå†çš„(é”®, å€¼) å…ƒç»„æ•°ç»„\nSet å£°æ˜æ–¹å¼ï¼š s = set([1, '2', xxx]) ä½¿ç”¨Listä½œä¸ºè¾“å…¥\nç›¸å…³æ“ä½œ æ·»åŠ  .add\nç§»é™¤ä¸€ä¸ªå…ƒç´  .remove\nå¹¶é›† | äº¤é›† \u0026amp; å·®é›† -\nå‡½æ•°å‚æ•° é»˜è®¤å‚æ•° def print_user_info( name , age , sex = \u0026#39;ç”·\u0026#39; ): é»˜è®¤å‚æ•°åªèƒ½æ”¾åœ¨æœ«å°¾ é»˜è®¤å‚æ•°åªèƒ½æ˜¯ä¸å¯å˜å¯¹è±¡ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ã€å…ƒç»„ã€å¸ƒå°”ã€Noneï¼‰ å¦‚æœç”¨å¯å˜å¯¹è±¡åšé»˜è®¤å‚æ•°ï¼Œä¼šå‡ºç°é»˜è®¤å€¼è¢«æ”¹å˜\nå…³é”®å­—å‚æ•° print_user_info(name=\u0026#39;ç”œå‘³æ¢¨\u0026#39;, sex=\u0026#39;å¥³\u0026#39;, age=18) åœ¨è°ƒç”¨æ—¶æŒ‡å®šå‚æ•°å…³é”®å­—è¿›è¡Œèµ‹å€¼\nå¦‚æœæƒ³è¦å¯¹äºæŸäº›å½¢å‚å¼ºåˆ¶æŒ‡å®šéœ€è¦ä½¿ç”¨å…³é”®å­—å‚æ•°ï¼Œå¯ä»¥åœ¨å®šä¹‰æ—¶é€šè¿‡ * åˆ†éš”å½¢å‚ï¼Œ*åçš„å½¢å‚ä¸ºéœ€è¦æŒ‡å®šå…³é”®å­—çš„\ndef print_user_info(name, *, age, sex=\u0026#39;ç”·\u0026#39;): ä¸å®šé•¿å‚æ•°ï¼ˆä½ç½®å‚æ•°ï¼‰ é€šè¿‡åœ¨å½¢å‚å‰åŠ  * æ¥å£°æ˜ä¸å®šé•¿å‚æ•°ï¼Œå®é™…ä¸Šæ˜¯ç”¨ä¸€ä¸ªå…ƒç»„æ¥æ”¶ å¦‚æœæƒ³è¦åœ¨è°ƒç”¨æ—¶ä¹Ÿèƒ½ä½¿ç”¨å…³é”®å­—å‚æ•°ï¼Œéœ€è¦åœ¨å½¢å‚å‰åŠ  **ï¼Œè¿™æ ·ä¼šå°†æ¥æ”¶åˆ°çš„å‚æ•°å­˜æ”¾åˆ°å­—å…¸ä¸­ ä¾‹å­ï¼š\ndef print_user_info(name, age, *args, sex=\u0026#39;ç”·\u0026#39;, **kwargs): print(\u0026#39;æ˜µç§°ï¼š{}\u0026#39;.format(name) , end = \u0026#39; \u0026#39;) print(\u0026#39;å¹´é¾„ï¼š{}\u0026#39;.format(age) , end = \u0026#39; \u0026#39;) print(\u0026#39;æ€§åˆ«ï¼š{}\u0026#39;.format(sex) ,end = \u0026#39; \u0026#39; ) print(\u0026#39;args:{}\u0026#39;.format(args),end = \u0026#39; \u0026#39;) print(\u0026#39;kwargs:{}\u0026#39;.format(kwargs)) if __name__ == \u0026#39;__main__\u0026#39; : print_user_info(\u0026#39;ç”œå‘³æ¢¨\u0026#39;, 18, \u0026#39;arg1\u0026#39;, \u0026#39;arg2\u0026#39;, hobby=(\u0026#39;æ‰“ç¯®çƒ\u0026#39;,\u0026#39;æ‰“ç¾½æ¯›çƒ\u0026#39;,\u0026#39;è·‘æ­¥\u0026#39;), height=179) # output: # æ˜µç§°ï¼šç”œå‘³æ¢¨ å¹´é¾„ï¼š18 æ€§åˆ«ï¼šç”· args:(\u0026#39;arg1\u0026#39;, \u0026#39;arg2\u0026#39;) kwargs:{\u0026#39;hobby\u0026#39;: (\u0026#39;æ‰“ç¯®çƒ\u0026#39;, \u0026#39;æ‰“ç¾½æ¯›çƒ\u0026#39;, \u0026#39;è·‘æ­¥\u0026#39;), \u0026#39;height\u0026#39;: 179} lambda å‡½æ•° lambda [arg1 [,arg2,.....argn]]:expression lambdaå‡½æ•°æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼è€Œéä»£ç å—ï¼Œæ‰€ä»¥æ‹¥æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œä¸”ä¸èƒ½è®¿é—®è‡ªæœ‰å‚æ•°åˆ—è¡¨ä¹‹å¤–æˆ–å…¨å±€å‘½åç©ºé—´é‡Œçš„å‚æ•°ã€‚ æ¢å¥è¯è¯´ï¼Œlambdaç”¨åˆ°çš„å‚æ•°åªèƒ½é€šè¿‡å½¢å‚ä¼ å…¥ï¼Œä¸èƒ½ç”¨å¤–éƒ¨çš„å˜é‡ï¼Œå¦åˆ™ä¼šå‡ºé”™ã€‚\nå‘ï¼š\nif __name__ == \u0026#39;__main__\u0026#39; : num2 = 100 sum1 = lambda num1 : num1 + num2 num2 = 10000 sum2 = lambda num1 : num1 + num2 num2 = 1 print(sum1(1)) print(sum2(1)) # output: 2 2 åŸå› ï¼šnum2å˜é‡åœ¨è¿è¡Œæ—¶ç»‘å®šå€¼ï¼Œè€Œä¸æ˜¯å®šä¹‰æ—¶å°±ç»‘å®š\nè¿­ä»£å™¨å’Œç”Ÿæˆå™¨ è¿­ä»£å™¨ ä½¿ç”¨ iter() ç”Ÿæˆä¸€ä¸ªè¿­ä»£å™¨ï¼Œé€šè¿‡ next() å–ä¸‹ä¸€ä¸ªå€¼ï¼Œæˆ–è€…åœ¨forå¾ªç¯ä¸­ä½¿ç”¨ in ä¾æ¬¡å–å€¼ã€‚\nåªæœ‰å®ç°äº† __iter__ æ–¹æ³•çš„å¯¹è±¡æ‰èƒ½ä½¿ç”¨ç”Ÿæˆå™¨ï¼Œå¦åˆ™éœ€è¦è‡ªå·±å†™ã€‚\nåå‘è¿­ä»£éœ€è¦å®ç° __reversed__ æ–¹æ³•ã€‚\nç”Ÿæˆå™¨ åœ¨å‡½æ•°å£°æ˜ä¸­ä½¿ç”¨ yield è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡è€Œä¸æ˜¯åƒreturnä¸€æ ·è¿”å›ç»“æœã€‚\nyieldè¿”å›åå½“å‰çš„è¿™ä¸ªç”Ÿæˆå™¨å‡½æ•°ä¼šè®°å½•å½“å‰çŠ¶æ€ï¼Œåœ¨ä¸‹æ¬¡è°ƒç”¨æ—¶ä»æš‚åœå¤„ç»§ç»­ã€‚\nä¼˜åŠ¿ï¼šæƒ°æ€§æ±‚å€¼çš„ç‰¹ç‚¹å¯ä»¥èŠ‚çº¦å†…å­˜ï¼Œé€‚åˆå¤„ç†å¤§å‹æ•°æ®é›†æˆ–åˆ›å»ºå¤æ‚çš„æ•°æ®æµã€‚\né¢å‘å¯¹è±¡ å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³• ç±»ä¸­å‡½æ•°ä¸ŠåŠ  @classmethod æ³¨è§£è¡¨ç¤ºè¿™ä¸ªæ–¹æ³•æ˜¯ç±»æ–¹æ³•ï¼Œç»‘å®šåœ¨ç±»ä¸Šï¼Œè°ƒç”¨æ—¶ä¸éœ€è¦å®ä¾‹åŒ–ç›´æ¥ç±»å.æ–¹æ³•è°ƒç”¨ã€‚\nå®ä¾‹å±æ€§å’Œç±»å±æ€§ å®ä¾‹å±æ€§åœ¨ __init__ å‡½æ•°ä¸­å£°æ˜ï¼Œç±»å±æ€§åœ¨ç±»ä¸­å£°æ˜ã€‚\nps: ä¸€ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªæ„é€ å™¨ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ç±»æ–¹æ³•å˜ç›¸å®ç°å¤šä¸ªæ„é€ å™¨ã€‚\nè®¿é—®æ§åˆ¶ åœ¨å±æ€§æˆ–æ–¹æ³•å‰åŠ ä¸¤ä¸ªä¸‹åˆ’çº¿ __ ï¼Œè¡¨æ˜ç§æœ‰æ€§ï¼Œä¸èƒ½åœ¨ç±»å¤–è®¿é—®ä¸”ä¸èƒ½è¢«ç»§æ‰¿ã€‚\nç§æœ‰æ€§å®ç°çš„åŸç†æ˜¯é€šè¿‡åç§°æ”¹å†™ï¼Œå¦‚ __var1 ç§æœ‰å±æ€§ä¼šè¢«æ”¹å†™ä¸º _ç±»åç§°__var1ï¼Œå› æ­¤æŒ‰ç…§å®šä¹‰çš„åç§°è®¿é—®ä¸åˆ°ï¼Œ ä½†æ˜¯é€šè¿‡æ”¹å†™åçš„åç§°æ˜¯å¯ä»¥è®¿é—®çš„ã€‚æ‰€ä»¥æ‰€è°“â€œç§æœ‰â€åªæ˜¯æ–¹ä¾¿å¼€å‘æ‰€åšçš„ä¼˜åŒ–ï¼Œå¹¶ä¸æ˜¯çœŸçš„ç§æœ‰ã€‚ åŠ¨æ€ä¿®æ”¹ åŸºäºpythonåŠ¨æ€è¯­è¨€çš„ç‰¹æ€§ï¼Œåœ¨ç±»å¤–å¯ä»¥é€šè¿‡å£°æ˜ä¸€ä¸ªæ–°æ–¹æ³•å¹¶ className.oldMethod = newMethod å¯¹æ—§æ–¹æ³•è¿›è¡Œé‡å†™ï¼Œä¿®æ”¹ä¼šåº”ç”¨åˆ°æ‰€æœ‰å·²ç»åˆ›å»ºçš„å®ä¾‹ä¸­ã€‚\nåŒç†å¯¹äºç±»å±æ€§çš„ä¿®æ”¹å’Œå¢æ·»ä¹Ÿå¯ä»¥åœ¨ç±»å¤–åŠ¨æ€ä¿®æ”¹ã€‚\nå®ä¾‹å±æ€§å¯ä»¥åŠ¨æ€å¢æ·»ä¿®æ”¹ï¼Œä½†ä¸èƒ½å¯¹å®ä¾‹æ–¹æ³•è¿›è¡Œé‡å†™ã€‚\næ¨¡å—ä¸åŒ… å¯¼å…¥ import moduleName ç›´æ¥å¯¼å…¥æ¨¡å—ï¼Œè°ƒç”¨æ—¶ moduleName.xxx\nfrom moduleName import xxx ä¼šå°†è¯¥æ¨¡å—ä¸­çš„æŒ‡å®šç±»æˆ–æ–¹æ³•æˆ–å±æ€§å¯¼å…¥å½“å‰æ¨¡å—ï¼Œè°ƒç”¨æ—¶å°±ä¸ç”¨åŠ  moduleName è€Œæ˜¯ç›´æ¥ä½¿ç”¨å¯¼å…¥æ¨¡å—ä¸­çš„å‘½åã€‚\nä¸»æ¨¡å— å¦‚æœè¿™ä¸ªæ¨¡å—æ²¡æœ‰è¢«å¼•ç”¨è¿‡ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸»æ¨¡å—ï¼Œå¦åˆ™ä¸ºéä¸»æ¨¡å—ã€‚æœ‰ä¸€ä¸ªç³»ç»Ÿå˜é‡__name__å°±æ˜¯ç”¨æ¥è®°å½•æ¨¡å—å±æ€§çš„ã€‚\nåŒ… ä¸ºäº†é¿å…æ¨¡å—åå†²çªï¼Œpythonåˆå¼•å…¥äº†æŒ‰ç›®å½•æ¥ç»„ç»‡æ¨¡å—çš„æ–¹æ³•ï¼Œç§°ä¸ºåŒ…ï¼ˆPackageï¼‰ã€‚\nå¯¹äºæ‹¥æœ‰ __init__.py æ–‡ä»¶çš„ç›®å½•ï¼Œpythonä¼šå°†å…¶è§†ä¸ºä¸€ä¸ªåŒ…ã€‚\né—­åŒ… é—­åŒ…æ˜¯ä¸€ä¸ªå‡½æ•°å€¼ï¼Œå®ƒå¼•ç”¨äº†å…¶å‡½æ•°ä½“ä¹‹å¤–çš„å˜é‡ã€‚é€šè¿‡æŸç§æ•°æ®ç»“æ„å­˜å‚¨ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªå…³è”çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå®ç°é—­åŒ…çš„ç‰¹æ€§ã€‚\nä¾‹å­ï¼š\ntime = 0 def study_time(time): def insert_time(min): nonlocal time time = time + min return time return insert_time f = study_time(time) print(f(2)) # 2 print(time) # 0 print(f(10)) # 12 print(time) # 0 pythonä¸­åœ¨å‡½æ•°çš„__closure__å±æ€§ä¸­ä¿å­˜ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä»è€Œä½¿å¾—æ¯ä¸ªé—­åŒ…éƒ½èƒ½æ‹¥æœ‰ç‹¬ç«‹çš„å‡½æ•°å¤–éƒ¨å˜é‡ã€‚\nps:\nnonlocal åœ¨å‡½æ•°å†…éƒ¨å£°æ˜ä¸€ä¸ªå¤–éƒ¨å‡½æ•°çš„å˜é‡ global åœ¨å‡½æ•°å†…éƒ¨å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡ è£…é¥°å™¨ è£…é¥°å™¨åˆ©ç”¨é—­åŒ…çš„ç‰¹æ€§å®ç°\nä½œç”¨ï¼šä¸ä¿®æ”¹åŸæœ‰å‡½æ•°ä»£ç çš„åŸºç¡€ä¸Šï¼ŒåŠ¨æ€åœ°å¢åŠ æˆ–ä¿®æ”¹å‡½æ•°çš„åŠŸèƒ½ã€‚è§£è€¦é€šç”¨çš„åŠŸèƒ½ã€‚\ndef my_decorator(func): def wrapper(*args, **kwargs): print(\u0026#34;Something is happening before the function is called.\u0026#34;) result = func(*args, **kwargs) print(\u0026#34;Something is happening after the function is called.\u0026#34;) return result return wrapper @my_decorator def say_hello(name): print(f\u0026#34;Hello, {name}!\u0026#34;) say_hello(\u0026#34;Alice\u0026#34;) # output: # Something is happening before the function is called. # Hello, Alice! # Something is happening after the function is called. ","permalink":"http://localhost:1313/posts/python/python/","summary":"pythonåŸºç¡€è¯­æ³•ï¼ŒåŒ…æ‹¬æ•°æ®ç±»å‹ã€å‡½æ•°ã€ç±»ç­‰","title":"pythonå…¥é—¨"},{"content":"Postgres æ‰¹é‡åˆ é™¤è¯­å¥è¶…æ—¶ åœºæ™¯ æ’­æ”¾è®°å½•è¡¨historyä¸­å¤§çº¦æœ‰å°†è¿‘10äº¿æ¡æ•°æ®ï¼Œä¸ºäº†å‡å°‘å†…å­˜å ç”¨ï¼Œåå°ä»»åŠ¡ä»¥æ¯ç§’ä¸€æ¬¡çš„é€Ÿåº¦åˆ é™¤è¶…è¿‡1å¹´æœªæ›´æ–°çš„æ—§è®°å½•ã€‚\nè¡¨ç»“æ„ï¼ˆç¤ºæ„ç»“æ„ï¼‰ Table \u0026#34;public.history\u0026#34; Column | Type | Collation | Nullable | Default --------+--------+-----------+----------+--------- uid | text | | not null | vid | text | | not null | ts | bigint | | not null | Indexes: \u0026#34;history_pkey\u0026#34; PRIMARY KEY, btree (uid, vid) \u0026#34;history_ts\u0026#34; btree (ts) åˆ é™¤è¯­å¥ delete from history where (uid, vid) in (select uid, vid from history where ts \u0026lt;= $1 limit 500) é—®é¢˜å‡ºç° ä»»åŠ¡ç¨³å®šè¿è¡Œäº†ä¸€å¹´å¤šçš„æ—¶é—´ï¼Œçªç„¶æœ‰ä¸€å¤©çº¿ä¸Šæ—¥å¿—å‡ºç°äº†å¤§é‡çš„è¶…æ—¶æŠ¥é”™ï¼Œæ’æŸ¥åå‘ç°æ˜¯pgæ‰§è¡Œåˆ é™¤è¯­å¥çš„æ—¶å€™è¶…è¿‡äº†æœ€å¤§æ—¶é™ pq: canceling statement due to user request\né—®é¢˜æ’æŸ¥ åˆ†æè¯­å¥æ‰§è¡Œè®¡åˆ’ EXPLAIN ANALYZE statementæŸ¥çœ‹è¯¥è¯­å¥çš„æ‰§è¡Œæƒ…å†µï¼Œå‘ç°é•¿æ—¶é—´æ— å“åº”ï¼Œç¼©å°limitæ•°é‡é‡è¯•ï¼Œå¾—åˆ°ï¼š\nQUERY PLAN ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ Delete on history (cost=32.45..119.05 rows=83 width=87) (actual time=3791.173..3791.175 rows=0 loops=1) -\u0026gt; Nested Loop (cost=32.45..119.05 rows=83 width=87) (actual time=3774.474..3789.531 rows=10 loops=1) -\u0026gt; HashAggregate (cost=31.75..31.85 rows=10 width=138) (actual time=3771.885..3771.904 rows=10 loops=1) Group Key: \u0026#34;ANY_subquery\u0026#34;.uid, \u0026#34;ANY_subquery\u0026#34;.vid Batches: 1 Memory Usage: 24kB -\u0026gt; Subquery Scan on \u0026#34;ANY_subquery\u0026#34; (cost=0.00..31.70 rows=10 width=138) (actual time=103.109..3771.850 rows=10 loops=1) -\u0026gt; Limit (cost=0.00..31.60 rows=10 width=57) (actual time=103.104..3771.828 rows=10 loops=1) -\u0026gt; Seq Scan on history history_1 (cost=0.00..48477444.80 rows=15343146 width=57) (actual time=103.103..3771.821 rows=10 loops=1) Filter: (ts \u0026lt;= \u0026#39;1678603902000\u0026#39;::bigint) Rows Removed by Filter: 6974992 -\u0026gt; Index Scan using history_pkey on history (cost=0.70..8.72 rows=1 width=63) (actual time=1.757..1.757 rows=1 loops=10) Index Cond: ((uid = \u0026#34;ANY_subquery\u0026#34;.uid) AND (vid = \u0026#34;ANY_subquery\u0026#34;.vid)) Planning Time: 0.376 ms Execution Time: 3791.369 ms (14 è¡Œè®°å½•) å‘ç°ä¸»è¦é˜»å¡åœ¨å­æŸ¥è¯¢ï¼Œä¼˜åŒ–å™¨ç«Ÿç„¶é€‰æ‹©äº†Seq Scané¡ºåºæ‰«æï¼Œå¤§é‡ä¸ç¬¦åˆæ¡ä»¶çš„æ•°æ®è¢«Filterç­›æ‰ï¼Œæ—¶é—´å°±è€—åœ¨è¿™ä¸ªä¸Šè¾¹äº†ã€‚\nå•Šï¼Ÿtsä¸Šä¸æ˜¯æœ‰ç´¢å¼•ä¹ˆï¼Œè¿™ä¹ˆå¤§çš„è¡¨ç«Ÿç„¶é€‰æ‹©äº†é¡ºåºæ‰«æï¼Ÿ\né—®ä¸€ä¸‹GPT:é¡ºåºå’Œç´¢å¼•æ‰«ææ˜¯å¦‚ä½•å–èˆçš„ï¼Ÿ åœ¨PostgreSQLä¸­ï¼Œå³ä½¿åœ¨é€‰æ‹©ç›¸å…³åˆ—ä¸Šå­˜åœ¨ç´¢å¼•ï¼ŒæŸ¥è¯¢è®¡åˆ’ä¹Ÿå¯èƒ½é€‰æ‹©é¡ºåºæ‰«æï¼ˆSequential Scanï¼‰è€Œä¸æ˜¯ç´¢å¼•æ‰«æï¼ˆIndex Scanï¼‰ã€‚è¿™æ˜¯å› ä¸ºæŸ¥è¯¢ä¼˜åŒ–å™¨éœ€è¦åŸºäºå¤šç§å› ç´ åšå‡ºå†³ç­–ï¼Œå¦‚é¢„è®¡çš„æŸ¥è¯¢ä»£ä»·ï¼Œè¡¨å¤§å°ï¼Œæ•°æ®çš„åˆ†å¸ƒç­‰ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½çš„åŸå› ï¼š\nå…¨è¡¨æ‰«æä¼˜äºç´¢å¼•æ‰«æï¼šå€˜è‹¥ä½ è¦æŸ¥è¯¢çš„æ•°æ®å æ®äº†è¡¨çš„å¤§éƒ¨åˆ†ï¼Œé¡ºåºæ‰«æå¯èƒ½æ›´æœ‰æ•ˆã€‚PostgreSQLæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šæƒè¡¡å…¨è¡¨æ‰«æå’Œç´¢å¼•æ‰«æçš„ä»£ä»·ï¼Œå¦‚æœå…¨è¡¨æ‰«æçš„é¢„è®¡ä»£ä»·æ›´ä½ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šé€‰æ‹©å…¨è¡¨æ‰«æã€‚\nç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼šPostgreSQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨åŸºäºç»Ÿè®¡ä¿¡æ¯å¯¹æŸ¥è¯¢è®¡åˆ’è¿›è¡Œä¼˜åŒ–ã€‚å¦‚æœè¡¨çš„ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼ˆä¾‹å¦‚ï¼Œè¡¨æ•°æ®å·²ç»å‘ç”Ÿäº†å¤§å¹…åº¦å˜åŒ–ä½†æ˜¯æ²¡æœ‰é‡æ–°æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼‰ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å¯èƒ½ä¼šåšå‡ºé”™è¯¯çš„å†³ç­–ï¼Œå³ä½¿ç´¢å¼•æ‰«ææ›´é«˜æ•ˆï¼Œä¹Ÿå¯èƒ½é€‰æ‹©é¡ºåºæ‰«æã€‚\nç´¢å¼•åˆ—çš„é€‰æ‹©æ€§ä¸é«˜ï¼šå¦‚æœç´¢å¼•åˆ—çš„å€¼é‡å¤åº¦å¾ˆé«˜ï¼ˆä¾‹å¦‚ï¼Œæ€§åˆ«ã€æ˜¯å¦å¯ç”¨ç­‰å€¼åªæœ‰å‡ ç§çš„åˆ—ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨ç´¢å¼•æ‰«æçš„æ•ˆç‡å¯èƒ½å¹¶ä¸é«˜ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å¯èƒ½ä¼šé€‰æ‹©é¡ºåºæ‰«æã€‚\nç³»ç»Ÿå‚æ•°è®¾ç½®çš„é—®é¢˜ï¼šæŸäº›PostgreSQLç³»ç»Ÿå‚æ•°å¯èƒ½å½±å“åˆ°ç´¢å¼•çš„ä½¿ç”¨ï¼Œæ¯”å¦‚enable_seqscanå‚æ•°æ§åˆ¶äº†æ˜¯å¦ä¼˜å…ˆä½¿ç”¨é¡ºåºæ‰«æã€‚\nå¦‚æœä½ æ³¨æ„åˆ°äº†æŸ¥è¯¢è®¡åˆ’ä¸­ä¸€ç›´ä½¿ç”¨åºåˆ—æ‰«æè€Œä¸æ˜¯ç´¢å¼•æ‰«æï¼Œä¸”ç´¢å¼•æ‰«ææ˜æ˜¾æ›´é«˜æ•ˆï¼Œä½ å¯èƒ½éœ€è¦é‡æ–°æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆä½¿ç”¨ANALYZEå‘½ä»¤ï¼‰ï¼Œæˆ–è€…æ£€æŸ¥ä½ çš„æŸ¥è¯¢æ˜¯å¦èƒ½å¤Ÿæœ‰æ•ˆçš„åˆ©ç”¨ç´¢å¼•ï¼Œæˆ–è€…å®¡æŸ¥å¹¶è°ƒæ•´ç›¸å…³çš„ç³»ç»Ÿå‚æ•°ã€‚\né€ä¸€æ’æŸ¥ å…¨è¡¨æ‰«æä¼˜äºç´¢å¼•æ‰«æï¼Ÿä¸ç¡®å®šã€‚å…¨è¡¨10äº¿æ¡æ•°æ®ï¼Œå…¨è¡¨æ‰«æä¼šæ¯”ç´¢å¼•æ‰«ææ›´é«˜æ•ˆä¹ˆï¼Ÿ\nç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Ÿä¸ç¡®å®šã€‚\nç´¢å¼•åˆ—çš„é€‰æ‹©æ€§ä¸é«˜ï¼Ÿä¸å¤ªå¯èƒ½ğŸ™…ã€‚tsæ˜¯æŒ‰ç…§è§‚çœ‹æ—¶é—´æ’åºçš„ï¼Œä¸å­˜åœ¨é‡å¤åº¦å¾ˆé«˜çš„æƒ…å†µã€‚\nç³»ç»Ÿå‚æ•°è®¾ç½®çš„é—®é¢˜ï¼Ÿä¸å¤ªå¯èƒ½ğŸ™…ã€‚ä»»åŠ¡æ­£å¸¸è¿è¡Œä¸€æ®µæ—¶é—´äº†ã€‚\npsï¼šEXPLAINä¸­costä»£è¡¨æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼°ç®—çš„æŸ¥è¯¢ä»£ä»·ï¼ŒåŸå› ä¸€å…³äºå…¨è¡¨æ‰«æå’Œç´¢å¼•æ‰«æçš„å–èˆå°±å–å†³äºä¼˜åŒ–å™¨å¯¹ä¸¤ç§æ‰«ææ–¹å¼çš„ä»£ä»·ä¼°ç®—ï¼Œè€Œä¼°ç®—åˆ™éœ€è¦å‚è€ƒåŸå› äºŒæåˆ°çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€äºŒæ˜¯ç›¸å…³çš„ã€‚\næœ‰ç´¢å¼•ä½†ä¸èµ°çš„æƒ…å†µæœ‰å“ªäº›ï¼Ÿ è¡¨å¾ˆå°ï¼ˆ100è¡Œä»¥å†…ï¼‰ï¼Œé¡ºåºæ‰«æçš„æ•ˆç‡å¯èƒ½ä¼šé«˜äºç´¢å¼•æ‰«æã€‚\nè¿”å›ç»“æœå æ€»è¡¨å¾ˆå¤§æ¯”ä¾‹ã€‚\nå½“LIMITæ•°é‡å¾ˆå°æ—¶ï¼Œä¼˜åŒ–å™¨å¯èƒ½ä¼šè®¤ä¸ºâ€œé¡ºåºæ‰«æç›´åˆ°ç»“æœè¾¾åˆ°é™åˆ¶æ•°é‡åç»ˆæ­¢â€ä¼šæ›´å¿«çš„æ‰¾åˆ°ç»“æœï¼›ä½†è¿™æ˜¯åŒåˆƒå‰‘ï¼Œä¾èµ–äºè¡¨ç»Ÿè®¡æ•°æ®çš„å‡†ç¡®æ€§ã€‚\nä¼˜åŒ–å™¨å‚è€ƒçš„ç»Ÿè®¡ä¿¡æ¯æœ‰å“ªäº›ï¼Ÿ è¡¨çš„å¤§å°ï¼šä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºéå¸¸å°çš„è¡¨ï¼Œé¡ºåºæ‰«æå¾€å¾€æ›´æœ‰æ•ˆï¼Œå› ä¸ºç´¢å¼•æ‰«ææ¶‰åŠåˆ°æŸ¥æ‰¾ç´¢å¼•å¹¶è·å–ç£ç›˜ä¸Šæ•°æ®çš„è¿‡ç¨‹ï¼Œè¿™å¯¹äºå°è¡¨æ¥è¯´å¯èƒ½æ¯”ç›´æ¥é¡ºåºæ‰«ææ›´è€—æ—¶ã€‚ç›¸åï¼Œå¯¹äºå¤§è¡¨ï¼Œç´¢å¼•æ‰«æå¾€å¾€èƒ½æ˜¾è‘—æé«˜æ•ˆç‡ã€‚\nç´¢å¼•çš„é€‰æ‹©æ€§ï¼šç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯æŒ‡é€šè¿‡ç´¢å¼•èƒ½å¤ŸåŒºåˆ†çš„è®°å½•çš„ç™¾åˆ†æ¯”ã€‚å¦‚æœç´¢å¼•çš„é€‰æ‹©æ€§è¾ƒé«˜ï¼ˆä¾‹å¦‚ï¼Œä¸»é”®ç´¢å¼•ï¼‰ï¼Œé‚é‚£ä¹ˆç´¢å¼•æ‰«æå¾€å¾€æ›´æœ‰æ•ˆã€‚\næŸ¥è¯¢çš„é€‰æ‹©åº¦ï¼šå¦‚æœæŸ¥è¯¢è¿‡æ»¤å¤§éƒ¨åˆ†æ•°æ®ï¼Œé‚£ä¹ˆç´¢å¼•æ‰«æå¯¹äºæ€§èƒ½çš„æå‡æ›´æ˜æ˜¾ã€‚å› ä¸ºé¡ºåºæ‰«æéœ€è¦æ‰«ææ•´ä¸ªè¡¨ï¼Œè€Œç´¢å¼•æ‰«æåªéœ€è¦è®¿é—®æ»¡è¶³æ¡ä»¶çš„ç´¢å¼•é¡¹å’Œç›¸å…³è®°å½•ã€‚\nç¡¬ä»¶æ€§èƒ½ï¼šç¡¬ä»¶çš„ IO æ€§èƒ½å’Œ CPU æ€§èƒ½ä¹Ÿä¼šå½±å“æ‰«ææ–¹å¼çš„é€‰æ‹©ã€‚IO å¯†é›†çš„å·¥ä½œè´Ÿè½½å¯èƒ½æ›´é€‚åˆä½¿ç”¨ç´¢å¼•æ‰«æï¼Œè€Œ CPU å¯†é›†çš„å·¥ä½œè´Ÿè½½å¯èƒ½æ›´é€‚åˆä½¿ç”¨é¡ºåºæ‰«æã€‚\nç´¢å¼•å’Œè¡¨çš„ç‰©ç†é¡ºåºï¼šå¦‚æœè¡¨çš„ç‰©ç†é¡ºåºä¸ç´¢å¼•çš„é¡ºåºé«˜åº¦ç›¸å…³ï¼ˆcorrelation æ¥è¿‘ 1ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨ç´¢å¼•æ‰«æçš„æˆæœ¬å¯èƒ½é™ä½ï¼Œå› ä¸ºé¡ºåº IO å¾€å¾€æ¯”éšæœº IO æ›´é«˜æ•ˆã€‚\né—®é¢˜å®šä½ é€šè¿‡æ’æŸ¥å¯ä»¥çŒœæµ‹ï¼šæ˜¯ä¼˜åŒ–å™¨åœ¨æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤æ—¶ï¼Œå¯¹ä»£ä»·ä¼°ç®—å‡ºç°äº†é”™è¯¯ï¼Œå¯¼è‡´é€‰æ‹©äº†å®é™…æ€§èƒ½æ›´å·®çš„å…¨è¡¨æ‰«ææ–¹æ³•ã€‚\næ¨ªå‘å¯¹æ¯”å…¶ä»–è¡¨ é™¤äº†historyè¡¨ä¹‹å¤–ï¼Œæ•°æ®åº“ä¸­è¿˜æœ‰ä¸¤ä¸ªç»“æ„ç›¸ä¼¼ã€æ•°æ®é‡ç›¸ä¼¼ã€ç´¢å¼•è®¾ç½®ç›¸ä¼¼çš„è®°å½•è¡¨history_a,history_bï¼ˆç®€ç§°aè¡¨bè¡¨ï¼‰ï¼Œå…¶ä¸­aè¡¨å’Œhistoryä¸€æ ·åœ¨æ‰§è¡Œåå°åˆ é™¤ä»»åŠ¡ï¼Œbè¡¨æ²¡æœ‰æ‰§è¡Œè¿‡åˆ é™¤ä»»åŠ¡ã€‚\næµ…çœ‹ä¸€çœ¼è¡¨å†…æ€»è¡Œæ•°ï¼š\nx=\u0026gt; SELECT relname, reltuples FROM pg_class r JOIN pg_namespace n ON (relnamespace = n.oid) WHERE relkind = \u0026#39;r\u0026#39; AND n.nspname = \u0026#39;public\u0026#39;; relname | reltuples -------------------+--------------- history_a | 7.233728e+08 history | 9.3278854e+08 history_b | 8.412001e+08 å¯¹historyã€aã€båˆ†åˆ«æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤ï¼š\nx=\u0026gt; explain analyze select uid, vid from history_a where ts \u0026lt;= 1678692987000 limit 100; QUERY PLAN ---------------------------------------------------------------------------------------------------------------------------------------------------------- Limit (cost=0.57..329.24 rows=100 width=57) (actual time=0.074..11.583 rows=100 loops=1) -\u0026gt; Index Scan using history_a_ts_1 on history_a (cost=0.57..49428562.93 rows=15039219 width=57) (actual time=0.073..11.573 rows=100 loops=1) Index Cond: (ts \u0026lt;= \u0026#39;1678692987000\u0026#39;::bigint) Planning Time: 1.400 ms Execution Time: 11.617 ms (5 è¡Œè®°å½•) x=\u0026gt; explain analyze select uid, vid from history where ts \u0026lt;= 1678692987000 limit 100; QUERY PLAN ----------------------------------------------------------------------------------------------------------------------------------------- Limit (cost=0.00..262.93 rows=100 width=57) (actual time=519.878..14138.338 rows=100 loops=1) -\u0026gt; Seq Scan on history (cost=0.00..48477444.80 rows=18437250 width=57) (actual time=519.877..14138.275 rows=100 loops=1) Filter: (ts \u0026lt;= \u0026#39;1678692987000\u0026#39;::bigint) Rows Removed by Filter: 24919480 Planning Time: 0.671 ms Execution Time: 14138.486 ms (6 è¡Œè®°å½•) x=\u0026gt; explain analyze select uid, vid from history_b where ts \u0026lt;= 1678692987000 limit 100; QUERY PLAN ----------------------------------------------------------------------------------------------------------------------------------------------- Limit (cost=0.00..14.53 rows=100 width=77) (actual time=2.032..12.098 rows=100 loops=1) -\u0026gt; Seq Scan on history_b (cost=0.00..42239628.56 rows=290642848 width=77) (actual time=2.031..12.085 rows=100 loops=1) Filter: (ts \u0026lt;= \u0026#39;1678692987000\u0026#39;::bigint) Rows Removed by Filter: 1033 Planning Time: 0.610 ms Execution Time: 15.866 ms (6 è¡Œè®°å½•) å¥½å¥‡æ€ªï¼Œå‘ç°aè¡¨é€‰æ‹©äº†ç´¢å¼•æ‰«æï¼Œbå’Œhistoryè¡¨éƒ½æ˜¯é¡ºåºæ‰«æï¼Œä½†æ˜¯bè¡¨æ‰§è¡Œé€Ÿåº¦æ˜¾è‘—å¿«äºhistoryè¡¨ã€‚ çºµå‘å¯¹æ¯”è‡ªå·± x=\u0026gt; explain analyze select uid, vid from history where ts \u0026lt;= 1678763273000 limit 500; QUERY PLAN --------------------------------------------------------------------------------------------------------------------------------------- Limit (cost=0.00..1166.31 rows=500 width=57) (actual time=10.661..7664.132 rows=500 loops=1) -\u0026gt; Seq Scan on history (cost=0.00..48421139.20 rows=20758242 width=57) (actual time=10.660..7663.903 rows=500 loops=1) Filter: (ts \u0026lt;= \u0026#39;1678763273000\u0026#39;::bigint) Rows Removed by Filter: 14947898 Planning Time: 0.056 ms Execution Time: 7666.074 ms (6 è¡Œè®°å½•) x=\u0026gt; explain analyze select uid, vid from history where ts \u0026lt;= 1678763273000 order by ts limit 500; QUERY PLAN -------------------------------------------------------------------------------------------------------------------------------------------------------------------- Limit (cost=0.57..1595.46 rows=500 width=65) (actual time=1.700..64.891 rows=500 loops=1) -\u0026gt; Index Scan using history_ts_1 on history (cost=0.57..66214154.35 rows=20758242 width=65) (actual time=1.699..64.824 rows=500 loops=1) Index Cond: (ts \u0026lt;= \u0026#39;1678763273000\u0026#39;::bigint) Planning Time: 0.053 ms Execution Time: 64.949 ms (5 è¡Œè®°å½•) æ·»åŠ äº†order byå¼ºåˆ¶å‘½ä»¤èµ°ç´¢å¼•ï¼Œå‘ç°èµ°ç´¢å¼•çš„ä¼°ç®—costæ¯”é¡ºåºæ‰«æçš„ä¼°ç®—costè¦ä½ï¼Œè¯´æ˜äº†ä¼˜åŒ–å™¨ä¸ºä»€ä¹ˆä¼šé€‰æ‹©é¡ºåºæ‰«æã€‚åŒæ ·ä¹Ÿè¯´æ˜ä¼°ç®—å‡ºç°äº†é—®é¢˜ã€‚ çŒœæƒ³ æ‰¹é‡åˆ é™¤å¯¼è‡´äº†é¡ºåºæ‰«æè€—æ—¶å¢åŠ ï¼Œå¯èƒ½å’Œé¢‘ç¹åˆ é™¤æ’å…¥å¯¼è‡´ç£ç›˜ç‰©ç†é¡ºåºä¹±åºæœ‰å…³ï¼Œå› æ­¤åœ¨éå†æ—¶éœ€è¦è®¿é—®æ›´å¤šçš„å†…å­˜é¡µã€‚ ä¼˜åŒ–å™¨åœ¨historyè¡¨ä¸Šå†³ç­–æ‰§è¡Œè®¡åˆ’æ—¶å‚è€ƒçš„ç»Ÿè®¡æ•°æ®æœ‰é—®é¢˜ï¼Œå¯¼è‡´ä»£ä»·ä¼°ç®—å‡ºç°åå·®ï¼Œå¯èƒ½çš„åŸå› æ˜¯æ²¡æœ‰åŠæ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®ã€‚ éªŒè¯ æŸ¥è¯¢historyè¡¨å’Œaè¡¨çš„çŠ¶æ€ä¿¡æ¯è¡¨ï¼ŒæŸ¥çœ‹æœ€åæ‰§è¡Œvacuumå’Œanalyzeçš„æ—¶é—´ã€‚\nx=\u0026gt; select relname,last_analyze,last_autoanalyze,last_autovacuum from pg_stat_user_tables where relname=\u0026#39;history_a\u0026#39; or relname=\u0026#39;history\u0026#39;; -[ RECORD 1 ]----+------------------------------ relname | history_a last_analyze | last_autoanalyze | 2024-03-13 07:05:50.585392+00 last_autovacuum | 2024-03-11 13:13:25.05856+00 -[ RECORD 2 ]----+------------------------------ relname | history last_analyze | last_autoanalyze | last_autovacuum | 2024-03-13 16:54:04.673357+00 historyè¡¨ç«Ÿç„¶æ²¡æœ‰é…ç½®auto analyzeã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ï¼ˆbè¡¨ä¹Ÿæ²¡é…ï¼‰ é—®é¢˜è§£å†³ æ‰‹åŠ¨æ‰§è¡Œ ANALYZE analyze historyä¼šä»¥é‡‡æ ·çš„æ–¹å¼å¯¹è¡¨ç»Ÿè®¡æ•°æ®è¿›è¡Œä¼°ç®—ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å¯¹è¾ƒå¿«ï¼›å¹¶ä¸”åªä¼šé˜»å¡å¦‚ vacuumã€åˆ›å»ºç´¢å¼•ã€reindexã€alter tableç­‰å‘½ä»¤ï¼Œä¸ä¼šå½±å“è¡¨çš„è¯»å†™ã€‚\né‡æ–°æ‰§è¡Œå‘½ä»¤ x=\u0026gt; explain analyze select uid, vid from history where ts \u0026lt;= 1678795619000 limit 500; QUERY PLAN ----------------------------------------------------------------------------------------------------------------------------------------------------------------- Limit (cost=0.57..1978.10 rows=500 width=57) (actual time=11.670..16.685 rows=500 loops=1) -\u0026gt; Index Scan using history_ts_1 on history (cost=0.57..495456.97 rows=125272 width=57) (actual time=11.669..16.638 rows=500 loops=1) Index Cond: (ts \u0026lt;= \u0026#39;1678795619000\u0026#39;::bigint) Planning Time: 11.769 ms Execution Time: 17.972 ms (5 è¡Œè®°å½•) é—®é¢˜è§£å†³ã€‚\næ­¤å¤–ï¼Œè¿˜å¯ä»¥ä¿®æ”¹limitå€¼è§‚å¯Ÿä¸€ä¸‹æ˜¯ä¸æ˜¯å½“limitå¾ˆå°æ—¶ä¼šé¡ºåºæŸ¥è¯¢ï¼š\nx=\u0026gt; explain analyze select uid, vid from history where ts \u0026lt;= 1710418557000 limit 1; QUERY PLAN ---------------------------------------------------------------------------------------------------------------------------------- Limit (cost=0.00..0.05 rows=1 width=57) (actual time=1.055..1.056 rows=1 loops=1) -\u0026gt; Seq Scan on history (cost=0.00..48494915.20 rows=924846115 width=57) (actual time=1.054..1.054 rows=1 loops=1) Filter: (ts \u0026lt;= \u0026#39;1710418557000\u0026#39;::bigint) Planning Time: 6.117 ms Execution Time: 1.076 ms (5 è¡Œè®°å½•) æœç„¶å¦‚æ­¤ã€‚\nç´¢å¼•ä¼˜åŒ– åœ¨å¯»æ‰¾é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ç´¢å¼•å†…å­˜å ç”¨è¾ƒå¤§ï¼Œå¯èƒ½ä¸æ•°æ®é¢‘ç¹çš„åˆ é™¤æ–°å¢æœ‰å…³ï¼Œç§°ä¹‹ä¸ºç´¢å¼•è†¨èƒ€\næŸ¥è¯¢æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨çš„å¤§å°ï¼š\nSELECT table_name, pg_size_pretty(table_size) AS table_size, pg_size_pretty(indexes_size) AS indexes_size, pg_size_pretty(total_size) AS total_size FROM ( SELECT table_name, pg_table_size(table_name) AS table_size, pg_indexes_size(table_name) AS indexes_size, pg_total_relation_size(table_name) AS total_size FROM ( SELECT (\u0026#39;\u0026#34;\u0026#39; || table_schema || \u0026#39;\u0026#34;.\u0026#34;\u0026#39; || table_name || \u0026#39;\u0026#34;\u0026#39;) AS table_name FROM information_schema.tables where table_schema = \u0026#39;public\u0026#39; ) AS all_tables ORDER BY total_size DESC ) AS pretty_sizes; reindex:\nREINDEX TABLE CONCURRENTLY history; æˆ–è€…æ‰‹åŠ¨\nCREATE INDEX CONCURRENTLY history_ts_1 ON history(ts); DROP INDEX CONCURRENTLY history_ts; CREATE UNIQUE INDEX CONCURRENTLY history_pkey_new ON history(uid, vid); ALTER TABLE history DROP CONSTRAINT history_pkey, ADD CONSTRAINT history_pkey PRIMARY KEY USING INDEX history_pkey_new; ","permalink":"http://localhost:1313/posts/postgres/pg_timeout/","summary":"\u003ch1 id=\"postgres-æ‰¹é‡åˆ é™¤è¯­å¥è¶…æ—¶\"\u003ePostgres æ‰¹é‡åˆ é™¤è¯­å¥è¶…æ—¶\u003c/h1\u003e\n\u003ch2 id=\"åœºæ™¯\"\u003eåœºæ™¯\u003c/h2\u003e\n\u003cp\u003eæ’­æ”¾è®°å½•è¡¨\u003ccode\u003ehistory\u003c/code\u003eä¸­å¤§çº¦æœ‰å°†è¿‘10äº¿æ¡æ•°æ®ï¼Œä¸ºäº†å‡å°‘å†…å­˜å ç”¨ï¼Œåå°ä»»åŠ¡ä»¥æ¯ç§’ä¸€æ¬¡çš„é€Ÿåº¦åˆ é™¤è¶…è¿‡1å¹´æœªæ›´æ–°çš„æ—§è®°å½•ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eè¡¨ç»“æ„ï¼ˆç¤ºæ„ç»“æ„ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eTable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;public.history\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eColumn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003eType\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eCollation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNullable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDefault\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e--------+--------+-----------+----------+---------\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003etext\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e           \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enot\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evid\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003etext\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e           \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enot\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"w\"\u003e     \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003ebigint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e           \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enot\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003eIndexes\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;history_pkey\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ePRIMARY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebtree\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;history_ts\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebtree\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003eåˆ é™¤è¯­å¥\n\u003ccode\u003edelete from history where (uid, vid) in (select uid, vid from history where ts \u0026lt;= $1 limit 500)\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"é—®é¢˜å‡ºç°\"\u003eé—®é¢˜å‡ºç°\u003c/h2\u003e\n\u003cp\u003eä»»åŠ¡ç¨³å®šè¿è¡Œäº†ä¸€å¹´å¤šçš„æ—¶é—´ï¼Œçªç„¶æœ‰ä¸€å¤©çº¿ä¸Šæ—¥å¿—å‡ºç°äº†å¤§é‡çš„è¶…æ—¶æŠ¥é”™ï¼Œæ’æŸ¥åå‘ç°æ˜¯pgæ‰§è¡Œåˆ é™¤è¯­å¥çš„æ—¶å€™è¶…è¿‡äº†æœ€å¤§æ—¶é™ \u003ccode\u003epq: canceling statement due to user request\u003c/code\u003e\u003c/p\u003e","title":"Postgres æ‰¹é‡åˆ é™¤è¯­å¥è¶…æ—¶"},{"content":"å“¨å…µæœºåˆ¶ å‚è€ƒ Redis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜\nå°æ—coding redis\nåŸç† å¼•å…¥å“¨å…µçš„ç›®çš„ ä¸»ä»å¤åˆ¶æœºåˆ¶å¯ä»¥ä¿è¯ä»åº“æ–­è¿æ¢å¤åæ•°æ®ä¸€è‡´æ€§ä»¥åŠæ•´ä½“æœåŠ¡çš„å¯ç”¨æ€§ï¼Œä½†æ˜¯å¦‚æœä¸»åº“æ•…éšœå°±ä¼šå¯¼è‡´å†™æ“ä½œé˜»å¡ä»¥åŠåŒæ­¥ç»ˆæ­¢ï¼Œè¿™æ—¶å°±éœ€è¦å¼•å…¥å“¨å…µæœºåˆ¶äº†ï¼ˆSentinelï¼‰ã€‚\nå“¨å…µçš„ä¸‰ä»»åŠ¡ å“¨å…µä¹Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„redisè¿›ç¨‹ï¼Œè´Ÿè´£ä¸‰ä¸ªä»»åŠ¡ï¼šç›‘æ§ã€é€‰ä¸»ã€é€šçŸ¥\nç›‘æ§ï¼šå‘¨æœŸæ€§åœ°ç»™æ‰€æœ‰çš„ä¸»ä»åº“å‘é€ PING å‘½ä»¤ï¼Œæ£€æµ‹å®ƒä»¬æ˜¯å¦ä»ç„¶åœ¨çº¿è¿è¡Œã€‚å¦‚æœå“åº”è¶…æ—¶å°±ä¼šæŠŠå¯¹åº”èŠ‚ç‚¹æ ‡è®°ä¸ºâ€œä¸‹çº¿çŠ¶æ€â€ï¼Œå¦‚æœä¸»åº“ä¸‹çº¿ï¼Œå°±éœ€è¦è¿›å…¥é€‰ä¸»ä»»åŠ¡ é€‰ä¸»ï¼šå½“ä¸»åº“æŒ‚äº†å°±éœ€è¦æ ¹æ®ä¸€å®šçš„è§„åˆ™ï¼ˆåè¾¹ä¼šè¯´ï¼‰é€‰æ‹©ä¸€ä¸ªä»åº“å®ä¾‹ä½œä¸ºæ–°ä¸»åº“ é€šçŸ¥ï¼šå°†æ–°ä¸»åº“è¿æ¥ä¿¡æ¯åŒæ­¥ç»™å…¶ä»–ä»åº“å’Œå®¢æˆ·ç«¯ï¼Œè®©ä¸»ä»é‡æ–°å»ºç«‹èµ·åŒæ­¥è¿æ¥ å“¨å…µé›†ç¾¤ å•å“¨å…µçš„é—®é¢˜ï¼š\nå•ä¸ªå“¨å…µæ•…éšœä¼šå¯¼è‡´æ— æ³•è¿›è¡Œä¸»ä»åˆ‡æ¢ å“¨å…µè‡ªèº«ç½‘ç»œå»¶è¿Ÿå¯¼è‡´è¯¯åˆ¤ä¸»èŠ‚ç‚¹ä¸‹çº¿ è§£å†³ï¼šå“¨å…µé›†ç¾¤\nåŸç†ï¼šå‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶\næ³¨æ„äº‹é¡¹ï¼šæ‰€æœ‰å“¨å…µçš„é…ç½®åº”è¯¥ä¿æŒä¸€è‡´\nå“¨å…µé›†ç¾¤é…ç½® å“¨å…µé…ç½®æ–‡ä»¶ä¸­ï¼š sentinel monitor \u0026lt;master-name\u0026gt; \u0026lt;ip\u0026gt; \u0026lt;redis-port\u0026gt; \u0026lt;quorum\u0026gt; å¯è§å“¨å…µåªéœ€è¦çŸ¥é“ä¸»èŠ‚ç‚¹ipç«¯å£ï¼Œé‚£ä¹ˆå“¨å…µä¹‹é—´ä»¥åŠå“¨å…µä»èŠ‚ç‚¹ä¹‹é—´æ˜¯æ€ä¹ˆæ„ŸçŸ¥çš„å‘¢ï¼Ÿ\nå“¨å…µä¹‹é—´å¦‚ä½•å»ºç«‹è¿æ¥ ä¾æ‰˜å‘å¸ƒè®¢é˜…æœºåˆ¶ã€‚ä¸»åº“ä¸­æœ‰ä¸€ä¸ªsentinel:helloâ€é¢‘é“ï¼Œå½“ä¸€ä¸ªæ–°å“¨å…µåŠ å…¥åï¼Œä¼šå‘æ‰€æœ‰è®¢é˜…è¯¥é¢‘é“çš„å“¨å…µå¹¿æ’­æ–°å“¨å…µçš„ipç«¯å£å·ï¼Œä»è€Œå»ºç«‹è¿æ¥ã€‚\nå“¨å…µä»èŠ‚ç‚¹ä¹‹å‰å¦‚ä½•å»ºç«‹è¿æ¥ å“¨å…µå‘ä¸»åº“å‘é€INFOå‘½ä»¤è·å–æ‰€æœ‰ä»åº“ipç«¯å£ï¼Œä»è€Œå»ºç«‹è¿æ¥ã€‚\nç›‘æ§ ä¸»è§‚ä¸‹çº¿ã€å®¢è§‚ä¸‹çº¿ å½“å“¨å…µå‘ç°å“åº”è¶…æ—¶åï¼Œä¼šåˆ¤æ–­ä¸»åº“ä¸ºâ€œä¸»è§‚ä¸‹çº¿â€çŠ¶æ€ï¼Œå³â€œæˆ‘è®¤ä¸ºä¸»åº“ä¸‹çº¿äº†â€ï¼Œç„¶åå‘é€å‘½ä»¤è¯¢é—®å…¶ä»–å“¨å…µæ˜¯å¦èµåŒè¿™ä¸ªåˆ¤æ–­ï¼Œå½“èµåŒç¥¨è¶…è¿‡é…ç½®æ–‡ä»¶ä¸­çš„quorumæ•°é‡æ—¶ï¼Œå°±å¯ä»¥æ ‡è®°ä¸»åº“ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œ quorumå€¼é»˜è®¤æ˜¯n/2+1ï¼ˆnä¸ºå“¨å…µæ•°ï¼‰ã€‚\npsï¼šå®¢è§‚ä¸‹çº¿åªé’ˆå¯¹ä¸»åº“ï¼Œå¯¹äºä»åº“åˆ¤å®šä¸»è§‚ä¸‹çº¿å°±å¤Ÿäº†\né€‰ä¸» åœ¨æ­£å¼å¼€å§‹ä¹‹å‰éœ€è¦ç¡®è®¤ä¸€ç‚¹ï¼šé€‰ä¸»çš„ä»»åŠ¡æ˜¯ç”±å“ªä¸ªå“¨å…µæ‰§è¡Œçš„ï¼Ÿ\næŠ•ç¥¨é€‰å–leaderå“¨å…µ ä»å€™é€‰è€…ä¸­é€šè¿‡æŠ•ç¥¨é€‰å‡ºleaderè´Ÿè´£æ¥ä¸‹æ¥çš„ä¸»ä»æ•…éšœè½¬ç§»ã€‚æ¯ä¸ªå“¨å…µåªæœ‰ä¸€æ¬¡æŠ•ç¥¨æœºä¼šï¼Œå€™é€‰è€…ä¼šæŠŠç¥¨æŠ•ç»™è‡ªå·±ã€‚\nå€™é€‰è€…æ˜¯åˆšåˆšåˆ¤å®šä¸»èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿çš„æ‰€æœ‰å“¨å…µã€‚\næˆä¸ºleaderæ¡ä»¶ï¼š\næ‹¿åˆ°åŠæ•°ä»¥ä¸Šèµæˆç¥¨ å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„quorumå€¼ é€‰æ‹©æ–°çš„ä¸»èŠ‚ç‚¹ é€‰æ‹©çš„åŸåˆ™ï¼šï¼ˆç­›é€‰+æ‰“åˆ†ï¼‰æ‰“åˆ†é˜¶æ®µé‡åˆ°æœ€é«˜åˆ†ä»åº“å°±é€‰æ‹©å®ƒ\nç•™ä¸‹å½“å‰åœ¨çº¿ä¸”ä¹‹å‰è¶…æ—¶æ¬¡æ•°å°äº10æ¬¡çš„ä»åº“ ä¼˜å…ˆçº§æœ€é«˜çš„ä»åº“å¾—åˆ†é«˜ï¼Œä¼˜å…ˆçº§ç”±ç”¨æˆ·é…ç½® å’Œæ—§ä¸»åº“åŒæ­¥ç¨‹åº¦æœ€æ¥è¿‘çš„ä»åº“å¾—åˆ†é«˜ï¼Œä¸»åº“ä»åº“åœ¨ç¯å½¢ç¼“å­˜æ•°ç»„ï¼ˆrepl_backlog_bufferï¼‰ä¸Šéƒ½æœ‰è‡ªå·±çš„å¤åˆ¶è¿›åº¦offsetï¼Œåˆ¤æ–­ä¸»ä»offsetçš„è·ç¦» ID å·å°çš„ä»åº“å¾—åˆ†é«˜ï¼ŒIDæ˜¯å®ä¾‹ç¼–å· é€šçŸ¥ é€šçŸ¥ä»åº“å’Œå®¢æˆ·ç«¯\né€šçŸ¥ä»åº“ é¦–å…ˆï¼Œå‘é€‰å®šçš„èŠ‚ç‚¹å‘é€slaveof no oneå‘½ä»¤å°†å…¶å‡çº§ä¸ºæ–°ä¸»èŠ‚ç‚¹ï¼Œç„¶åé€šè¿‡slaveof ip portå°†å…¶ä»–æ‰€æœ‰ä»èŠ‚ç‚¹è¿æ¥åˆ°æ–°ä¸»èŠ‚ç‚¹ã€‚\næ­¤å¤–ï¼Œè¿˜éœ€è¦ç›‘å¬æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“ä»–é‡æ–°ä¸Šçº¿æ—¶éœ€è¦å°†å…¶è½¬å˜æˆæ–°ä¸»èŠ‚ç‚¹çš„ä»åº“ã€‚\né€šçŸ¥å®¢æˆ·ç«¯ ä¸»ä»æ•…éšœè½¬ç§»çš„æ¯ä¸ªäº‹ä»¶éƒ½å¯¹åº”å‘å¸ƒè®¢é˜…æœºåˆ¶ä¸­çš„ä¸€ä¸ªé¢‘é“ï¼Œå®¢æˆ·ç«¯å¯ä»¥è®¢é˜…å¯¹åº”é¢‘é“çš„æ¶ˆæ¯å¾—çŸ¥ä¸»ä»åˆ‡æ¢çŠ¶æ€ã€‚\næ€»ç»“ å¤šèŠ‚ç‚¹ä¹‹å‰æ€ä¹ˆåè°ƒçš„ï¼š\nç›¸äº’æ„ŸçŸ¥ï¼šå‘å¸ƒè®¢é˜… åšå†³å®šï¼šæŠ•ç¥¨ ","permalink":"http://localhost:1313/posts/redis/sentinel/","summary":"Redisçš„å“¨å…µæœºåˆ¶è§£å†³äº†ä¸»åº“æ•…éšœçš„é—®é¢˜ï¼Œé€šè¿‡ç›‘æ§ã€é€‰ä¸»å’Œé€šçŸ¥å®ç°é«˜å¯ç”¨æ€§å’Œæ•…éšœè½¬ç§»ï¼Œæä¾›å¯é çš„æœåŠ¡ã€‚","title":"redis å“¨å…µæœºåˆ¶"},{"content":"è´¨æ•°ç­›æ³• é—®é¢˜ï¼šåˆ¤æ–­1åˆ°nä¸­æœ‰å“ªäº›è´¨æ•°ï¼ˆLC.204 è´¨æ•°è®¡æ•°ï¼‰\nç®—æœ¯åŸºæœ¬å®šç† ç®—æœ¯åŸºæœ¬å®šç†ï¼Œåˆç§°ä¸ºæ­£æ•´æ•°çš„å”¯ä¸€åˆ†è§£å®šç†ï¼Œå³ï¼šæ¯ä¸ªå¤§äº1çš„è‡ªç„¶æ•°ï¼Œè¦ä¹ˆæœ¬èº«å°±æ˜¯è´¨æ•°ï¼Œè¦ä¹ˆå¯ä»¥å†™ä¸º2ä¸ªæˆ–ä»¥ä¸Šçš„è´¨æ•°çš„ç§¯ï¼Œè€Œä¸”è¿™äº›è´¨å› å­æŒ‰å¤§å°æ’åˆ—ä¹‹åï¼Œå†™æ³•ä»…æœ‰ä¸€ç§æ–¹å¼ã€‚\næ¨è®ºï¼šä»»ä½•ä¸€ä¸ªåˆæ•°éƒ½å¯ä»¥è¡¨ç¤ºæˆä¸€ä¸ªè´¨æ•°å’Œå¦ä¸€ä¸ªæ•°çš„ä¹˜ç§¯\nåŸƒæ°ç­› sieve of Eratosthenes åŸƒæ°ç­›ï¼ˆ sieve of Eratosthenesï¼‰å¯¹äºæ¯ä¸€ä¸ªè´¨æ•°ï¼Œæ ‡è®°å®ƒåœ¨nä»¥å†…çš„æ‰€æœ‰å€æ•°ï¼Œæ ¹æ®æ¨è®ºå¯çŸ¥å½“éå†ç»“æŸåï¼Œæ‰€æœ‰åˆæ•°éƒ½è¢«æ ‡è®°ã€‚\nä¼˜ç‚¹ï¼šç›¸æ¯”äºå¯¹nä»¥å†…æ¯ä¸ªæ•°æœ´ç´ çš„å•ç‹¬åˆ¤æ–­ï¼Œæ—¶é—´å¤æ‚åº¦æ›´ä½ ç¼ºç‚¹ï¼šå¯¹äºåŒä¸€ä¸ªåˆæ•°å­˜åœ¨é‡å¤æ ‡è®°çš„ç°è±¡ï¼ˆ18: 2*9 3*6ï¼‰ ä»£ç ï¼š\nfunc sieveOfEratosthenes(n int) { notPrime := map[int]bool{1: true} // å–åå¯ä»¥çœç•¥åˆå§‹åŒ–è¿‡ç¨‹ for i := 2; i*i \u0026lt;= n; i++ { if !notPrime[i] { for j := i * i; j \u0026lt;= n; j += i { // jä»i*iå¼€å§‹ï¼Œå› ä¸ºå°äºi*içš„å€¼å·²ç»åœ¨ä¹‹å‰åˆ¤æ–­è¿‡äº† notPrime[j] = true } } } } æ¬§æ‹‰ç­› sieve of Euler æ¬§æ‹‰ç­›å¯¹äº1åˆ°nçš„æ¯ä¸ªæ•°ï¼Œæ ‡è®°å®ƒä¸æ¯”å®ƒå°çš„æ‰€æœ‰è´¨æ•°åˆ†åˆ«ç›¸ä¹˜å¾—åˆ°çš„åˆæ•°ï¼Œåœ¨æ ‡è®°æ—¶æ³¨æ„ä¿è¯åˆæ•°æ˜¯ç”±å…¶æœ€å°çš„è´¨å› æ•°å¾—åˆ°çš„ï¼ˆä¿è¯å”¯ä¸€æ ‡è®°çš„åŸç†ï¼‰ã€‚æ ¹æ®æ¨è®ºå¯çŸ¥å½“éå†ç»“æŸåï¼Œæ‰€æœ‰åˆæ•°éƒ½è¢«æ ‡è®°ã€‚\nä¼˜ç‚¹ï¼šæ¯”åŸƒæ°ç­›æ›´å¿«ï¼Œå› ä¸ºé¿å…äº†åˆæ•°çš„é‡å¤æ ‡è®° ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„ç©ºé—´ä¿å­˜å·²ç»éªŒè¯çš„è´¨æ•°ï¼Œä»¥ç©ºé—´æ¢æ—¶é—´ ä»£ç ï¼š\nfunc sieveOfEuler(n int) { primes := []int{} notPrime := map[int]bool{1: true} for i := 2; i \u0026lt;= n; i++ { if !notPrime[i] { primes = append(primes, i) } for j := 0; j \u0026lt; len(primes) \u0026amp;\u0026amp; i*primes[j] \u0026lt;= n; j++ { notPrime[i*primes[j]] = true if i%primes[j] == 0 { // ä¿è¯æ¯ä¸ªåˆæ•°éƒ½è¢«å…¶æœ€å°è´¨å› å­ç­›å» break } } } } ä»£ç ä¸­ i%primes[j] == 0 ä»€ä¹ˆæ„æ€ å‡è®¾ï¼ši = 4 æ—¶ primes = []int{2, 3}\nå¦‚æœä¸åši%primes[j] == 0åˆ¤æ–­ï¼Œé‚£ä¹ˆä¼šæ ‡è®°åˆæ•° 4*3=12ï¼Œ\né‚£ä¹ˆå½“i = 6æ—¶ï¼Œå°±ä¼šå‡ºç°åˆæ•°6*2=12çš„é‡å¤æ ‡è®°ï¼Œè€Œæ¬§å¼ç­›æ­£æ˜¯ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‡ºç°ï¼Œå¯¹äºåˆæ•°ï¼Œåªç”±ä»–çš„æœ€å°è´¨å› æ•°ç­›å»ã€‚\nä¸ºä»€ä¹ˆprimes[j]ä¹‹åçš„è´¨æ•°éƒ½è·³è¿‡äº†ï¼Ÿ å› ä¸ºiæ˜¯primes[j]çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆä»–å†ä¹˜åç»­çš„æ¯ä¸ªæ•°éƒ½ç›¸å½“äº(a*primes[j])*xï¼ˆaï¼šå€æ•°ï¼Œxï¼šåç»­æŸä¸ªæ•°ï¼‰ï¼Œ\nç­‰ä»·äºprimes[j]*(a*x)ï¼Œè¿™ä¸ªa*xå°±ç•™ç»™ä¹‹åçš„iäº†ï¼Œå°±æ˜¯ä¸ºäº†ä¿è¯æ¯ä¸ªåˆæ•°åªç”±ä»–çš„æœ€å°è´¨å› æ•°ç­›å»ã€‚\n","permalink":"http://localhost:1313/posts/algorithm/prime/","summary":"æ–‡ç« ä»‹ç»äº†åˆ¤æ–­è´¨æ•°çš„ä¸¤ç§ç­›æ³•ï¼šåŸƒæ°ç­›æ ‡è®°è´¨æ•°å€æ•°ä½†ä¼šé‡å¤æ ‡è®°åˆæ•°ï¼Œæ¬§æ‹‰ç­›é¿å…äº†é‡å¤ä½†éœ€é¢å¤–ç©ºé—´å­˜å‚¨éªŒè¯è¿‡çš„è´¨æ•°ã€‚","title":"è´¨æ•°ç­›æ³•"},{"content":"ä¸»ä»å¤åˆ¶ å‚è€ƒ Redis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜\nå°æ—coding redis\nåŸç† å¯ç”¨å¤šå°æœåŠ¡å™¨ï¼Œä½¿ç”¨ä¸€ä¸»å¤šä»çš„ç»“æ„ï¼Œå°†æ•°æ®å¤‡ä»½åˆ°æ¯ä¸€å°æœåŠ¡å™¨ä¸Šã€‚\nç›®çš„ï¼šåˆ†æ‘Šä¸»æœåŠ¡å™¨å‹åŠ›ã€æé«˜å¯ç”¨æ€§\nä¸»ä»å¤åˆ¶å…±æœ‰ä¸‰ç§æ¨¡å¼ï¼šå…¨é‡å¤åˆ¶ã€åŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ã€å¢é‡å¤åˆ¶ã€‚\nå•ç‚¹æ¨¡å¼é¢ä¸´çš„é—®é¢˜ï¼š æ‰€æœ‰è¯·æ±‚éƒ½ç”±ä¸€å°æœºå™¨å¤„ç†ï¼Œå‹åŠ›è¿‡å¤§ æœåŠ¡å™¨å®•æœºå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ ä¸»ä»å¤åˆ¶æ¨¡å¼ä¼˜åŠ¿ï¼š è¯»å†™åˆ†ç¦»ã€‚ä¸»åº“å¤„ç†å†™è¯·æ±‚ï¼Œä»åº“è´Ÿè´£è¯»ã€‚ ä¸€å°æœåŠ¡å™¨å®•æœºä¸ä¼šå½±å“æ•´ä½“æœåŠ¡ ä¸»ä»å¤åˆ¶æ¨¡å¼é—®é¢˜ï¼š æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ˆåŒæ­¥æœºåˆ¶ï¼‰ éœ€è¦è€ƒè™‘æ•…éšœè½¬ç§»ï¼ˆå“¨å…µæœºåˆ¶ï¼‰ å…¨é‡å¤åˆ¶ï¼ˆåˆæ¬¡åŒæ­¥ï¼‰ åˆæ¬¡åŒæ­¥ä¸‰é˜¶æ®µï¼šå»ºç«‹è¿æ¥ã€åŒæ­¥æ•°æ®ã€æŸ¥æ¼è¡¥ç¼º å»ºç«‹è¿æ¥ å‘½ä»¤ï¼š replicaof 192.168.1.1 6379\næ‰§è¡Œè¯¥å‘½ä»¤å°†å½“å‰å®ä¾‹å˜æˆæŒ‡å®šip:hostå®ä¾‹çš„ä»åº“ã€‚\nç½‘ç»œå±‚é¢çœ‹ï¼Œå½“å‰å®ä¾‹ç»™ä¸»æœåŠ¡å™¨å‘é€psyncåŒæ­¥è¯·æ±‚ï¼ˆpsync ? -1 ?è¡¨ç¤ºæœªçŸ¥çš„ä¸»åº“runIDï¼Œ-1è¡¨ç¤ºç¬¬ä¸€æ¬¡å¤åˆ¶ï¼‰ï¼Œä¸»æœåŠ¡å™¨æ”¶åˆ°åä¼šè¿”å›FULLRESYNCå…¨é‡å¤åˆ¶å‘½ä»¤å“åº”ï¼ŒåŒæ—¶ä¼šæºå¸¦runIDï¼ˆrediså®ä¾‹idï¼‰å’Œoffsetï¼ˆå¤åˆ¶è¿›åº¦ï¼‰\nè¿æ¥å»ºç«‹ä»¥åï¼Œå°±å‡†å¤‡è¿›å…¥å…¨é‡å¤åˆ¶é˜¶æ®µäº†ã€‚\nåŒæ­¥æ•°æ® ä¸»åº“é€šè¿‡bgsaveå‘½ä»¤é€šè¿‡forkå‡ºçš„å­è¿›ç¨‹å¼‚æ­¥ç”ŸæˆRDBæ–‡ä»¶ï¼Œç„¶åå°†æ–‡ä»¶å‘ç»™ä»åº“ã€‚ä»åº“æ”¶åˆ°åï¼Œå…ˆæ¸…ç©ºå½“å‰æ•°æ®åº“ï¼Œç„¶ååŠ è½½RDBæ–‡ä»¶ï¼Œä¸ºäº†é¿å…ä»åº“ä¸­ä¹‹å‰æ•°æ®çš„å½±å“ã€‚\nä¸»ä»æ•°æ®ä¸€è‡´æ€§é—®é¢˜ å­˜åœ¨ä¸‰ä¸ªæ—¶é—´æ®µï¼Œä¼šå¯¼è‡´æ–°æ”¶åˆ°çš„å†™å‘½ä»¤ä¸ä¼šåŒæ­¥ç»™ä»åº“ï¼š\nä¸»åº“ç”ŸæˆRDBæ–‡ä»¶æœŸé—´ ä¸»åº“å‘é€RDBæ–‡ä»¶æœŸé—´ ä»åº“åŠ è½½RDBæ–‡ä»¶æœŸé—´ å¦‚æœä¸è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œæ•°æ®åº“ä¸­æ•°æ®è¶Šå¤šRDBæ–‡ä»¶è¶Šå¤§ï¼Œå¯¼è‡´çš„ä¸ä¸€è‡´æƒ…å†µä¹Ÿä¼šè¶Šä¸¥é‡ã€‚\nè§£å†³åŠæ³•ï¼šä½¿ç”¨ replication buffer ç¼“å†²åŒº åœ¨RDBå‘é€è¿‡ç¨‹ä¸­ï¼Œå°†æ‰€æœ‰æ–°å¢åˆ°çš„å†™å‘½ä»¤è®°å½•åˆ°è¯¥ç¼“å†²åŒºä¸­ï¼Œåœ¨æ”¶åˆ°ä»åº“çš„å…¨é‡å¤åˆ¶å®Œæˆä¿¡å·åï¼Œå°±è¿›å…¥ç¬¬ä¸‰é˜¶æ®µï¼Œå¤åˆ¶ç¼“å†²åŒºä¸­çš„å‘½ä»¤ã€‚\næŸ¥æ¼è¡¥ç¼º ä¸»åº“å°†replication bufferä¸­çš„æ‰€æœ‰è®°å½•å‘é€ç»™ä»åº“ï¼Œè‡³æ­¤ï¼Œä¸»ä»ä¹‹é—´çš„ç¬¬ä¸€æ¬¡åŒæ­¥å°±å®Œæˆäº†ã€‚\nåŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ åœ¨ä¸»ä»åº“å®Œæˆç¬¬ä¸€æ¬¡åŒæ­¥åï¼ŒåŒæ–¹ä¹‹é—´ç»´æŠ¤ä¸€ä¸ªTCPé•¿è¿æ¥ï¼Œç›®çš„æ˜¯é¿å…é¢‘ç¹çš„æ–­å¼€å’Œè¿æ¥å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚\nå½“ä¸»åº“æ”¶åˆ°å†™æ“ä½œæ—¶ï¼Œä¼šé€šè¿‡é•¿è¿æ¥ä¼ æ’­ç»™ä»åº“ã€‚\nå¢é‡å¤åˆ¶ å½“ä¸»ä»åº“ä¹‹é—´å‡ºç°äº†ç½‘ç»œé—®é¢˜ï¼Œå¦‚ä½•åŒæ­¥ç½‘ç»œæ–­è¿æœŸé—´ä¸»åº“æ–°å¢çš„å†™å‘½ä»¤ï¼Ÿ\né‡æ–°è¿›è¡Œå…¨é‡å¤åˆ¶ï¼ˆredis 2.8ä»¥å‰ï¼‰ï¼Œå¼€é”€å¾ˆå¤§ å¢é‡å¤åˆ¶ï¼ˆç›®å‰é‡‡ç”¨çš„æ–¹æ³•ï¼‰ ç½‘ç»œæ¢å¤åå¦‚ä½•ç¡®å®šæ–­å¼€æœŸé—´ä¸»åº“å¢é‡çš„æ•°æ®ï¼Ÿrepl_backlog_bufferç¯å½¢ç¼“å†²åŒºã€‚\nrepl_backlog_buffer repl_backlog_bufferæ˜¯ä¸€ä¸ªå¤§å°å¯æŒ‡å®šçš„ç¯å½¢ç¼“å†²åŒºï¼Œå†™æ“ä½œä¸ä»…ä¼šå†™å…¥ replication bufferï¼Œè¿˜ä¼šå†™å…¥è¯¥ç¯å½¢ç¼“å†²åŒºã€‚ä¸»åº“å’Œä»åº“åˆ†åˆ«ç»´æŠ¤è‡ªå·±å†™åˆ°æˆ–è¯»åˆ°çš„ä½ç½®ã€‚\nå½“ä¸»ä»åº“ä¹‹é—´çš„è¿æ¥é‡æ–°å»ºç«‹åï¼Œä»åº“ä¼šå‘é€psyncå‘½ä»¤è¯·æ±‚åŒæ­¥ï¼Œå…¶ä¸­ä¼šæºå¸¦å¤åˆ¶è¿›åº¦offsetã€‚ä¸»åº“ä»è€Œå¯ä»¥æ ¹æ®è‡ªå·±çš„offsetå’Œä»åº“çš„offsetåˆ¤æ–­æ–­çº¿æœŸé—´æ–°å¢çš„å†™å‘½ä»¤æœ‰å“ªäº›ï¼Œç„¶åä¾æ¬¡åŒæ­¥ç»™ä»åº“ã€‚\nå¦‚æœä¸»åº“åˆ¤æ–­offsetæ—¶å‘ç°ä»åº“è¦è¯»å–çš„æ•°æ®å·²ç»è¢«è¦†ç›–äº†ï¼Œé‚£ä¹ˆå°±ä¼šé‡‡ç”¨å…¨é‡åŒæ­¥ã€‚\npsï¼šç¯å½¢ç¼“å†²åŒºå†™æ»¡åï¼Œç»§ç»­å†™å…¥ä¼šè¦†ç›–æ‰ä¹‹å‰çš„æ•°æ®ã€‚å¦‚æœä»åº“çš„è¯»å–é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ä»åº“è¿˜æœªè¯»å–çš„æ“ä½œè¢«ä¸»åº“æ–°å†™çš„æ“ä½œè¦†ç›–äº†ï¼Œè¿™ä¼šå¯¼è‡´ä¸»ä»åº“é—´çš„æ•°æ®ä¸ä¸€è‡´ã€‚\nè§£å†³ï¼šè°ƒæ•´ç¼“å†²åŒºå¤§å°\næ€»ç»“ ä¸»ä»å¤åˆ¶ä¸‰é˜¶æ®µã€ä¸»ä»ç½‘ç»œå»¶è¿Ÿçš„æ•°æ®ä¸€è‡´æ€§ä¿è¯\né—®é¢˜ï¼šä¸»åº“æ•…éšœæˆ–æ–­è¿ï¼Œå¦‚ä½•ä¿è¯æœåŠ¡å¯é æ€§ï¼Ÿ\nè§£å†³ï¼šå“¨å…µé›†ç¾¤\n","permalink":"http://localhost:1313/posts/redis/replication/","summary":"Redisä¸»ä»å¤åˆ¶å°†æ•°æ®å¤‡ä»½åˆ°å¤šä¸ªä»æœåŠ¡å™¨ï¼Œæé«˜å¯ç”¨æ€§ã€‚ä¸»ä»åŒæ­¥åŒ…æ‹¬å…¨é‡å¤åˆ¶ã€åŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ã€å¢é‡å¤åˆ¶é˜¶æ®µã€‚","title":"redis ä¸»ä»å¤åˆ¶æœºåˆ¶"},{"content":"æŒä¹…åŒ–ä¹‹rdbå’Œæ··åˆå¿«ç…§ å‚è€ƒ Redis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜\nå°æ—coding redis\nå®šä¹‰ RDBï¼šRedis DataBase\nRDB è®°å½•çš„æ˜¯æŸä¸€æ—¶åˆ»çš„æ•°æ®ï¼Œå› æ­¤æ¢å¤æ•ˆç‡ä¼šæ¯”aofæ–¹å¼é«˜ã€‚\nå…¨é‡å¿«ç…§ è®°å½•æŸä¸€æ—¶åˆ»çš„å…¨éƒ¨æ•°æ®\nåŒæ­¥æ‰§è¡Œ é€šè¿‡saveå‘½ä»¤åœ¨ä¸»è¿›ç¨‹ä¸­ç”Ÿæˆrdbæ–‡ä»¶ï¼Œå†™å…¥æœŸé—´ä¼šé˜»å¡ä¸»è¿›ç¨‹ã€‚\né—®é¢˜ï¼šä¸»è¿›ç¨‹å¯èƒ½é•¿æ—¶é—´é˜»å¡\nå¼‚æ­¥æ‰§è¡Œ é€šè¿‡bgsaveå‘½ä»¤æˆ–è€…åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œç”±åˆ›å»ºçš„å­è¿›ç¨‹ç”Ÿæˆrdbæ–‡ä»¶ï¼Œå¯ä»¥é¿å…ä¸»è¿›ç¨‹é˜»å¡ã€‚\nåŒæ—¶ï¼Œä½¿ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯ä¿è¯äº†å¿«ç…§çš„å®Œæ•´æ€§ï¼Œä¹Ÿå…è®¸ä¸»çº¿ç¨‹åŒæ—¶å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œé¿å…äº†å¯¹æ­£å¸¸ä¸šåŠ¡çš„å½±å“ã€‚ä½†æ˜¯ï¼Œä¹Ÿå¯¼è‡´ä¸»è¿›ç¨‹å¯¹æ•°æ®çš„ä¿®æ”¹ä¸ä¼šåº”ç”¨åœ¨æœ¬æ¬¡çš„å¿«ç…§ä¹‹ä¸­ã€‚\né—®é¢˜ï¼š\næ‰§è¡Œé¢‘ç‡è¿‡é«˜ï¼šé¢‘ç¹å°†å…¨é‡æ•°æ®å†™å…¥ç£ç›˜ï¼Œé€ æˆç£ç›˜å‹åŠ›è¿‡å¤§ï¼›å¦å¤–ï¼Œé¢‘ç¹forkå­è¿›ç¨‹ä¹Ÿä¼šé˜»å¡ä¸»è¿›ç¨‹ã€‚ æ‰§è¡Œé¢‘ç‡è¿‡ä½ï¼šå®•æœºä¼šå¯¼è‡´ä¸¤æ¬¡å¿«ç…§æœŸé—´çš„æ•°æ®ä¸¢å¤±ã€‚ å¢é‡å¿«ç…§ åšä¸€æ¬¡å…¨é‡å¿«ç…§ï¼Œåç»­æ¯ä¸ªå¿«ç…§æ—¶åˆ»åªéœ€è¦è®°å½•å¢é‡ä¿®æ”¹çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚\né—®é¢˜ï¼šä¸ºäº†è®°å½•ä¿®æ”¹ä¿¡æ¯å¼•å…¥çš„é¢å¤–ç©ºé—´å¼€é”€è¾ƒå¤§ã€‚\næ··åˆå¿«ç…§ é€šè¿‡é…ç½®æ–‡ä»¶å¼€å¯æ··åˆå¿«ç…§ï¼Œä½¿ç”¨rdbæ ¼å¼è®°å½•å…¨é‡æ•°æ®ï¼ŒåŒæ—¶ä½¿ç”¨aofæ ¼å¼è®°å½•ä¸¤æ¬¡å¿«ç…§é—´çš„å¢é‡è®°å½•ï¼Œåœ¨ä¸‹ä¸€æ¬¡å¿«ç…§æ—¶æ¸…ç©ºaofè®°å½•ã€‚\nä¼˜åŠ¿ï¼šå…¼é¡¾äº†rdbæ¢å¤é€Ÿåº¦å¿«å’Œaofæ•°æ®å°‘ä¸¢å¤±çš„ä¼˜ç‚¹\n","permalink":"http://localhost:1313/posts/redis/rdb/","summary":"RDBè®°å½•äº†æŸä¸€æ—¶åˆ»çš„æ•°æ®ï¼Œæ¢å¤æ•ˆç‡é«˜ã€‚å…¨é‡å¿«ç…§å¯ä»¥åŒæ­¥æˆ–å¼‚æ­¥æ‰§è¡Œï¼Œå¼‚æ­¥æ‰§è¡Œä½¿ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œé¿å…äº†ä¸»è¿›ç¨‹é˜»å¡ã€‚å¢é‡å¿«ç…§è®°å½•äº†å¢é‡ä¿®æ”¹çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚æ··åˆå¿«ç…§é€šè¿‡åŒæ—¶ä½¿ç”¨RDBå’ŒAOFæ ¼å¼ï¼Œæ—¢æä¾›å¿«é€Ÿæ¢å¤åˆå‡å°‘æ•°æ®ä¸¢å¤±ã€‚","title":"redis æŒä¹…åŒ–ä¹‹RDB"},{"content":"æŒä¹…åŒ–ä¹‹AOFæ—¥å¿— å‚è€ƒ å‚è€ƒ Redis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜\nå°æ—coding redis\nå®šä¹‰ AOFï¼šAppend Only File ä¿å­˜å†™å‘½ä»¤åˆ°æ—¥å¿—ï¼Œå½“æ•°æ®éœ€è¦æ¢å¤æ—¶æ‰§è¡Œaofæ–‡ä»¶ä¸­è®°å½•çš„æ‰€æœ‰å†™æ“ä½œå‘½ä»¤ã€‚\nç‰¹ç‚¹ å†™åæ—¥å¿— Rediså…ˆæ‰§è¡Œå‘½ä»¤æŠŠæ•°æ®å†™å…¥å†…å­˜ï¼Œç„¶åå†è®°å½•æ—¥å¿—\nä¼˜ç‚¹ï¼š\né¿å…é¢å¤–çš„æ£€æŸ¥å¼€é”€ ä¸ä¼šé˜»å¡å½“å‰å†™å‘½ä»¤çš„æ‰§è¡Œ ç¼ºç‚¹\næ•°æ®å¯èƒ½å› ä¸ºå®•æœºä¸¢å¤± å¯èƒ½é˜»å¡ä¸‹ä¸€ä¸ªå‘½ä»¤ æ–‡æœ¬å½¢å¼ä¿å­˜ å‘½ä»¤set k våœ¨aofæ–‡ä»¶ä¸­çš„è¡¨ç°å½¢å¼ï¼š\n*3 --\u0026gt; å•è¯æ•° $3 --\u0026gt; å­—ç¬¦æ•° set $1 k $1 v ä¼˜ç‚¹ï¼š\nå¯è¯»æ€§å¼ºï¼Œæ–¹ä¾¿è°ƒè¯• å®¹é”™æ€§æ›´å¼ºï¼Œä¸€éƒ¨åˆ†æ•°æ®æŸåä¸ä¼šå½±å“æ•´ä¸ªæ–‡ä»¶çš„è§£æ ç¼ºç‚¹ï¼š\nç©ºé—´å ç”¨è¾ƒå¤§ å­˜åœ¨å†—ä½™è®°å½•ï¼ˆéœ€è¦é‡å†™ï¼‰ å†™å›ç­–ç•¥ å†™å›ï¼šå†™å…¥ç£ç›˜\nä¸‰ç§å†™å›ç­–ç•¥ åœ¨é…ç½®æ–‡ä»¶ä¸­appendfsyncå¯å¡«å†™ä¸‰ç§å‚æ•°ï¼šAlways, Everysec, Noï¼Œ ä¸‰ç§ç­–ç•¥æ˜¯å¯¹äºä¸»è¿›ç¨‹é˜»å¡å’Œå‡å°‘æ•°æ®ä¸¢å¤±ä¸¤ä¸ªé—®é¢˜çš„å–èˆã€‚\naofå†™å…¥æµç¨‹ æ‰§è¡Œå†™å‘½ä»¤ -\u0026gt; å†™åˆ°ç”¨æˆ·æ€aofç¼“å†²åŒº -\u0026gt; å‘èµ·I/Oç³»ç»Ÿè°ƒç”¨write()å°†aofç¼“å†²åŒºæ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºpage cache -\u0026gt; æ’å…¥é˜Ÿåˆ—ï¼Œç”±å†…æ ¸å†³å®šä½•æ—¶å†™å…¥ç£ç›˜\nç”±æ­¤å¯è§ï¼Œæ€§èƒ½ç“¶é¢ˆé›†ä¸­åœ¨writeç³»ç»Ÿè°ƒç”¨å°†æ•°æ®æ‹·è´åˆ°ç³»ç»Ÿç¼“å†²åŒºæ­¥éª¤ä¸Šï¼Œåœ¨æ­¤æœŸé—´ä¸»è¿›ç¨‹ä¼šè¢«é˜»å¡ã€‚\næ“ä½œç³»ç»Ÿçš„fsync()ç³»ç»Ÿè°ƒç”¨å¯ä»¥ç«‹å³å°†å†…æ ¸ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥ç£ç›˜ï¼Œä¸‰ç§å†™å…¥ç­–ç•¥å¯¹åº”ç€ä¸‰ç§fsyncçš„è°ƒç”¨æ—¶æœºï¼š\nAlways ç­–ç•¥å°±æ˜¯æ¯æ¬¡å†™å…¥ AOF æ–‡ä»¶æ•°æ®åï¼Œå°±æ‰§è¡Œ fsync() å‡½æ•°ï¼› Everysec ç­–ç•¥å°±ä¼šåˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æ¥æ‰§è¡Œ fsync() å‡½æ•°ï¼› No ç­–ç•¥å°±æ˜¯æ°¸ä¸æ‰§è¡Œ fsync() å‡½æ•°; psï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ å› ä¸ºå¤šçº¿ç¨‹éœ€è¦æ¶‰åŠå…±äº«èµ„æºçš„å¹¶å‘æ§åˆ¶ï¼Œå®ç°å¤æ‚ä¸”ä¼šæœ‰æ€§èƒ½æŸè€—ã€‚\né‡å†™æœºåˆ¶ å½“aofæ–‡ä»¶è¿‡å¤§æ—¶ï¼ˆé»˜è®¤64MBï¼‰ï¼Œä¼šä»ä¸»è¿›ç¨‹forkå‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œåœ¨åå°è¿›è¡Œaofçš„é‡å†™ã€‚\né‡å†™è¿‡ç¨‹ï¼š\nå­è¿›ç¨‹æ‰«ææ•°æ®åº“ä¸­ï¼ˆå†…å­˜Redisæ•°æ®ï¼‰æ‰€æœ‰æ•°æ®ï¼Œé€ä¸€æŠŠå†…å­˜æ•°æ®çš„é”®å€¼å¯¹è½¬æ¢æˆä¸€æ¡å‘½ä»¤ï¼Œå†å°†å‘½ä»¤è®°å½•åˆ°é‡å†™æ—¥å¿—ã€‚ å‘ä¸»è¿›ç¨‹å‘é€ä¸€æ¡ä¿¡å·è¡¨ç¤ºè½¬æ¢å®Œæˆï¼Œä¸»è¿›ç¨‹æ”¶åˆ°ä¿¡å·åé€šè¿‡ä¿¡å·å¤„ç†å‡½æ•°å°†aofé‡å†™ç¼“å†²åŒºä¸­çš„å†…å®¹è¿½åŠ åˆ°æ–°çš„aofæ–‡ä»¶ä¸­ã€‚ ä¸»è¿›ç¨‹å¯¹æ–°çš„aofæ–‡ä»¶è¿›è¡Œæ”¹åï¼Œè¦†ç›–ç°æœ‰çš„aofæ–‡ä»¶ã€‚ fork forkå‡ºå­è¿›ç¨‹è€Œä¸æ˜¯å­çº¿ç¨‹\nå¤šçº¿ç¨‹é—´ä¼šå…±äº«å†…å­˜ï¼Œå½“ä¿®æ”¹å…±äº«å†…å­˜ä¸­çš„æ•°æ®æ—¶å°±éœ€è¦åŠ é”æ¥ä¿è¯æ•°æ®å®‰å…¨ï¼Œé€ æˆæ€§èƒ½çš„é™ä½ã€‚\nè€Œå­è¿›ç¨‹ä¼šå¤åˆ¶ä¸»è¿›ç¨‹çš„é¡µè¡¨ï¼ˆè®°å½•ç€è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜ å°„å…³ç³»ï¼‰ï¼Œè€Œä¸æ˜¯ç‰©ç†å†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶ä¸”å­è¿›ç¨‹å¯¹è¿™ä¸ªå…±äº«çš„å†…å­˜æ‹¥æœ‰åªè¯»çš„æƒé™ï¼Œå½“çˆ¶å­è¿›ç¨‹ä»»æ„ä¸€æ–¹è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå°±ä¼šå‘ç”Ÿå†™æ—¶å¤åˆ¶ã€‚\nç›®çš„ï¼šæå‡æ€§èƒ½ï¼Œå‡å°‘forkè¿‡ç¨‹é˜»å¡æ—¶é—´ å†™æ—¶å¤åˆ¶ åœ¨å‘ç”Ÿå†™æ“ä½œçš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿæ‰ä¼šå»å¤åˆ¶ç‰©ç†å†…å­˜ä¸­è¦è¢«ä¿®æ”¹çš„è¿™å—æ•°æ®ï¼Œç”Ÿæˆè¯¥æ•°æ®çš„å‰¯æœ¬ã€‚ç„¶ååœ¨è¿™ä¸ªæ•°æ®å‰¯æœ¬ä¸Šè¿›è¡Œä¿®æ”¹ã€‚\nç›®çš„ï¼šèŠ‚çº¦ç‰©ç†å†…å­˜èµ„æº é‡å†™æœŸé—´æœ‰æ•°æ®è¢«ä¿®æ”¹äº†ï¼Œå¯¼è‡´çˆ¶å­è¿›ç¨‹redisæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ è§£å†³åŠæ³•ï¼šå¯ç”¨aofé‡å†™ç¼“å†²åŒº\nrediså†…å­˜ä¸­è®¾ç½®äº†é‡å†™ç¼“å†²åŒºï¼Œå½“å­è¿›ç¨‹åˆ›å»ºä»¥åå¼€å§‹ä½¿ç”¨ã€‚\nå½“ä¸»è¿›ç¨‹æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œä¼šåŒæ—¶å°†è¿™ä¸ªå†™å‘½ä»¤å†™å…¥åˆ°AOFç¼“å†²åŒºå’ŒAOFé‡å†™ç¼“å†²åŒºã€‚\nåŒå†™çš„ç›®çš„ï¼šä¿è¯é‡å†™å¤±è´¥ä¾æ—§æ‹¥æœ‰å®Œæ•´aofæ—¥å¿—ï¼Œä¿è¯é‡å†™æœŸé—´çš„ä¿®æ”¹æ“ä½œä¸ä¼šé—æ¼ã€‚ æ€»ç»“ aofå†™å› -\u0026gt; ä¸»è¿›ç¨‹ aofé‡å†™ -\u0026gt; å­è¿›ç¨‹\né˜»å¡æ—¶æœºï¼š\nforkå­è¿›ç¨‹æ—¶ï¼Œå–å†³äºé¡µè¡¨å¤§å° å‘ç”Ÿå†™æ—¶å¤åˆ¶ï¼Œå–å†³äºä¿®æ”¹çš„æ•°æ®å¯¹åº”çš„ç‰©ç†å†…å­˜çš„å¤§å° è¿½åŠ é‡å†™ç¼“å†²åŒºä¸­çš„æ•°æ®æ—¶ï¼Œå–å†³äºæ•°æ®å¤§å° æ–‡ä»¶é‡å‘½åï¼Œè¦†ç›–ç°æœ‰aofæ–‡ä»¶æ—¶ ç¼ºç‚¹ï¼š\næ¢å¤æ—¶éœ€è¦é‡æ–°æ‰§è¡Œæ‰€æœ‰è®°å½•ï¼Œé€Ÿåº¦è¾ƒæ…¢ ","permalink":"http://localhost:1313/posts/redis/aof/","summary":"AOFæ˜¯Redisçš„ä¸€ç§æŒä¹…åŒ–æ–¹å¼ï¼Œå°†å†™å‘½ä»¤è®°å½•åˆ°æ–‡ä»¶ä¸­ï¼Œç”¨äºæ•°æ®æ¢å¤ã€‚å®ƒä»¥æ–‡æœ¬å½¢å¼ä¿å­˜ï¼Œå¯è¯»æ€§å¼ºï¼Œä½†ç©ºé—´å ç”¨è¾ƒå¤§ã€‚AOFæœ‰ä¸‰ç§å†™å›ç­–ç•¥ï¼Œå½±å“æ•°æ®ä¸¢å¤±å’Œä¸»è¿›ç¨‹é˜»å¡ã€‚Redisé€šè¿‡é‡å†™æœºåˆ¶ä¼˜åŒ–AOFæ–‡ä»¶ï¼Œæé«˜æ€§èƒ½ã€‚ AOFæ¢å¤é€Ÿåº¦è¾ƒæ…¢ï¼Œä½†å¯é ã€‚","title":"redis æŒä¹…åŒ–ä¹‹AOF"},{"content":"redisæ•°æ®ç»“æ„ å‚è€ƒ pdai Redisè¿›é˜¶\nRedis æºç å‰–æä¸å®æˆ˜\nå°æ—coding redis\nHyperLogLogç®—æ³•åŸç†\nåº•å±‚ç»“æ„ redisObject redisObjectä¸ºä¸åŒç±»å‹çš„æ•°æ®æä¾›äº†ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿Rediså¯ä»¥ç”¨ä¸€è‡´çš„æ–¹å¼å¤„ç†ä¸åŒç±»å‹çš„æ•°æ®ã€‚\nstruct redisObject { unsigned type:4; // æ•°æ®ç±»å‹ unsigned encoding:4; // ç¼–ç æ–¹å¼ // LRU è®°å½•æœ€æœ«ä¸€æ¬¡è®¿é—®æ—¶é—´; æˆ–è€… LFUï¼ˆ8ä½é¢‘ç‡ï¼Œ16ä½è®¿é—®æ—¶é—´ï¼‰ unsigned lru:LRU_BITS; int refcount; // å¼•ç”¨è®¡æ•°ï¼Œç”¨äºåƒåœ¾å›æ”¶ void *ptr; // æŒ‡å‘åº•å±‚æ•°æ®ç»“æ„å®ä¾‹ }; ç®€å•åŠ¨æ€å­—ç¬¦ä¸² SDS redisè‡ªå·±å°è£…çš„å­—ç¬¦ä¸²ç±»å‹ï¼Œå››ä¸ªå­—æ®µï¼ˆlenç°æœ‰é•¿åº¦ï¼Œallocåˆ†é…çš„ç©ºé—´é•¿åº¦ï¼Œflags SDSçš„ç±»å‹ï¼Œbuf[]å­—ç¬¦æ•°ç»„ï¼‰\nä¸ C è¯­è¨€åŸç”Ÿå­—ç¬¦ä¸²ç›¸æ¯”çš„ä¼˜åŠ¿ allocå’Œlenå­—æ®µ\né¿å…äº†Cè¯­è¨€ä¸­è·å–å­—ç¬¦ä¸²é•¿åº¦éœ€è¦éå†çš„ç¼ºç‚¹ å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ï¼ˆCè¯­è¨€é‡åˆ°\\0å°±è¡¨ç¤ºå­—ç¬¦ä¸²ç»“æŸäº†ï¼‰ å­—ç¬¦ä¸²æ‹¼æ¥æ—¶å¯ä»¥åˆ¤æ–­å†…å­˜ç©ºé—´æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Œé¿å…æº¢å‡º å­—ç¬¦ä¸²ç¼©çŸ­æ—¶å¯ä»¥æƒ°æ€§é‡Šæ”¾ç©ºé—´ï¼Œæé«˜æ€§èƒ½ flagså­—æ®µ\nflagsç±»å‹æ˜¯é’ˆå¯¹ä¸åŒå¤§å°çš„å­—ç¬¦ä¸²é€‰æ‹©äº†ä¸åŒæ¯”ç‰¹ä½çš„intå‹å˜é‡ï¼ŒèŠ‚çº¦äº†å†…å­˜ç©ºé—´ã€‚ PSï¼šä»¥ä¸Šä¹Ÿæ˜¯ golang ä¸­stringçš„è®¾è®¡æ€æƒ³ï¼ˆgoä¸­stringæ‹¼æ¥æ˜¯å¼€è¾Ÿæ–°å†…å­˜ç„¶åä¾æ¬¡copyè¿‡å»ï¼‰\nç¼–è¯‘æŒ‡ä»¤ åœ¨åˆ†é…å†…å­˜æ—¶é‡‡ç”¨**ç´§å‡‘(packed)**çš„æ–¹å¼ï¼Œé¿å…å†…å­˜å¯¹é½ï¼ŒåŒæ ·ä¸ºäº†èŠ‚çº¦å†…å­˜ã€‚\nziplist å‹ç¼©åˆ—è¡¨ ä»¥åŠ¨æ€æ•°ç»„çš„ç´§å‡‘å¸ƒå±€ä¿å­˜intæˆ–è€…stringã€‚åœ¨7.0è¢«åºŸå¼ƒã€‚\næ•´ä½“ç»“æ„ï¼š\u0026lt;zlbytes\u0026gt; \u0026lt;zltail\u0026gt; \u0026lt;zllen\u0026gt; \u0026lt;entry\u0026gt; \u0026lt;entry\u0026gt; ... \u0026lt;entry\u0026gt; \u0026lt;zlend\u0026gt;\nzlbytesï¼šåˆ—è¡¨å†…å­˜å ç”¨å¤§å° zltailï¼šå°¾èŠ‚ç‚¹å†…å­˜åç§»é‡ zllenï¼šèŠ‚ç‚¹æ€»æ•° zlendï¼š0xFFï¼Œæœ«å°¾æ ‡è®° entryç»“æ„ï¼š\u0026lt;prevlen\u0026gt; \u0026lt;encoding\u0026gt; \u0026lt;entry-data\u0026gt;\nprevlenï¼šå‰ä¸€ä¸ªentryå¤§å° encodingï¼šdataå­˜å‚¨çš„å…ƒç´ ç±»å‹å’Œé•¿åº¦ entry-dataï¼šå®é™…æ•°æ® éå† ä»å·¦å‘å³ï¼šè®¡ç®—prevlenå ç”¨å†…å­˜ï¼Œè¿›è€Œå¾—åˆ°encodingèµ·å§‹åœ°å€ï¼Œæ ¹æ®encodingç¼–ç å¯å¾—æ•°æ®å¤§å°ï¼Œä»è€Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªentryèµ·å§‹åœ°å€ã€‚\nä»å³å‘å·¦ï¼šé€šè¿‡prevlenå’Œå°¾èŠ‚ç‚¹åœ°å€å¯ä»¥ä¾æ¬¡æ¨å¯¼å‡ºä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€\nä¼˜åŠ¿ ç›¸å¯¹äºæ™®é€šæ•°ç»„ï¼Œä¸éœ€è¦é¢„åˆ†é…å†…å­˜ï¼Œä¸”æ¯ä¸ªèŠ‚ç‚¹å¤§å°ä¸å¿…ç›¸åŒï¼ˆé€šè¿‡encodingç»†åŒ–å­˜å‚¨å¤§å°ï¼‰ï¼ŒèŠ‚çº¦å†…å­˜ã€‚\nç¼ºç‚¹ æ¯æ¬¡å†™æ“ä½œï¼ˆæ‰©å®¹ç¼©å®¹ï¼‰éƒ½ä¼šè¿›è¡Œå†…å­˜åˆ†é… å› ä¸º encoding å¯¹äºä¸åŒç±»å‹ä¸åŒå¤§å°çš„æ•°æ®è¿›è¡Œäº†ç»†åŒ–ï¼Œå½“æ•°æ®å¤§å°å˜åŒ–æ—¶ï¼ˆæ–°å¢èŠ‚ç‚¹å¯¼è‡´prevlenå†…å­˜å ç”¨å˜åŒ–ï¼‰ï¼Œå¯èƒ½ä¼šå¼•å‘è¿é”æ›´æ–° å…ƒç´ è¶Šå¤šå¯¹äºåˆ—è¡¨ä¸­é—´èŠ‚ç‚¹çš„æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦è¶Šé«˜ listpack ç´§å‡‘åˆ—è¡¨ listpackæ˜¯redis5.0ä¸­é’ˆå¯¹ziplistè¿é”æ›´æ–°çš„é—®é¢˜è¿›è¡Œæ”¹è‰¯è€Œæ¥çš„æ•°æ®ç»“æ„ï¼Œå› æ­¤åŒæ ·ä¹Ÿå±äºç´§å‡‘å¸ƒå±€ã€‚\nåŸºæœ¬ç»“æ„å’Œziplistç›¸ä¼¼\næ•´ä½“ç»“æ„ï¼š\u0026lt;lpbytes\u0026gt; \u0026lt;lplen\u0026gt; \u0026lt;entry\u0026gt; \u0026lt;entry\u0026gt; ... \u0026lt;entry\u0026gt; \u0026lt;lpend\u0026gt;\nentryç»“æ„ï¼š\u0026lt;encoding\u0026gt; \u0026lt;entry-data\u0026gt; \u0026lt;entry-len\u0026gt;\nä¸åŒï¼šæ•´ä½“ç»“æ„ä¸­ç§»é™¤äº†å°¾èŠ‚ç‚¹åç§»é‡ï¼Œentryç»“æ„ä¸­æ”¹ä¸ºä¿å­˜å½“å‰entryä¸­ encoding+data çš„æ€»é•¿åº¦ï¼Œå¹¶ä¸”ä¸ºäº†ä»å³å‘å·¦éå†ä½¿ç”¨äº†å¤§ç«¯å­˜å‚¨æ¨¡å¼å¹¶å°†entry-lenæ”¾åˆ°entryæœ«å°¾ã€‚ éå† ä»å·¦å‘å³ï¼šè§£æencodingå¯ä»¥å¾—åˆ°å…ƒç´ ç±»å‹å’Œé•¿åº¦ï¼Œå¹¶ä¸”å¯ä»¥è¿›ä¸€æ­¥è®¡ç®—å¾—åˆ°lenæœ¬èº«çš„é•¿åº¦ï¼Œä»è€Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªentryèµ·å§‹åœ°å€ã€‚\nä»å³å‘å·¦ï¼šé€šè¿‡lpbytesæ€»é•¿åº¦ç›´æ¥å®šä½åˆ°å°¾éƒ¨ç»“æŸæ ‡è®°ï¼Œç„¶åä»å³åˆ°å·¦é€ä¸ªå­—èŠ‚è¯»å–entry-lenï¼ˆå½“è¯»åˆ°çš„å­—èŠ‚æœ€é«˜ä½ä¸º0è¡¨ç¤ºè¯¥ç»“æŸäº†ï¼‰,è·å¾—entryå‰ä¸¤éƒ¨åˆ†å¤§å°ï¼Œä»è€Œå¯ä»¥å®šä½åˆ°å‰ä¸€é¡¹entryçš„æœ«å°¾ï¼Œå¦‚æ­¤å¾€å¤ã€‚\nquicklist å¿«è¡¨ redis7.0ä¹‹å‰é€šè¿‡åŒå‘é“¾è¡¨+ziplistå®ç°ï¼Œ7.0ä¹‹åæ”¹ä¸ºåŒå‘é“¾è¡¨+listpackã€‚\nquicklistæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ä¸€ä¸ªziplist/listpackï¼Œåœ¨æ·»åŠ å…ƒç´ æ—¶ä¼šæ£€æŸ¥æ’å…¥ä½ç½®çš„å‹ç¼©åˆ—è¡¨æ˜¯å¦èƒ½å®¹çº³è¯¥å…ƒç´ ï¼Œå¦‚æœèƒ½å®¹çº³å°±ç›´æ¥ä¿å­˜åˆ° quicklistNode ç»“æ„é‡Œçš„å‹ç¼©åˆ—è¡¨ï¼Œå¦‚æœä¸èƒ½å®¹çº³ï¼Œæ‰ä¼šæ–°å»ºä¸€ä¸ªæ–°çš„ quicklistNode ç»“æ„ã€‚å…·ä½“ä¸€ä¸ªåˆ—è¡¨ä¸­å¯ä»¥å®¹çº³å‡ ä¸ªå…ƒç´ å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ã€‚\nä¼˜åŠ¿ ç»¼åˆäº†é“¾è¡¨å’Œæ•°ç»„çš„ä¼˜åŠ¿ï¼Œé“¾è¡¨ï¼šå¯ä»¥åŠ¨æ€å¢å‡èŠ‚ç‚¹ï¼›æ•°ç»„ï¼šå†…å­˜è¿ç»­èŠ‚çœç©ºé—´ é¿å…åˆ—è¡¨ä¸­èŠ‚ç‚¹è¿‡å¤šå¯¼è‡´çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦å˜é«˜ï¼Œåˆ†æ•£åˆ—è¡¨è´Ÿè½½ å¯ä»¥æ ¹æ®æ€§èƒ½åŠ¨æ€è°ƒæ•´ï¼ˆä¿®æ”¹é…ç½®æ–‡ä»¶ï¼‰ï¼Œæ—¶é—´æ¢ç©ºé—´æˆ–è€…ç©ºé—´æ¢æ—¶é—´ ç¼ºç‚¹ ç”±äºèåˆäº†ä¸¤ç§æ•°æ®ç»“æ„æ‰€ä»¥ç»´æŠ¤æˆæœ¬æ›´é«˜ï¼Œ7.0ä¹‹å‰ä½¿ç”¨ziplistç»“æ„æ— æ³•é¿å…è¿é”æ›´æ–°é—®é¢˜ã€‚\nå“ˆå¸Œè¡¨ æ¡¶æ•°ç»„+æ‹‰é“¾æ³•ã€‚æ’å…¥ä¸€å¯¹k-væ•°æ®æ—¶ï¼Œè®¡ç®—keyçš„hashå€¼å¹¶æ‰¾åˆ°å¯¹åº”æ¡¶ç´¢å¼•ï¼Œé‡åˆ°å†²çªåˆ™æ–°å»ºä¸€ä¸ªentryè¿æ¥åˆ°é“¾è¡¨å°¾ã€‚\nentryæ˜¯é“¾è¡¨ä¸­çš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¿å­˜ç€keyã€valueï¼ˆå­˜å€¼æˆ–è€…æŒ‡é’ˆï¼‰ä»¥åŠæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚\nä¸€ä¸ªhashç»“æ„æœ‰ä¸¤ä¸ªhashè¡¨ï¼Œä¸€ä¸ªç”¨æ¥å­˜å‚¨kvï¼Œå¦ä¸€ä¸ªä¸ºç©ºï¼Œåœ¨æ‰©å®¹æ—¶ä½¿ç”¨ã€‚\nå“ˆå¸Œè¡¨çš„æ‰©å®¹ è§¦å‘æ¡ä»¶ï¼š\næœåŠ¡å™¨ç›®å‰æ²¡æœ‰æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”è´Ÿè½½å› å­å¤§äºç­‰äº1ã€‚ æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”è´Ÿè½½å› å­å¤§äºç­‰äº5ã€‚ psï¼šè´Ÿè½½å› å­ = å“ˆå¸Œè¡¨å·²ä¿å­˜èŠ‚ç‚¹æ•°é‡ / å“ˆå¸Œè¡¨å¤§å° æ¸è¿›å¼rehashè¿‡ç¨‹ï¼š ä¸ºäº†é¿å…å¤§é‡æ•°æ®é›†ä¸­æ‹·è´å¸¦æ¥çš„æ€§èƒ½å½±å“ï¼Œæ•…ä½¿ç”¨æ¸è¿›å¼rehashï¼Œå…·ä½“è¿‡ç¨‹ä¸ºï¼š\nä¸ºé‚£ä¸ªç©ºçš„å“ˆå¸Œè¡¨åˆ†é…ä¸¤å€çš„å†…å­˜ç©ºé—´ åœ¨rehashæœŸé—´ï¼Œå¢åˆ æ”¹æŸ¥æ“ä½œéƒ½ä¼šåœ¨æ‰§è¡Œå¯¹åº”æ“ä½œä»¥å¤–ï¼ŒæŒ‰ç´¢å¼•é¡ºåºä¸€ä¸ªä¸€ä¸ªå°†ç´¢å¼•ä½ç½®çš„æ•°æ®ä»æ—§å“ˆå¸Œè¡¨è¿ç§»åˆ°æ–°è¡¨ å½“å…¨éƒ¨è¿ç§»å®Œäº†ï¼Œé‡Šæ”¾æ—§è¡¨çš„å†…å­˜ç©ºé—´ å’Œgolangçš„mapæ‰©å®¹æ€æƒ³éå¸¸ç›¸ä¼¼ï¼Œä¸è¿‡goä¸­ä¸€ä¸ªæ¡¶å®¹é‡æœ‰é™åˆ¶ï¼Œå¤šå‡ºçš„æ”¾æº¢å‡ºæ¡¶ï¼Œæ‰€ä»¥goä¸­è¿˜å­˜åœ¨ç­‰é‡æ‰©å®¹çš„æƒ…å†µ intset æ•´æ•°é›† ä¸‰ä¸ªå­—æ®µï¼šç¼–ç æ–¹å¼encodingã€å…ƒç´ æ•°é‡lengthã€ä¿å­˜å…ƒç´ çš„æ•°ç»„contents[]ã€‚æ•´æ•°é›†å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªé€’å¢intæ•°ç»„ã€‚\nåœ¨æ·»åŠ æ¯ä¸ªå…ƒç´ æ—¶ï¼Œintsetä¼šå§‹ç»ˆä¿æŒæœ‰åºï¼Œç›®çš„æ˜¯ä¾¿äºæŸ¥æ‰¾ã€‚\nå…¶ä¸­contetnsæ•°ç»„çš„intç±»å‹ï¼ˆint16ã€int32ã€int64ï¼‰ä¼šæ ¹æ®å…ƒç´ çš„å¤§å°ç¡®å®šã€‚\né€‚ç”¨äºåªå­˜å‚¨intå€¼ä¸”å­˜å‚¨æ•°é‡è¾ƒå°‘çš„æƒ…å†µã€‚\nå‡çº§ å½“åŠ å…¥çš„æ–°å…ƒç´ ç±»å‹æ¯”ç°æœ‰çš„å…ƒç´ ç±»å‹å¤§æ—¶ï¼Œéœ€è¦å¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹ï¼š\nè®¡ç®—ç±»å‹å‡çº§åæ•°ç»„æ‰€éœ€è¦çš„ç©ºé—´ï¼Œè¿½åŠ åˆ†é…åˆ°åŸæ•°ç»„æœ«å°¾ã€‚ ä»å³å‘å·¦ä¾æ¬¡è½¬æ¢åŸæ•°ç»„ä¸­çš„å…ƒç´  æ·»åŠ æ–°å…ƒç´ åˆ°æ•°ç»„æœ«å°¾ ä¼˜åŠ¿ï¼šæ ¹æ®å…ƒç´ å¤§å°åŠ¨æ€é€‰æ‹©æ•°ç»„ç±»å‹ï¼Œå¯ä»¥èŠ‚çº¦å†…å­˜èµ„æºã€‚ psï¼šæ•´æ•°é›†æ²¡æœ‰é™çº§æ“ä½œã€‚\nskiplist è·³è¡¨ è·³è¡¨æ˜¯ä¸€ç§å¤šå±‚æœ‰åºé“¾è¡¨ï¼ˆå¤šçº§ç´¢å¼•ï¼‰ï¼Œç›®çš„æ˜¯åŠ é€Ÿå¯¹äºæœ‰åºæ•°æ®çš„å¿«é€Ÿå®šä½å’ŒèŒƒå›´æŸ¥è¯¢ï¼Œå•ä¸ªæŸ¥è¯¢å¹³å‡æ—¶é—´å¤æ‚åº¦ O(logN)ã€‚\ntypedef struct zskiplistNode { sds ele; // å…ƒç´ å€¼ double score; // å…ƒç´ æƒé‡ struct zskiplistNode *backward; // åå‘æŒ‡é’ˆ struct zskiplistLevel { struct zskiplistNode *forward; // å‰å‘æŒ‡é’ˆ unsigned int span; // è·¨åº¦ï¼ˆç¦»forward nodeçš„è·ç¦»ï¼‰ } level[]; } zskiplistNode; typedef struct zskiplist { struct zskiplistNode *header, *tail; unsigned long length; int level; } zskiplist; levelæ•°ç»„ä¿å­˜äº†å½“å‰èŠ‚ç‚¹åœ¨æ¯ä¸€å±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä»¥åŠè·¨åº¦ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæœ€åº•å±‚ level0 æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ä¿å­˜æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œå…¶ä»–çš„å±‚éƒ½ç›¸å½“äºæ˜¯ç´¢å¼•ã€‚\né—®ï¼šåœ¨æ–°å»ºèŠ‚ç‚¹æ—¶å¦‚ä½•ç¡®å®šåœ¨å“ªå±‚ï¼Ÿ ç­”ï¼šéšæœºçš„ã€‚å¦‚æœå°†æ¯å±‚èŠ‚ç‚¹æ•°è®¾ç½®ä¸ºä¸‹ä¸€å±‚çš„ä¸€åŠä¼šå¯¼è‡´æ¯æ¬¡èŠ‚ç‚¹å¢åˆ éƒ½å¯èƒ½éœ€è¦è°ƒæ•´levelä¿¡æ¯ï¼Œå¸¦æ¥é¢å¤–çš„å¼€é”€ã€‚\nradix tree åŸºæ•°æ ‘ radix treeæ˜¯å‰ç¼€æ ‘ï¼ˆtrie treeï¼‰çš„ä¸€ç§ï¼Œç›¸æ¯”äºå“ˆå¸Œè¡¨èƒ½æ›´å¥½çš„èŠ‚çœå†…å­˜ç©ºé—´ï¼Œäºredis5.0å¼•å…¥ã€‚\nradix treeåŒ…å«ä¸¤ç±»èŠ‚ç‚¹ï¼Œéå‹ç¼©èŠ‚ç‚¹ï¼ˆå•ä¸ªå­—ç¬¦ï¼‰å’Œå‹ç¼©èŠ‚ç‚¹ï¼ˆå¤šå­—ç¬¦ï¼‰ï¼Œéå¶å­èŠ‚ç‚¹æ— æ³•åŒæ—¶æŒ‡å‘è¿™ä¸¤ç§å­èŠ‚ç‚¹ã€‚\nå¶å­èŠ‚ç‚¹ä¸åŒ…å«å­—ç¬¦ï¼Œç”¨äºæŒ‡å‘å®é™…çš„å€¼ã€‚\nç›®çš„ï¼šå¿«é€ŸåŒ¹é…ï¼ŒèŒƒå›´æŸ¥è¯¢ï¼ŒèŠ‚çº¦å†…å­˜\nåº”ç”¨ï¼šginæ¡†æ¶ä¸­çš„è·¯ç”±ã€golangä¸­ä¾é radix treeå¯¹ç®¡ç†å†…å­˜é¡µçš„bitmapå¿«é€Ÿæœç´¢\näº”ç§åŸºæœ¬ç±»å‹ String åº•å±‚æ•°æ®ç»“æ„ï¼šintæˆ–SDS\nå¸¸ç”¨å‘½ä»¤ï¼šSET GET SETNX SETEX MSET MGET INCR INCRBY EXPIRE DEL STRLEN\nåº”ç”¨åœºæ™¯ï¼šç¼“å­˜å¯¹è±¡ï¼ˆjsonä½œå€¼ï¼‰ã€è®¡æ•°ã€åˆ†å¸ƒå¼é”ã€session\nList åº•å±‚æ•°æ®ç»“æ„ï¼š\n3.2ä¹‹å‰ï¼šå…ƒç´ ä¸ªæ•°å’Œå…ƒç´ å¤§å°å°äºé˜ˆå€¼æ—¶ä½¿ç”¨å‹ç¼©åˆ—è¡¨ziplistï¼Œå¦åˆ™ä½¿ç”¨åŒå‘é“¾è¡¨ 3.2ä¹‹åï¼šquicklist å¸¸ç”¨å‘½ä»¤ï¼šLPUSH LPOP LRANGE LINDEX BLPOP\nåº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆä½¿ç”¨BRPOPå¯ä»¥é˜»å¡è¯»å–ï¼ŒèŠ‚çœCPUå¼€é”€ï¼‰\npsï¼šä½¿ç”¨Listä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—å­˜åœ¨ç¼ºé™·ï¼Œå…·ä½“è§Stream\nHash åº•å±‚æ•°æ®ç»“æ„ï¼š\n7.0ä¹‹å‰ï¼šå…ƒç´ ä¸ªæ•°å’Œå…ƒç´ å¤§å°å°äºé˜ˆå€¼æ—¶ä½¿ç”¨å‹ç¼©åˆ—è¡¨ziplistï¼Œå¦åˆ™ä½¿ç”¨å“ˆå¸Œè¡¨ 7.0ä¹‹åï¼šä½¿ç”¨äº† listpack æ›¿ä»£å‹ç¼©åˆ—è¡¨ å¸¸ç”¨å‘½ä»¤ï¼šHSET HMSET HDEL HLEN HGETALL HINCREBY HSCAN\nåº”ç”¨åœºæ™¯ï¼šç¼“å­˜å¯¹è±¡\nps1ï¼šç”¨Hashåšç¼“å­˜ç›¸æ¯”äºstringçš„ä¼˜åŠ¿ï¼šä¾¿äºç»´æŠ¤ã€èŠ‚çœç©ºé—´\nps2ï¼šå¦‚ä½•ä½¿ç”¨ziplistå­˜å‚¨çš„ï¼Ÿå°†æ‰€æœ‰çš„field-valueè¿ç»­å­˜å‚¨ï¼Œåˆ—è¡¨ç»“æ„ç±»ä¼¼ï¼š[field1, value1, field2, value2]\nSet ç‰¹æ€§ï¼šæ— åºã€ä¸å¯é‡å¤ã€æ”¯æŒå¤šä¸ªé›†åˆå–äº¤é›†ã€å¹¶é›†ã€å·®é›†\nåº•å±‚æ•°æ®ç»“æ„ï¼šé›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ ä¸ªæ•°å°äºé˜ˆå€¼æ—¶ä½¿ç”¨æ•´æ•°é›†intsetï¼Œå¦åˆ™ä½¿ç”¨å“ˆå¸Œè¡¨\nå¸¸ç”¨å‘½ä»¤ï¼šSADD SREM SMEMBERS SCARD SISMEMBER SRANDMEMBER SPOP SINTER SUNION SDIFF SSCAN\nåº”ç”¨åœºæ™¯ï¼šæ ‡ç­¾ï¼ˆtagï¼‰ã€ç‚¹èµ\npsï¼šä¸ºä»€ä¹ˆé€‰ç”¨intsetè€Œä¸ç”¨ziplistï¼šæ’å…¥æ—¶éœ€ä¿è¯å”¯ä¸€æ€§ï¼Œå› è€Œéœ€è¦æŸ¥æ‰¾æ˜¯å¦æœ‰ç›¸åŒå…ƒç´ ï¼Œintsetå¯ä»¥äºŒåˆ†æŸ¥æ‰¾è€Œzipliståªèƒ½éå†ã€‚\nZset ç‰¹æ€§ï¼šä¸å¯é‡å¤ã€å¯æ’åº\nåº•å±‚æ•°æ®ç»“æ„ï¼š\n7.0ä¹‹å‰ï¼šå…ƒç´ ä¸ªæ•°å’Œå…ƒç´ å¤§å°å°äºé˜ˆå€¼æ—¶ä½¿ç”¨å‹ç¼©åˆ—è¡¨ziplistï¼Œå¦åˆ™ä½¿ç”¨è·³è¡¨skiplist 7.0ä¹‹åï¼šä½¿ç”¨äº† listpack æ›¿ä»£å‹ç¼©åˆ—è¡¨ å¸¸ç”¨å‘½ä»¤ï¼šZADD ZREM ZSCORE ZCARD ZRANGE ZREVRANGE ZRAN ZSCAN\nåº”ç”¨åœºæ™¯ï¼šæ’è¡Œæ¦œ\npsï¼šå¦‚ä½•ä½¿ç”¨ziplistå­˜å‚¨çš„ï¼Ÿå°†æ‰€æœ‰çš„member-scoreè¿ç»­å­˜å‚¨ï¼Œåˆ—è¡¨ç»“æ„ç±»ä¼¼ï¼š{member, score}\nå››ç§æ‹“å±•ç±»å‹ BitMap bitmapå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç±»å‹ï¼Œè€Œæ˜¯åŸºäºStringç±»å‹çš„é¢å‘ä½ï¼ˆbit-orientedï¼‰çš„æ“ä½œã€‚stringç±»å‹å¯ä»¥å½“ä½œä¸€ä¸ªä½æ•°ç»„ï¼ˆbit vectorï¼‰\nç‰¹æ€§ï¼šé€‚ç”¨äºæ•°æ®é‡å¤§çš„äºŒå€¼ç»Ÿè®¡åœºæ™¯\nåº•å±‚åŸç†ï¼šç”±äºstringæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œä¸€ä¸ªå­—èŠ‚8bitï¼Œåˆ©ç”¨bitä¸²è¿›è¡Œè®¡æ•°\nå¸¸ç”¨å‘½ä»¤ï¼šSETBIT GETBIT BITCOUNT BITPOS BITOP [AND, OR, XOR and NOT]\nåº”ç”¨åœºæ™¯ï¼šç­¾åˆ°ç»Ÿè®¡ã€å¸ƒéš†è¿‡æ»¤å™¨\nHyperLogLog ç‰¹æ€§ï¼šä½¿ç”¨æå°çš„å†…å­˜å¯¹å¤§é‡æ•°æ®è¿›è¡Œä¸ç²¾ç¡®çš„å»é‡è®¡æ•°ï¼Œå­˜åœ¨è¯¯å·®\nåº•å±‚åŸç†ï¼šé€šè¿‡ä¼¯åŠªåˆ©å®éªŒ + æå¤§ä¼¼ç„¶ä¼°è®¡åæ¨æ ·æœ¬æ€»æ•°\nå¸¸ç”¨å‘½ä»¤ï¼šPFADD PFCOUNT PFMERGE\nåº”ç”¨åœºæ™¯ï¼šç½‘é¡µUVè®¡æ•°\nGEO ç‰¹æ€§ï¼šç”¨äºå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œå¹¶å¯¹å­˜å‚¨çš„ä¿¡æ¯è¿›è¡Œæ“ä½œï¼ŒåŒ…æ‹¬è®¡ç®—ä¸¤ç‚¹è·ç¦»ä»¥åŠè·å–åŒºåŸŸå†…å…ƒç´ ã€‚\nåº•å±‚åŸç†ï¼šç›´æ¥ä½¿ç”¨zsetï¼Œä½¿ç”¨GeoHashç¼–ç æ–¹å¼å°†ç»çº¬åº¦è½¬æ¢ä¸ºZsetä¸­çš„å…ƒç´ æƒé‡åˆ†æ•°\nå¸¸ç”¨å‘½ä»¤ï¼šGEOADD GEOPOS GEODIST GEORADIUS\nåº”ç”¨åœºæ™¯ï¼šæ»´æ»´æ‰“è½¦\nStream åœ¨5.0ä¹‹å‰ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä½¿ç”¨listå®ç°çš„ï¼Œä½†æ˜¯å­˜åœ¨ä»¥ä¸‹çš„å‡ ç‚¹é—®é¢˜ï¼š\nå¦‚æœéœ€è¦åˆ¤æ–­é‡å¤æ¶ˆæ¯ï¼Œç”Ÿäº§è€…éœ€è¦è‡ªè¡Œä¸ºæ¯æ¡æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€IDã€‚ æ¶ˆæ¯å¯é æ€§æ— æ³•ä¿è¯ï¼Œå½“æ¶ˆè´¹è€…å¤„ç†æ—¶å‡ºç°å®•æœºä¼šå¯¼è‡´å½“å‰æ¶ˆæ¯ä¸¢å¤±ã€‚å¯ä»¥åˆ›å»ºä¸€ä¸ªå¤‡ä»½listï¼Œä½†æ— æ³•å®Œå…¨ä¿è¯å¯é ã€‚ ä¸æ”¯æŒå¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ ä¸æ”¯æŒæ¶ˆè´¹ç»„çš„å®ç°ï¼Œæ¶ˆè´¹ç»„ï¼šç»„å†…ä¸€ä¸ªæˆå‘˜è¯»å–äº†æ¶ˆæ¯ï¼ŒåŒç»„å…¶ä»–æˆå‘˜å°±ä¸èƒ½å†è¯»å–åŒä¸€ä¸ªæ¶ˆæ¯äº†ã€‚ streamçš„å‡ºç°ç›®çš„å°±æ˜¯è®©æ¶ˆæ¯é˜Ÿåˆ—æ›´åŠ ç¨³å®šå¯é ã€‚\nç‰¹æ€§ï¼šè‡ªåŠ¨ç”ŸæˆIDã€æ”¯æŒackç¡®è®¤æ¶ˆæ¯çš„æ¨¡å¼ã€æ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ã€æ”¯æŒæ¶ˆè´¹ç»„\nåº•å±‚æ•°æ®ç»“æ„ï¼šradix tree + listpackï¼Œradixæ ‘ä¸­keyå€¼ä¸ºæ¶ˆæ¯IDï¼Œvalueæ˜¯listpackç»“æ„å­˜å‚¨çš„å…·ä½“æ•°æ®ã€‚\nå¸¸ç”¨å‘½ä»¤ï¼šXADD XLEN [XREAD STREAM] XDEL XRANGE XREADGROUP XPNDING XACK\nåº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€è´Ÿè½½å‡è¡¡\nåŠŸèƒ½ï¼š\næ¶ˆæ¯ä¿åºï¼šXADD/XREAD é˜»å¡è¯»å–ï¼šXREAD block é‡å¤æ¶ˆæ¯å¤„ç†ï¼šStream åœ¨ä½¿ç”¨ XADD å‘½ä»¤ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€ IDï¼› æ¶ˆæ¯å¯é æ€§ï¼šå†…éƒ¨ä½¿ç”¨ PENDING List è‡ªåŠ¨ä¿å­˜æ¶ˆæ¯ï¼Œä½¿ç”¨ XPENDING å‘½ä»¤æŸ¥çœ‹æ¶ˆè´¹ç»„å·²ç»è¯»å–ä½†æ˜¯æœªè¢«ç¡®è®¤çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä½¿ç”¨ XACK ç¡®è®¤æ¶ˆæ¯ï¼› æ”¯æŒæ¶ˆè´¹ç»„å½¢å¼æ¶ˆè´¹æ•°æ® ç¼ºç‚¹ï¼š\nå¯é æ€§ï¼šåœ¨ä»¥ä¸‹ 2 ä¸ªåœºæ™¯ä¸‹ï¼Œéƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼š AOF æŒä¹…åŒ–é…ç½®ä¸ºæ¯ç§’å†™ç›˜ï¼Œä½†è¿™ä¸ªå†™ç›˜è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼ŒRedis å®•æœºæ—¶ä¼šå­˜åœ¨æ•°æ®ä¸¢å¤±çš„å¯èƒ½ ä¸»ä»å¤åˆ¶ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œä¸»ä»åˆ‡æ¢æ—¶ï¼Œä¹Ÿå­˜åœ¨ä¸¢å¤±æ•°æ®çš„å¯èƒ½ã€‚ å¯å †ç§¯ï¼šé˜Ÿåˆ—é•¿åº¦è¶…è¿‡ä¸Šé™åï¼Œæ—§æ¶ˆæ¯ä¼šè¢«åˆ é™¤ï¼Œåªä¿ç•™å›ºå®šé•¿åº¦çš„æ–°æ¶ˆæ¯ã€‚ psï¼šå‘å¸ƒ/è®¢é˜…æœºåˆ¶ä¸ºä»€ä¹ˆä¸å¯ä»¥ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ1.ä¸å…·å¤‡æ•°æ®æŒä¹…åŒ–çš„èƒ½åŠ›ï¼ˆä¸ä¼šè®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ï¼‰2.å‘åå³å¿˜ 3.æ¶ˆæ¯ç§¯å‹ä¼šå¯¼è‡´æ¶ˆè´¹ç«¯æ–­å¼€\n","permalink":"http://localhost:1313/posts/redis/data_structure/","summary":"è¯¦ç»†åˆ†æäº†redisåº•å±‚æ•°æ®ç»“æ„ï¼Œç”±ä¸‹åˆ°ä¸Šè®¤è¯†äº†åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠä¼˜ç‚¹ç¼ºç‚¹ã€‚","title":"redis æ•°æ®ç»“æ„"},{"content":"redis å…¨æ™¯å›¾ ä¸¤ç»´åº¦ä¸‰ä¸»çº¿ ä¸¤ç»´åº¦ï¼šåº”ç”¨ç»´åº¦ï¼Œç³»ç»Ÿç»´åº¦ ä¸‰ä¸»çº¿ï¼ˆä¸‰é«˜ï¼‰ï¼šé«˜æ€§èƒ½ï¼Œé«˜å¯é ï¼Œé«˜å¯æ‰©å±• é—®é¢˜ç”»åƒå›¾ å†…éƒ¨åŸºæœ¬æ¶æ„ CSæ¶æ„ Redisé‡‡ç”¨äº†CSï¼ˆå®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼‰æ¶æ„ã€‚å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œä¾‹å¦‚GETã€SETã€SUBSCRIBEç­‰å‘½ä»¤ï¼ŒæœåŠ¡å™¨æ¥æ”¶è¿™äº›å‘½ä»¤å¹¶æ‰§è¡Œï¼Œç„¶åå°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚\næœåŠ¡å™¨ï¼šé€šå¸¸æŒ‡çš„æ˜¯è¿è¡ŒRedisæœåŠ¡è½¯ä»¶çš„è®¡ç®—æœºï¼Œè¿™ä¸ªæœåŠ¡ä¼šç›‘å¬ç‰¹å®šçš„ç«¯å£ï¼Œæ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚æœåŠ¡å™¨å­˜å‚¨å¹¶ç®¡ç†æ‰€æœ‰Redisçš„æ•°æ®ï¼Œå¹¶å¤„ç†æ‰€æœ‰ä¸æ•°æ®ç›¸å…³çš„å‘½ä»¤è¯·æ±‚ã€‚ å®¢æˆ·ç«¯ï¼šå‘RedisæœåŠ¡å™¨å‘é€å‘½ä»¤å¹¶è¯»å–æœåŠ¡å™¨è¿”å›ç»“æœçš„ä¸€æ–¹ã€‚å®¢æˆ·ç«¯å¯ä»¥æ˜¯è¿è¡Œåœ¨å‘½ä»¤è¡Œçš„Redis cliå·¥å…·ï¼Œæˆ–è€…æ˜¯åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„Redisåº“ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ åœ¨ä½ çš„ç”µè„‘ä¸Šå®‰è£…äº†Redisï¼Œå¹¶åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥redis-cliæ¥å¯åŠ¨Redisçš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œé‚£ä½ å°±æ˜¯å®¢æˆ·ç«¯ï¼Œä½ æ­£åœ¨æ“ä½œçš„è¿™ä¸ªè®¡ç®—æœºå°±æ˜¯æœåŠ¡å™¨ã€‚\nè¿™æ ·ï¼Œé€šè¿‡å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ç›¸äº’ä½œç”¨ï¼ŒRediså¯ä»¥ä½œä¸ºä¸€ä¸ªä¸­é—´äººï¼Œå…è®¸åº”ç”¨ç¨‹åºå­˜å‚¨å’Œæ£€ç´¢å€¼ï¼Œæˆ–è€…åœ¨ä¸€ç»„è®¢é˜…è€…ä¹‹é—´å‘å¸ƒå’Œæ¥æ”¶æ¶ˆæ¯ã€‚\nCSæ¶æ„ä¼˜åŠ¿ åˆ†å¸ƒå¼ï¼šåœ¨CSæ¶æ„ä¸­ï¼Œä»»åŠ¡å’Œèµ„æºåˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œå¯ä»¥åˆ©ç”¨ç½‘ç»œå°†åˆ†æ•£çš„èµ„æºå’Œå¤„ç†èƒ½åŠ›æ•´åˆåœ¨ä¸€èµ·ï¼Œæé«˜æ•´ä½“æ€§èƒ½ã€‚ æ˜“ç»´æŠ¤ï¼šæœåŠ¡å™¨é›†ä¸­å¤„ç†æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼Œæ–¹ä¾¿è¿›è¡Œæ•°æ®å¤‡ä»½å’Œæ¢å¤ï¼Œä»¥åŠç‰ˆæœ¬æ›´æ–°å’Œä¸šåŠ¡å˜æ›´ã€‚ å¯æ‰©å±•æ€§ï¼šé€šè¿‡å¢åŠ æœåŠ¡å™¨çš„æ•°é‡ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æ‰©å±•ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ï¼Œæ»¡è¶³ä¸šåŠ¡çš„å¢é•¿éœ€æ±‚ã€‚ å®‰å…¨æ€§ï¼šæœåŠ¡å™¨å¯ä»¥å®è¡Œé›†ä¸­æ§åˆ¶å’Œå®‰å…¨ä¿æŠ¤ï¼Œå¯ä»¥è¿›è¡Œæœ‰æ•ˆçš„å®‰å…¨ç®¡ç†ï¼Œå¦‚é˜²ç«å¢™ã€è®¿é—®æ§åˆ¶ç­‰ã€‚ ä¾¿äºç®¡ç†ï¼šç®¡ç†å‘˜åªéœ€è¦åœ¨æœåŠ¡å™¨ç«¯è¿›è¡Œç»´æŠ¤ï¼Œç”¨æˆ·ä¸éœ€è¦å¯¹è½¯ä»¶è¿›è¡Œå¤æ‚çš„è®¾ç½®å’Œç®¡ç†ã€‚ æ•°æ®ä¸€è‡´æ€§ï¼šæ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯åªæ˜¯è·å–å’Œæ“ä½œæ•°æ®ï¼Œå› æ­¤å¯ä»¥å¾ˆå¥½åœ°ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚ è´Ÿè½½å‡è¡¡ï¼šæœåŠ¡å™¨å¯ä»¥æ ¹æ®è´Ÿè½½æƒ…å†µï¼ŒåŠ¨æ€åˆ†é…ä»»åŠ¡ç»™å®¢æˆ·ç«¯ï¼Œä¿ƒè¿›èµ„æºçš„åˆç†åˆ©ç”¨ã€‚ ä½†åŒæ—¶ï¼ŒCSæ¶æ„ä¹Ÿæœ‰å…¶å±€é™æ€§ï¼Œä¾‹å¦‚æœåŠ¡å™¨æ˜¯ç³»ç»Ÿçš„ç“¶é¢ˆï¼ŒæœåŠ¡å™¨å‡ºé—®é¢˜å¯èƒ½å½±å“åˆ°æ‰€æœ‰çš„å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼Œåœ¨å®é™…åº”ç”¨ä¸­éœ€è¦æƒè¡¡å„ç§å› ç´ ï¼Œé€‰æ‹©é€‚åˆçš„æ¶æ„ã€‚\n","permalink":"http://localhost:1313/posts/redis/overall/","summary":"ä»å®è§‚ä¿¯ç°redis","title":"redis å…¨æ™¯å›¾"},{"content":"select å…³é”®å­— å‚è€ƒ draveness selectå…³é”®å­—\nè®¾è®¡æ€æƒ³ ä¸æ“ä½œç³»ç»Ÿä¸­å¤šè·¯å¤ç”¨æ¨¡å‹ç›¸ä¼¼ï¼ŒåŒæ—¶ç›‘å¬å¤šä¸ª channel çŠ¶æ€ï¼Œç­‰å¾…å˜ä¸ºå¯è¯»æˆ–å¯å†™ã€‚\nä¸ switch å…³é”®å­—çš„æ§åˆ¶ç»“æ„ç›¸ä¼¼ï¼Œåªä¸è¿‡ select çš„ case è¡¨è¾¾å¼å¿…é¡»æ˜¯ channel çš„æ”¶å‘æ“ä½œã€‚\nselect ä¸¤ä¸ªç‰¹åˆ«ä¹‹å¤„ï¼š\nåœ¨ channel ä¸Šå¯ä»¥è¿›è¡Œéé˜»å¡çš„æ”¶å‘æ“ä½œ åœ¨å¤šä¸ª case åŒæ—¶æ»¡è¶³æ”¶å‘çŠ¶æ€æ—¶ï¼Œéšæœºæ‰§è¡Œå…¶ä¸­ä¹‹ä¸€ éé˜»å¡æ”¶å‘ å½“ select ä¸­å­˜åœ¨ default åˆ†æ”¯æ—¶ï¼Œåªéœ€è¦çŸ¥é“å…¶ä»–åˆ†æ”¯ä¸­çš„ channel æ”¶å‘çŠ¶æ€æ˜¯å¦å°±ç»ªï¼Œå¦‚æœå…¨éƒ¨æœªå°±ç»ªå°±ä¼šæ‰§è¡Œ default åˆ†æ”¯ä¸Šçš„æ“ä½œã€‚\nå› æ­¤ï¼Œåœ¨å…¶ä»–åˆ†æ”¯ä¸Šå¯¹äº channel çš„è¯»å†™æ“ä½œéƒ½æ˜¯éé˜»å¡çš„ï¼Œå…·ä½“å®ç°è§channelè¿™ä¸€éƒ¨åˆ†ã€‚\néšæœºæ‰§è¡Œ åœ¨ runtime.selectgo å¼€å¤´ï¼Œé€šè¿‡ runtime.fastrandn å‡½æ•°éšæœºæ‰“ä¹±caseçš„è½®è¯¢é¡ºåº pollOrderã€‚\nç›®çš„ï¼šé¿å…é¥¥é¥¿é—®é¢˜çš„å‘ç”Ÿ\nå®ç°åŸç† æ¯ä¸ªcaseå¯¹åº”ä¸€ä¸ª runtime.scase ç»“æ„ä½“ï¼Œç»“æ„ä½“ä¸­ä¿å­˜ç€æ”¶å‘æ“ä½œç›®æ ‡ channel å’Œæ¥æ”¶åˆ°çš„æ•°æ®è¦æ”¾åˆ°çš„å†…å­˜åœ°å€ï¼ˆç­‰å·å·¦è¾¹å˜é‡æŒ‡é’ˆï¼‰ã€‚\nç¼–è¯‘æœŸé—´ åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä¼šæ ¹æ® case çš„ä¸åŒæƒ…å†µå¯¹æ§åˆ¶è¯­å¥è¿›è¡Œä¼˜åŒ–ï¼š\nä¸å­˜åœ¨ä»»ä½•caseï¼šè°ƒç”¨ gopark æ°¸ä¹…é˜»å¡å½“å‰ goroutineã€‚\nåªå­˜åœ¨ä¸€ä¸ªcaseï¼šæ”¹å†™ä¸º if æ¡ä»¶è¯­å¥åˆ¤æ–­æ˜¯å¦ä¸º nil channelï¼Œæ˜¯åˆ™æ°¸ä¹…é˜»å¡å½“å‰ goroutineï¼Œå¦åˆ™æ­£å¸¸æ‰§è¡Œ channel çš„æ”¶å‘æ“ä½œã€‚\nä¸€ä¸ªæ™®é€šcaseï¼Œä¸€ä¸ªdefaultï¼šæ”¹å†™ä¸º if-elseæ¡ä»¶è¯­å¥ï¼Œif ä¸­è°ƒç”¨éé˜»å¡channelæ”¶å‘å‡½æ•°ï¼Œå½“è¿”å›çš„çŠ¶æ€ä¸ºæœªå°±ç»ªæ—¶ï¼Œæ‰§è¡Œ else ä¸­çš„é€»è¾‘ã€‚\nå¤šä¸ªcaseï¼šå°†æ‰€æœ‰caseè½¬åŒ–ä¸º runtime.scase ç»“æ„ä½“æ•°ç»„ï¼Œè°ƒç”¨ runtime.selectgo å‡½æ•°ç¡®å®šå¯æ‰§è¡Œçš„caseå¯¹åº”çš„ç»“æ„ä½“ã€‚\nè¿è¡Œæ—¶æœŸé—´ è¿è¡Œæ—¶ä¸»è¦å°±æ˜¯æ‰§è¡Œ runtime.selectgo è¿™ä¸ªå‡½æ•°ï¼Œç›®çš„æ˜¯ç¡®å®šå¯æ‰§è¡Œçš„scaseç»“æ„ä½“ã€‚\nä¸»è¦æ­¥éª¤ï¼š\nåˆå§‹åŒ–ä¸¤é¡ºåºï¼šéšæœºæ‰“ä¹±è½®è¯¢é¡ºåºï¼ˆé¿å…é¥¥é¥¿ï¼‰ï¼ŒæŒ‰ç…§channelåœ°å€æ’åºç¡®å®šåŠ é”é¡ºåºï¼ˆé¿å…æ­»é”ï¼‰ã€‚å¦‚æœ case ä¸­ channel ä¸º nilï¼Œåˆ™åœ¨åç»­çš„è½®è¯¢ä¸­å¿½ç•¥è¿™ä¸ªcaseï¼ˆä¸åŠ å…¥é¡ºåºåˆ‡ç‰‡ï¼‰ã€‚ ç»™ select ä¸­çš„æ‰€æœ‰ channel åŠ é”ã€‚ æŒ‰è½®è¯¢é¡ºåºéå†æ‰€æœ‰ case æŸ¥æ‰¾å­˜åœ¨çš„å‡†å¤‡å°±ç»ªçš„ channelï¼Œå¦‚æœæœ‰ï¼Œç«‹åˆ»æ‰§è¡Œï¼Œè§£é”å…¨éƒ¨channelåè¿”å›ã€‚ å¯¹äºéé˜»å¡æ“ä½œï¼ˆå­˜åœ¨ defaultï¼‰ï¼Œç›´æ¥å…¨éƒ¨è§£é”å¹¶è¿”å›ã€‚ æŒ‰åŠ é”é¡ºåºéå†æ‰€æœ‰ caseï¼Œå°†å½“å‰ goroutine åŒ…è£…ä¸º sudogï¼ŒåŠ å…¥æ¯ä¸€ä¸ªchannelçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ­¤å¤–è¿˜ä¼šé™„ç€åœ¨å½“å‰ goroutine çš„ waiting é“¾è¡¨æœ«å°¾ã€‚ è°ƒç”¨ gopark æš‚æ­¢å½“å‰ goroutineï¼Œè§£é”æ‰€æœ‰ channelï¼Œç­‰å¾…æœ‰å°±ç»ªäº‹ä»¶æ—¶è¢«å”¤é†’ã€‚ ç»™ select ä¸­çš„æ‰€æœ‰ channel åŠ é”ã€‚ æŒ‰åŠ é”é¡ºåºéå†æ‰€æœ‰ caseï¼Œæ‰¾åˆ°å°±ç»ªçš„ caseï¼Œå°†å…¶ä»–caseä¸­æ²¡æœ‰è¢«ç”¨åˆ°çš„ sudog ä» channel ç­‰å¾…é˜Ÿåˆ—å‡ºé˜Ÿå¹¶é‡Šæ”¾æ‰ã€‚ è§£é”æ‰€æœ‰ channelï¼Œè¿”å›é€‰ä¸­çš„caseçš„ç´¢å¼•ï¼Œä»è€Œå¯ä»¥æ‰§è¡Œå¯¹åº”çš„é€»è¾‘ã€‚ ä¸æŒ‰é¡ºåºåŠ é”ä¸ºä»€ä¹ˆä¼šå¯¼è‡´æ­»é”ï¼Ÿ åœ¨å¹¶å‘åŠ é”çš„æ—¶å€™ä¼šå‡ºç°é—®é¢˜ã€‚ä¾‹å¦‚ï¼šä¸¤ä¸ªgoroutineä¸­åˆ†åˆ«æœ‰ä¸¤ä¸ªselectï¼Œg1æŒ‰é¡ºåºå¯¹ chan1ã€chan2 åŠ é”ï¼Œg2æŒ‰é¡ºåºå¯¹ chan2ã€chan1 åŠ é”ã€‚\nç”±äºselectéœ€è¦å°†å†…éƒ¨æ‰€æœ‰channeléƒ½åŠ é”æ‰ä¼šæ‰§è¡Œä»»åŠ¡ï¼Œå½“æŒ‰g1-chan1ã€g2-chan2é¡ºåºåŠ é”æ—¶ï¼Œg1-chan2ã€g2-chan1ä¼šé˜»å¡ï¼Œå¯¼è‡´æ­»é”ã€‚\nnil channel çš„ç”¨å¤„ä¸åŸç† åœ¨ä¸Šè¿°æ­¥éª¤1ä¸­ï¼Œç¡®å®š case è½®è¯¢é¡ºåºæ—¶ä¸ä¼šåŒ…æ‹¬channelä¸ºnilçš„caseï¼Œä»è€Œåœ¨åç»­çš„éå†è¿‡ç¨‹ä¸­ä¸ä¼šæ¶‰åŠè¿™ç§caseï¼Œå› æ­¤å¯ä»¥è¯´ nil channel çš„ case è¢«æ°¸ä¹…é˜»å¡äº†ã€‚\nå°†æŸä¸ªcaseçš„channelç½®ä¸ºnilå¯ä»¥ç¦ç”¨å½“å‰åˆ†æ”¯ï¼Œè€Œä¸”å…¶ä»–çš„åˆ†æ”¯ä¸ä¼šå—å½±å“ã€‚è¿™æ ·åšå¯ä»¥åœ¨for...select...è¿™ç§ç»“æ„ä¸­é¿å…ä¸€ä¸ªå·²ç»å®Œæˆæ‰€æœ‰ä»»åŠ¡çš„channelåå¤è¢«æ£€æŸ¥ï¼ŒèŠ‚çº¦äº†ç³»ç»Ÿèµ„æºã€‚\n","permalink":"http://localhost:1313/posts/golang/select/","summary":"selectå…³é”®å­—ç”¨äºå¤šè·¯é€šä¿¡å’ŒåŒæ­¥ï¼Œå¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªchannelçš„çŠ¶æ€ï¼Œå¹¶ç­‰å¾…å…¶ä¸­ä¸€ä¸ªchannelå°±ç»ªã€‚å®ƒå…·æœ‰éé˜»å¡æ”¶å‘å’Œéšæœºæ‰§è¡Œçš„ç‰¹ç‚¹ï¼Œé€šè¿‡ç¼–è¯‘å’Œè¿è¡Œæ—¶çš„ä¼˜åŒ–ä¸æœºåˆ¶æ¥å®ç°å¤šè·¯é€šä¿¡ã€‚selectæ˜¯Goä¸­å¤„ç†å¹¶å‘é€šä¿¡å’ŒåŒæ­¥çš„å¼ºå¤§å·¥å…·ã€‚","title":"Go selectå…³é”®å­—"},{"content":"channel å‚è€ƒ Draveness channel\nGolang Concepts: Nil Channels\nGo ç¨‹åºå‘˜é¢è¯•ç¬”è¯•å®å…¸ é€šé“\nè®¾è®¡åŸç† Do not communicate by sharing memory; instead, share memory by communicating.\nä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œè¦é€šè¿‡é€šä¿¡æ¥å®ç°å†…å­˜å…±äº«ã€‚\næ•°æ®ç»“æ„ type hchan struct { qcount uint // ç¯å½¢é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ€»æ•° dataqsiz uint // ç¯å½¢é˜Ÿåˆ—å¤§å° buf unsafe.Pointer // ç¯å½¢é˜Ÿåˆ—åº•å±‚æ•°ç»„ï¼Œåªé’ˆå¯¹æœ‰ç¼“å­˜channel elemsize uint16 // chanå…ƒç´ å¤§å° closed uint32 // chanæ˜¯å¦å…³é—­ elemtype *_type // chanå…ƒç´ ç±»å‹ sendx uint // ç¯å½¢é˜Ÿåˆ—ä¸­çš„å‘é€ç´¢å¼• recvx uint // ç¯å½¢é˜Ÿåˆ—ä¸­çš„æ¥æ”¶ç´¢å¼• recvq waitq // æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—ï¼ŒåŒå‘é“¾è¡¨ sendq waitq // å‘é€ç­‰å¾…é˜Ÿåˆ—ï¼ŒåŒå‘é“¾è¡¨ lock mutex // ä¿æŠ¤hchanä¸­æ‰€æœ‰å­—æ®µ } ä¸»è¦ç»„æˆ = ç¯å½¢é˜Ÿåˆ— + æ¥æ”¶é˜»å¡é˜Ÿåˆ— + å‘é€é˜»å¡é˜Ÿåˆ— é˜»å¡é˜Ÿåˆ— é˜»å¡é˜Ÿåˆ— runtime.waitq æ˜¯éµå¾ªå…ˆè¿›å…ˆå‡ºåŸåˆ™çš„åŒå‘é“¾è¡¨ï¼Œé“¾è¡¨å…ƒç´ æ˜¯å°† goroutine å’Œå¾…å‘é€æˆ–å¾…æ¥æ”¶æ•°æ®åœ°å€ç­‰è¿›è¡Œå°è£…åçš„ runtime.sudog\nsudogçš„å¿…è¦æ€§ï¼šgå’Œå¹¶å‘å¯¹è±¡æ˜¯å¤šå¯¹å¤šå…³ç³»ï¼Œä¸€ä¸ªgå¯èƒ½åœ¨å¾ˆå¤šç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚ sudog is necessary because the g â†” synchronization object relation is many-to-many. A g can be on many wait lists, so there may be many sudogs for one g; and many gs may be waiting on the same synchronization object, so there may be many sudogs for one object. åˆ›å»º é€šè¿‡ make å‡½æ•°åˆ›å»ºï¼Œæ ¹æ®å£°æ˜çš„å…ƒç´ ç±»å‹å’Œç¼“å†²åŒºå¤§å°é€‰æ‹©ä¸åŒçš„åˆå§‹åŒ–ç­–ç•¥ï¼š\næ— ç¼“å†²åŒºï¼šåªåˆ†é… runtime.hchan å†…å­˜ç©ºé—´\næœ‰ç¼“å†²åŒºï¼š\nchannelä¸­å­˜å‚¨çš„ä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼šä¸º runtime.hchan å’Œ hchan.bufåº•å±‚æ•°ç»„åˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ channelä¸­å­˜å‚¨çš„æ˜¯æŒ‡é’ˆç±»å‹ï¼šåˆ†åˆ«ä¸º hchan å’Œ åº•å±‚æ•°ç»„ åˆ†é…å†…å­˜ç©ºé—´ channelæ˜¯åœ¨å †ä¸Šåˆ†é…çš„ï¼Œç›®çš„æ˜¯ä¸ºäº†goroutineä¹‹é—´çš„é€šä¿¡ï¼ˆå› ä¸ºæ¯ä¸ªGéƒ½æœ‰è‡ªå·±çš„æ ˆï¼‰\nå‘channelå‘é€ ä¸‰ç§ç‰¹åˆ¤ï¼š\nå¦‚æœ hchan æ˜¯ nilï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ gopark æŒ‚èµ·å½“å‰goroutineï¼Œç›´æ¥è¿”å›ã€‚ éé˜»å¡å‘é€ï¼ˆselectä¸­ï¼‰å¦‚æœæ— ç¼“å†²åŒºæˆ–è€…æ»¡äº†ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ã€‚ å¦‚æœchannelå·²ç»å…³é—­ï¼Œpanicã€‚ ä¸‰ç§æƒ…å†µï¼š\næ¥æ”¶é˜»å¡é˜Ÿåˆ—ä¸ä¸ºç©º ç¼“å†²åŒºæœ‰ç©ºé—² ç¼“å†²åŒºæ— ç©ºé—² ç‰¹åˆ¤3å’Œä¸‰ç§æƒ…å†µæ˜¯è¦åŠ é”çš„ï¼ˆhchan.lockï¼‰ã€‚ æ¥æ”¶é˜»å¡é˜Ÿåˆ—ä¸ä¸ºç©º channelå¯èƒ½çš„ä¸¤ç§çŠ¶æ€ï¼šæ— ç¼“å†²åŒºchannelã€ç¼“å†²åŒºä¸ºç©ºçš„channel å–é˜Ÿå¤´å…ƒç´ ï¼Œè·å–sudogä¸­ä¿å­˜çš„å¾…æ¥æ”¶æ•°æ®åœ°å€ï¼Œç›´æ¥å°†å‘é€çš„æ•°æ®copyåˆ°å¾…æ¥æ”¶åœ°å€ä¸Šï¼Œå¹¶ä¸”å°†sudogä¸­ä¿å­˜çš„æš‚æ­¢çŠ¶æ€çš„ goroutine æ ‡è®°ä¸º Grunnable çŠ¶æ€ï¼Œæ”¾åˆ°Pçš„ runnextä½ç½®ä¸Šç­‰å¾…æ‰§è¡Œã€‚è§£é”ç›´æ¥è¿”å›ã€‚\nå¦‚ä½•ä¿è¯å¾…æ¥æ”¶æ•°æ®çš„å¯¹è±¡ä¸è¢«å›æ”¶ï¼Ÿ ç­”ï¼šä¿å­˜åˆ°ç­‰å¾…é˜Ÿåˆ—å‰è°ƒç”¨ runtime.KeepAlive ç¦æ­¢è¢«æ”¶é›†å™¨å›æ”¶ã€‚ ä¼˜ç‚¹ é™ä½äº†å†…å­˜æ‹·è´çš„æ€§èƒ½æŸè€—\næš‚æ­¢çš„goroutineä¸éœ€è¦å†è·å–channelé”æ¥æ“ä½œç¼“å†²åŒºï¼Œæé«˜äº†é€Ÿåº¦\nç¼ºç‚¹ ä¸€ä¸ªè¿è¡Œçš„Gç›´æ¥å¯¹å¦ä¸€ä¸ªGçš„æ ˆè¿›è¡Œäº†ä¿®æ”¹ï¼Œäº‹å®ä¸Šè¿åäº†GCä¸­å…³äºgoroutineæ ˆæ˜¯å„è‡ªç‹¬æœ‰çš„å‡è®¾ï¼Œå› æ­¤éœ€è¦åœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­åŠ å†™å±éšœã€‚\nç¼“å†²åŒºæœ‰ç©ºé—´ è·å– hchan.sendx ç´¢å¼•ï¼Œå°†æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºç´¢å¼•ä½ç½®ï¼Œæ›´æ–°ç´¢å¼•ã€‚è§£é”ç›´æ¥è¿”å›ã€‚\nç¼“å†²åŒºæ— ç©ºé—´ ä¸¤ç§æƒ…å†µï¼šæ— ç¼“å†²åŒºchannelã€ç¼“å†²åŒºå·²æ»¡channel ç»„è£…åŒ…å«å½“å‰gä»¥åŠç›¸å…³ä¿¡æ¯çš„ sudogï¼Œå°†å…¶å…¥é˜Ÿï¼Œå¹¶è°ƒç”¨ gopark æš‚æ­¢å½“å‰çš„gï¼Œç­‰å¾…è¢«å”¤é†’ã€‚\nä»channelæ¥æ”¶ ä¸‰ä¸ªç‰¹åˆ¤\nå¦‚æœ hchan æ˜¯ nilï¼Œå¯¹äºéé˜»å¡æ¥æ”¶ç›´æ¥è¿”å›ï¼›è€Œå¯¹äºé˜»å¡æ¥æ”¶ä¼šè°ƒç”¨ gopark æŒ‚èµ·å½“å‰goroutineï¼Œç›´æ¥è¿”å›ã€‚ éé˜»å¡æ¥æ”¶ï¼ˆselectä¸­ï¼‰å¦‚æœæ— ç¼“å†²åŒºæˆ–è€…ç¼“å†²åŒºä¸ºç©ºï¼Œæ¸…é™¤å¾…æ¥æ”¶æŒ‡é’ˆå¯¹åº”çš„æ•°æ®ï¼ˆå°†ç­‰å·å·¦è¾¹ç­‰å¾…èµ‹å€¼çš„å˜é‡ç½®ä¸ºé›¶å€¼ï¼‰ï¼Œç›´æ¥è¿”å›ã€‚ å¦‚æœchannelå·²ç»å…³é—­ï¼Œå¹¶ä¸”ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®ï¼Œæ¸…é™¤å¾…æ¥æ”¶æŒ‡é’ˆå¯¹åº”çš„æ•°æ®ï¼Œç›´æ¥è¿”å›ã€‚ ä¸‰ç§æƒ…å†µ\nå‘é€é˜»å¡é˜Ÿåˆ—ä¸ä¸ºç©º ç¼“å†²åŒºæœ‰æ•°æ® ç¼“å†²åŒºæ— æ•°æ® åŒæ ·ï¼Œç‰¹åˆ¤3å’Œä¸‰ç§æƒ…å†µæ˜¯è¦åŠ é”çš„ï¼ˆhchan.lockï¼‰ã€‚ å‘é€é˜Ÿåˆ—ä¸ä¸ºç©º å¦‚æœæ˜¯æ— ç¼“å†²åŒºchannelï¼Œé‚£ä¹ˆç›´æ¥å°†é˜Ÿå¤´å…ƒç´ ä¸­ä¿å­˜çš„å€¼copyç»™å¾…æ¥æ”¶å˜é‡ã€‚\nå¦åˆ™ï¼Œè¯´æ˜channelç¼“å†²åŒºå·²æ»¡ï¼Œéœ€è¦è·å–ç¼“å†²åŒºä¸­ hchan.recvx ç´¢å¼•å¯¹åº”çš„å€¼ï¼Œå¹¶å–å‡ºå‘é€é˜Ÿåˆ—å¤´å…ƒç´ ï¼Œå°†åˆšåˆšç¼“å†²åŒºç´¢å¼•å¯¹åº”ä½ç½®çš„å€¼ç”¨å…ƒç´ ä¸­ä¿å­˜çš„å€¼ä»£æ›¿ï¼Œå¹¶æ›´æ–° recvx ç´¢å¼•åˆ°ä¸‹ä¸€ä¸ªä½ç½®ï¼Œå”¤é†’è¿™ä¸ªæš‚æ­¢çš„å‘é€goroutineï¼Œè§£é”ç›´æ¥è¿”å›ã€‚\nç®€è€Œè¨€ä¹‹ï¼Œå°±ä»ç¼“å†²åŒºå–ä¸€ä¸ªå€¼å¹¶ä»å‘é€é˜Ÿåˆ—é€’è¡¥ã€‚\nç¼“å†²åŒºæœ‰æ•°æ® æ ¹æ® hchan.recvx ç´¢å¼•ä»ç¼“å†²åŒºå–ä¸€ä¸ªå€¼èµ‹ç»™ç­‰å·å·¦è¾¹å¾…æ¥æ”¶å˜é‡ï¼Œæ›´æ–°ç´¢å¼•ï¼Œè§£é”ç›´æ¥è¿”å›ã€‚\nç¼“å†²åŒºæ— æ•°æ® ç»„è£…åŒ…å«å½“å‰gä»¥åŠç›¸å…³ä¿¡æ¯çš„ sudogï¼Œå°†å…¶å…¥é˜Ÿï¼Œå¹¶è°ƒç”¨ gopark æš‚æ­¢å½“å‰çš„gï¼Œç­‰å¾…è¢«å”¤é†’ã€‚\nå…³é—­ å½“å…³é—­ä¸€ä¸ª nil channel æˆ–è€…å…³é—­ä¸€ä¸ªå·²ç»å…³é—­çš„ channel æ—¶ï¼Œpanicã€‚\nå°†æ¥æ”¶å’Œå‘é€é˜Ÿåˆ—ä¸­æ‰€æœ‰ç­‰å¾…ä¸­çš„goroutineå–å‡ºæ¥å”¤é†’ã€‚å…¶ä¸­å‘é€é˜Ÿåˆ—çš„æ‰€æœ‰goroutineéƒ½ä¼španicã€‚\nnil channel æœ‰ä»€ä¹ˆç”¨ï¼Ÿ å¯ä»¥ç”¨æ¥åŠ¨æ€åœ°æ§åˆ¶å“ªäº› case å¯ä»¥åœ¨ select ä¸­è¢«æ‰§è¡Œã€‚é€šè¿‡å°† channel è®¾ç½®ä¸º nil ä¸´æ—¶ç¦ç”¨é€šé“äº¤äº’ã€‚å…·ä½“è§selectå…³é”®å­—\nchannel å¼•å‘çš„èµ„æºæ³„éœ² å¯¹äºä¸€ä¸ªchannelï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•çš„goroutineå¼•ç”¨ï¼Œé‚£ä¹ˆä¼šè¿›è¡ŒGCå°†å…¶å›æ”¶ã€‚\nè€Œå‡ºç°èµ„æºæ³„éœ²æ˜¯å› ä¸ºchannelå¤„äºæ»¡æˆ–ç©ºçš„çŠ¶æ€ï¼Œä¸€ç›´å¾—ä¸åˆ°æ”¹å˜ï¼Œå‘é€æˆ–æ¥æ”¶çš„goroutineä¸€ç›´åœ¨ç­‰å¾…é˜Ÿåˆ—å¾—ä¸åˆ°é‡Šæ”¾ã€‚\nåº”ç”¨ ä¸ Timer ç»“åˆå¯ä»¥å®ç°è¶…æ—¶æ§åˆ¶å’Œå®šæ—¶ä»»åŠ¡ è§£è€¦ç”Ÿäº§æ–¹æ¶ˆè´¹æ–¹ï¼Œå¼‚æ­¥èµ·å‡ ä¸ª worker é€šè¿‡ channel è¯»å–ä»»åŠ¡ é€šè¿‡ç¼“å†²åŒºå¤§å°é™åˆ¶å¹¶å‘æ•° runtime/chan.go å‡ºç°çš„å†…å­˜å¯¹é½æ“ä½œ maxAlign = 8 hchanSize = unsafe.Sizeof(hchan{}) + uintptr(-int(unsafe.Sizeof(hchan{}))\u0026amp;(maxAlign-1)) ä½œç”¨ï¼šå¯¹é½å†…å­˜ï¼Œä½3ä½ä¿è¯ä¸º0ï¼Œå³hchanSizeä¸º8çš„å€æ•°\nmaxAlign-1ä¸ºæ©ç ï¼Œ-int(unsafe.Sizeof(hchan{}))ä¸ºè¡¥ç ï¼Œ\u0026amp;è¿ç®—åªä¿ç•™ä½3ä½bitï¼Œè¿™æ ·åœ¨hchanSizeä½3ä½ä¸Šæ€»ä¸º0\nä¾‹å­\nè¡¨è¾¾å¼ ä¾‹1 ä¾‹2 unsafe.Sizeof(hchan{}) 01101 00101 -int(unsafe.Sizeof(hchan{})) 10011 11011 maxAlign-1 00111 00111 uintptr(-int(unsafe.Sizeof(hchan{}))\u0026amp;(maxAlign-1)) 00011 00011 hchanSize 10000 01000 ","permalink":"http://localhost:1313/posts/golang/channel/","summary":"æ–‡ç« æ·±å…¥è®²è§£Goè¯­è¨€çš„channelåŸç†ï¼ŒåŒ…æ‹¬å…¶åˆ›å»ºã€å‘é€ã€æ¥æ”¶å’Œå…³é—­å››ä¸ªæ“ä½œï¼Œå¹¶è§£ç­”äº†nil channelçš„åº”ç”¨åœºæ™¯å’Œchannelå¯èƒ½å¯¼è‡´çš„èµ„æºæ³„éœ²é—®é¢˜ï¼Œå¯¹å†…å­˜å¯¹é½æ“ä½œè¿›è¡Œäº†è¯´æ˜ã€‚","title":"Go channelåŸç†"},{"content":"I/Oæ¨¡å‹å’Œç½‘ç»œè½®è¯¢å™¨netpoll å‚è€ƒ Javaå¹¶å‘ä¹‹BIO NIO AIO IOå¤šè·¯å¤ç”¨çš„åŒºåˆ«\nç½‘ç»œè½®è¯¢å™¨\nå°æ—coding\né¢è¯•å®˜ï¼šè¯·ä½ è°ˆè°ˆå…³äºIOåŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡çš„åŒºåˆ«ï¼Ÿ\næ½˜å°‘ï¼šGo netpoller åŸç”Ÿç½‘ç»œæ¨¡å‹ä¹‹æºç å…¨é¢æ­ç§˜\näº”ç§I/Oæ¨¡å‹ åŒæ­¥é˜»å¡ I/Oï¼ˆBIOï¼‰ã€åŒæ­¥éé˜»å¡ I/Oï¼ˆNIOï¼‰ã€ä¿¡å·é©±åŠ¨ I/Oï¼ˆSIGIOï¼‰ã€å¼‚æ­¥éé˜»å¡ I/Oï¼ˆAIOï¼‰ ã€I/O å¤šè·¯å¤ç”¨ï¼ˆI/O multiplexingï¼‰\nI/Oä¸¤é˜¶æ®µï¼šç­‰å¾…æ•°æ®å‡†å¤‡ã€å°†æ•°æ®ä»å†…æ ¸ï¼ˆç”¨æˆ·ç¨‹åºï¼‰æ‹·è´åˆ°ç”¨æˆ·ç¨‹åºï¼ˆå†…æ ¸ï¼‰ï¼Œè§ä¸‹å›¾ï¼›\né˜»å¡/éé˜»å¡ï¼šä¸»è¦çœ‹ç¬¬ä¸€æ­¥ï¼Œçº¿ç¨‹åœ¨èµ„æºå°±ç»ªä¹‹å‰æ˜¯å¦éœ€è¦ç­‰å¾…\nåŒæ­¥/å¼‚æ­¥ï¼šä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼Œè¯·æ±‚çº¿ç¨‹åœ¨æ•°æ®ç”¨æˆ·æ€å†…æ ¸æ€ä¹‹é—´çš„æ‹·è´æœŸé—´æ˜¯å¦è¢«é˜»å¡\nlinuxä¸­æ–‡ä»¶æè¿°ç¬¦æ˜¯ä»€ä¹ˆï¼šæ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰å°±æ˜¯å†…æ ¸ä¸ºäº†é«˜æ•ˆç®¡ç†è¿™äº›å·²ç»è¢«æ‰“å¼€çš„æ–‡ä»¶æ‰€åˆ›å»ºçš„ç´¢å¼•ï¼Œå…¶æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼ˆé€šå¸¸æ˜¯å°æ•´æ•°ï¼‰ï¼Œç”¨äºæŒ‡ä»£è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ‰€æœ‰æ‰§è¡ŒI/Oæ“ä½œçš„ç³»ç»Ÿè°ƒç”¨éƒ½é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥å®ç°ã€‚ åŒæ­¥é˜»å¡I/Oï¼ˆBIOï¼‰ æœ€å¸¸è§çš„IOæ¨¡å¼ï¼Œä¾‹å¦‚è¯»å†™æ–‡ä»¶æ—¶æ‰§è¡Œread writeç³»ç»Ÿè°ƒç”¨ã€‚\nä»å¼€å§‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨å¼€å§‹ï¼Œç”¨æˆ·çº¿ç¨‹å°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ç›´åˆ°I/Oæ“ä½œç»“æŸã€‚\nä¼˜ç‚¹ï¼šç®€å•ï¼Œçº¿ç¨‹ç­‰å¾…æœŸé—´åŸºæœ¬ä¸ä¼šå ç”¨CPUèµ„æº ç¼ºç‚¹ï¼šé«˜å¹¶å‘ä¸‹å¤§é‡çº¿ç¨‹è¢«é˜»å¡ï¼Œå¯¼è‡´å†…å­˜å’Œçº¿ç¨‹åˆ‡æ¢å¼€é”€å·¨å¤§ åŒæ­¥éé˜»å¡I/Oï¼ˆNIOï¼‰ ç”¨æˆ·ç¨‹åºä¼šä¸æ–­è½®è¯¢å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œç›´åˆ°å†…æ ¸ä¸­èµ„æºå‡†å¤‡å°±ç»ªï¼Œå†å®ŒæˆI/Oæ“ä½œã€‚\nä¼˜ç‚¹ï¼šå¯ä»¥åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæé«˜ CPU åˆ©ç”¨ç‡ ç¼ºç‚¹ï¼šéœ€è¦ä¸æ–­è½®è¯¢å ç”¨å¤§é‡ CPU æ—¶é—´ï¼Œä¸”è½®è¯¢é—´éš”å¯èƒ½ä¼šæ”¾å¤§å“åº”å»¶è¿Ÿï¼Œé™ä½æ•´ä½“æ•°æ®ååé‡ å¼‚æ­¥éé˜»å¡I/Oï¼ˆAIOï¼‰ ç”¨æˆ·çº¿ç¨‹åªéœ€è¦è´Ÿè´£å‘å†…æ ¸å‘é€ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¯·æ±‚ï¼Œç­‰å¾…æ•°æ®å°±ç»ªå’Œæ•°æ®æ‹·è´çš„è¿‡ç¨‹éƒ½ç”±å†…æ ¸æ¥å®Œæˆï¼Œå®Œæˆåå†…æ ¸é€šè¿‡ä¿¡å·æˆ–å›è°ƒå‡½æ•°é€šçŸ¥ç”¨æˆ·çº¿ç¨‹I/Oæ“ä½œå®Œæˆã€‚\nä¼˜ç‚¹ï¼šå‡å°‘äº† NIO ä¸­è½®è¯¢å ç”¨çš„ CPU èµ„æºï¼Œä¸”å‡å°‘äº†å“åº”å»¶è¿Ÿ ç¼ºç‚¹ï¼šå¤æ‚ï¼Œå›è°ƒå‡½æ•°å ç”¨ç³»ç»Ÿèµ„æºï¼Œä½¿ç”¨ä¿¡å·é€šä¿¡å¤šå¹³å°å¯ç§»æ¤æ€§å·® å¤šè·¯å¤ç”¨ äº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œä½¿ç”¨ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨ï¼ˆselectã€pollã€epollç­‰ï¼‰é˜»å¡åœ°ç›‘å¬ä¸€ç»„æ–‡ä»¶æè¿°ç¬¦ï¼Œå½“æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼ˆçŠ¶æ€è½¬å˜ä¸ºå¯è¯»æˆ–è€…å¯å†™ï¼‰æ—¶ï¼Œé€šçŸ¥ç¨‹åºç»§ç»­è¿›è¡Œç›¸åº”çš„I/Oæ“ä½œã€‚\nå¤šè·¯å¤ç”¨ä¹Ÿå±äºåŒæ­¥ç­–ç•¥ï¼Œä¸NIOæ¯”è¾ƒç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯ç”±ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨è´Ÿè´£å»è½®è¯¢èµ„æºæ˜¯å¦å°±ç»ªï¼Œè€Œä¸æ˜¯ç”¨æˆ·çº¿ç¨‹äº²åŠ›äº²ä¸º\nä¸ºä»€ä¹ˆå±äºåŒæ­¥ç­–ç•¥ï¼šç‰¹å®šç³»ç»Ÿè°ƒç”¨åªè´Ÿè´£å‘Šè¯‰ç”¨æˆ·ç¨‹åºèµ„æºæ˜¯å¦å°±ç»ªï¼Œè€Œï¼ˆåœ¨readè°ƒç”¨ä¸­ï¼‰æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°ç”¨æˆ·å†…å­˜çš„æ“ä½œè¿˜æ˜¯ç”±ç”¨æˆ·ç¨‹åºå‘é€ç³»ç»Ÿè°ƒç”¨è§¦å‘\nä¸ºä»€ä¹ˆå¯ä»¥å¤„ç†å¤§é‡è¿æ¥ï¼šNIOä¸€ä¸ªè¯·æ±‚éœ€è¦ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ï¼Œè€Œå¤šè·¯å¤ç”¨åˆ™æ˜¯åšåˆ°äº†å¤šè·¯è¯·æ±‚å¤ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤§å¤§å‡å°‘äº†èµ„æºå ç”¨\nä¼˜ç‚¹ï¼šå¯ä»¥åŒæ—¶å¤„ç†å¤§é‡è¿æ¥ï¼Œå‡å°ç³»ç»Ÿå¼€é”€ï¼Œå“åº”æ€§èƒ½å¥½ ç¼ºç‚¹ï¼šselectå’Œpolléƒ½ä½¿ç”¨çº¿æ€§ç»“æ„ï¼ˆæ•°ç»„å’Œé“¾è¡¨ï¼‰å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œéœ€è¦æ‹·è´åˆ°å†…æ ¸å†…å­˜å¼€é”€å¤§ï¼Œè¿”å›å°±ç»ªäº‹ä»¶éœ€è¦éå†æ—¶é—´å¤æ‚åº¦é«˜ï¼Œselectè¿˜æœ‰æ•°ç»„å¤§å°é™åˆ¶ æ­¤å¤–ï¼Œç”±äºç‰¹å®šç³»ç»Ÿè°ƒç”¨æ˜¯è½®è¯¢çš„å¹¶ä¸”æ‹·è´æ•°æ®çš„æ—¶å€™ç”¨æˆ·çº¿ç¨‹ä¹Ÿæ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥å¤šè·¯å¤ç”¨åªæœ‰åœ¨å¤„ç†é«˜å¹¶å‘è¯·æ±‚çš„æ—¶å€™æ‰èƒ½ä½“ç°æ€§èƒ½ä¼˜åŠ¿ã€‚\nepoll epollè§£å†³äº†selectã€pollå­˜åœ¨çš„å†…å­˜å¼€é”€å’Œæ—¶é—´å¤æ‚åº¦é—®é¢˜\nepollä½¿ç”¨çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„è¿½è¸ªæ‰€æœ‰å¾…æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯æ¬¡åªéœ€è¦åŠ å…¥ä¸€ä¸ªå¾…æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œä¸åƒselectã€pollä¸€æ ·æ¯æ¬¡æ“ä½œéƒ½ç©¿å…¥æ•´ä¸ªé›†åˆï¼ŒåŠ å…¥æ—¶é—´å¤æ‚åº¦O(logn)\nç»´æŠ¤waité“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶ï¼Œè€Œä¸æ˜¯éå†æ•´ä¸ªé›†åˆ\näº‹ä»¶é©±åŠ¨ è¾¹ç¼˜è§¦å‘ï¼šå½“è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šç¬¬ä¸€æ¬¡å‡ºç°äº‹ä»¶å°±ç»ªæ—¶ï¼Œé€šçŸ¥ç”¨æˆ·ç¨‹åº æ°´å¹³è§¦å‘ï¼šå½“è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šå­˜åœ¨å°±ç»ªäº‹ä»¶ï¼Œé€šçŸ¥ç”¨æˆ·ç¨‹åº goä¸­çš„ç½‘ç»œè½®è¯¢å™¨netpoll netpollçš„å®ç°åŸç†æ˜¯å¤šè·¯å¤ç”¨+NIOï¼ˆè§æœ€åæ€»ç»“éƒ¨åˆ†ï¼‰ï¼Œgoä¸­ä½¿ç”¨åŸç”Ÿç½‘ç»œæ¨¡å‹æ„å»ºtcp serveræ—¶ï¼Œç½‘ç»œæ¨¡å‹åº•å±‚å°±æ˜¯åŸºäºnetpollå®ç°çš„\ngoä¸­ä½¿ç”¨ runtime.pollDesc å°è£…æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç©ºé—²æè¿°ç¬¦ä»¥é“¾è¡¨å½¢å¼å­˜å‚¨ã€‚\näº”ä¸ªå‡½æ•°\nfunc netpollinit() // åˆ›å»ºå®ä¾‹ func netpollopen(fd uintptr, pd *pollDesc) int32 // æ³¨å†Œfd func netpoll(delta int64) gList // ç­‰å¾…äº‹ä»¶æ“ä½œ func netpollBreak() // åœæ­¢epoll func netpollIsPollDescriptor(fd uintptr) bool // åˆ¤æ–­fdæ˜¯å¦è¢«netpollä½¿ç”¨ goä¸­é’ˆå¯¹ä¸åŒå¹³å°é‡‡ç”¨äº†ä¸åŒç‰ˆæœ¬çš„ç½‘ç»œè½®è¯¢æ¨¡å—ï¼Œlinux-epollï¼Œdarwin-kqueue\u0026hellip;ä¸‹é¢ä»¥epollä¸ºä¾‹ã€‚\nåˆå§‹åŒ– netpollinit å‡½æ•°åªä¼šåœ¨åˆå§‹åŒ–ç½‘ç»œIOæˆ–æ–‡ä»¶IOæˆ–è®¡æ—¶å™¨æ—¶è°ƒç”¨ä¸€æ¬¡ï¼ˆsync.Onceæ¥å®ç°ï¼‰ï¼Œå…¶ä½œç”¨æ˜¯ï¼š\nåˆ›å»ºä¸€ä¸ªæ–°çš„epollæ–‡ä»¶æè¿°ç¬¦ åˆ›å»ºä¸€ä¸ªç”¨äºé€šä¿¡çš„ç®¡é“ å°† netpollBreakRd é€šçŸ¥ä¿¡å·é‡å°è£…æˆ epollevent äº‹ä»¶ç»“æ„ä½“æ³¨å†Œè¿› epoll å®ä¾‹ã€‚ netpollBreakRd æ˜¯ä¸€ä¸ªç”¨äºä¼ é€’æ§åˆ¶ä¿¡å·çš„ç®¡é“ï¼Œç›‘å¬è¿™ä¸ªäº‹ä»¶çš„ç›®çš„æ˜¯ä¸ºäº†å®ç°ç½‘ç»œè½®è¯¢çš„ç»ˆæ­¢ã€‚ ç„¶åï¼Œä¼šæ‰¹é‡åˆå§‹åŒ–pollDescå¹¶è°ƒç”¨ netpollopen å‡½æ•°æ³¨å†Œè½®è¯¢äº‹ä»¶ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚netåŒ…ä¸­çš„listener fdï¼‰åˆ°epollå®ä¾‹\nç­‰å¾…äº‹ä»¶ å½“åœ¨æ–‡ä»¶æè¿°ç¬¦ä¸Šæ‰§è¡Œè¯»å†™æ“ä½œæ—¶ï¼ˆå¦‚netåŒ…ä¸­å¯¹è¯·æ±‚Readæˆ–Writeï¼‰ï¼Œä¼šè°ƒç”¨runtime.poll_runtime_pollWaitï¼š\næ£€æŸ¥æè¿°ç¬¦çŠ¶æ€ï¼Œå¦‚æœfdä¸å¯è¯»/å†™ï¼Œåˆ™ä¼šæ‰§è¡Œgoparkè®©å‡ºå½“å‰çº¿ç¨‹ï¼Œå°†Goroutineè½¬æ¢åˆ°ä¼‘çœ çŠ¶æ€ã€‚ å°†goroutineä¿å­˜åœ¨pollDescä¸­ï¼ˆpollDescæ˜¯goå°è£…çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œå°†pollDescåŠ å…¥epollåº•å±‚åŸºäºçº¢é»‘æ ‘çš„é˜»å¡é˜Ÿåˆ—eventpoll.rbrä¸­ã€‚ ç­‰å¾…æè¿°ç¬¦å˜ä¸ºå¯è¯»æˆ–å¯å†™ä¹‹åé€šçŸ¥è¿è¡Œæ—¶ï¼Œå”¤é†’ä¼‘çœ çš„Goroutineã€‚ è½®è¯¢ç­‰å¾… è°ƒç”¨netpollå‡½æ•°è·å–éœ€è¦å”¤é†’çš„goroutinesï¼š\næ ¹æ®ä¼ å…¥çš„å‚æ•°ç¡®å®šepollç³»ç»Ÿè°ƒç”¨éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼ˆæ°¸ä¹…é˜»å¡ã€éé˜»å¡ã€æœ‰é™æœŸé˜»å¡ï¼‰ã€‚ é€šè¿‡epollwait ç³»ç»Ÿè°ƒç”¨è·å–å¾…å¤„ç†äº‹ä»¶çš„æ•°é‡ã€‚ æ ¹æ®è¿”å›çš„å¾…å¤„ç†äº‹ä»¶æ•°é‡å°†eveentpoll.rdllistå°±ç»ªé“¾è¡¨ä¸­çš„é¢æ‰€æœ‰pollDescä¸­å­˜å‚¨çš„GoroutineåŠ å…¥è¿è¡Œé˜Ÿåˆ—ï¼ˆæœ¬åœ°æˆ–å…¨å±€ï¼‰ç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚ åŸç”Ÿç½‘ç»œåº“ è°ƒåº¦è¿‡ç¨‹ netpollçš„ä»·å€¼ å‰ç½®çŸ¥è¯†ï¼š\nå½“ä¸€ä¸ªè¿è¡Œçš„ G å‘ç”Ÿç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¸åªæ˜¯ G ä¼šè¢«é˜»å¡ï¼Œæ‰§è¡Œè¯¥ G çš„ M ä¹Ÿä¼šè¢«é˜»å¡ï¼Œ goå¹¶å‘çš„ä¼˜åŠ¿å°±åœ¨äºå°†ä»»åŠ¡çš„æ‰§è¡Œè½½ä½“ç»†åŒ–åˆ°äº†ç”¨æˆ·çº§çš„ G ä¸ä½¿ç”¨netpollä¼šå­˜åœ¨çš„é—®é¢˜ï¼š\nå¯¹äºI/Oå¯†é›†å‹ä»»åŠ¡ï¼Œå¤§é‡ç³»ç»Ÿè°ƒç”¨ä¼šå¯¼è‡´ M é¢‘ç¹çš„æŒ‚èµ·ã€æ–°å»ºã€å”¤é†’ï¼ŒèƒŒç¦»äº†golangè¿è¡Œæ—¶è°ƒåº¦çš„è®¾è®¡æ€æƒ³ï¼Œå³ç¨‹åºçš„æ§åˆ¶æƒæŒæ¡åœ¨ç”¨æˆ·è¿›ç¨‹è€Œä¸æ˜¯å†…æ ¸ï¼Œå¯¼è‡´æ— æ³•ä½¿ç”¨å¼ºå¤§çš„è°ƒåº¦å™¨è¿›è¡Œå¹¶å‘è°ƒåº¦äº† netpollçš„ä»·å€¼ï¼š\nå‘ç”Ÿç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¿è¡Œæ—¶å°† G parkä½å¹¶å°†åŒ…è£…åçš„æè¿°ç¬¦åŠ å…¥epollç­‰å¾…å°±ç»ªï¼Œé¿å…äº†å› ä¸ºé™·å…¥å†…æ ¸æ€å¯¼è‡´ M è¢«é˜»å¡ï¼Œå› æ­¤è¿™ä¸ª M è¿˜å¯ä»¥ç»§ç»­é…åˆè°ƒåº¦å™¨è¿è¡Œæ–°çš„ Gã€‚ æ€»ç»“ ä¸ºä»€ä¹ˆè¯´ netpoll æ˜¯ NIO + å¤šè·¯å¤ç”¨ï¼Ÿ NIOæŒ‡çš„æ˜¯å¯¹äºçº¿ç¨‹ Mï¼Œå‘ç”ŸI/Oæ“ä½œæ—¶ä¸ä¼šå› ä¸ºç³»ç»Ÿè°ƒç”¨è€Œè¢«é˜»å¡\nå¤šè·¯å¤ç”¨æŒ‡çš„æ˜¯æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œä½¿ç”¨æä¾›çš„ epollã€kqueueç­‰å¤šè·¯å¤ç”¨æŠ€æœ¯\nnetpollä¼˜åŠ¿ ä¿è¯äº†åœ¨I/Oå¯†é›†å‹æœåŠ¡ä¸­ï¼Œgoä¾æ—§å¯ä»¥å®ç°åœ¨è¿è¡Œä¸­è¿›è¡Œç”¨æˆ·çº§è°ƒåº¦ï¼Œæé«˜äº†å¹¶å‘èƒ½åŠ›ï¼Œå‡å°‘äº†ç³»ç»Ÿèµ„æºå ç”¨\nnetpollå­˜åœ¨çš„é—®é¢˜ æœåŠ¡å™¨åœ¨çŸ­æ—¶é—´å†…å»ºç«‹äº†æµ·é‡è¿æ¥ï¼Œä¼šå¯¼è‡´åˆ›å»ºå¤§é‡çš„goroutineï¼Œè¿‡å¤šçš„æ¶ˆè€—ç³»ç»Ÿèµ„æºã€‚\nè§£å†³åŠæ³•ï¼šReactoræ¨¡å‹\n","permalink":"http://localhost:1313/posts/golang/netpoll/","summary":"Netpollæ˜¯Goè¯­è¨€ä¸­çš„ç½‘ç»œè½®è¯¢å™¨ï¼Œé‡‡ç”¨NIOå’Œå¤šè·¯å¤ç”¨çš„æœºåˆ¶ï¼Œä¿è¯äº†åœ¨I/Oå¯†é›†å‹æœåŠ¡ä¸­ï¼Œèƒ½å¤Ÿè¿›è¡Œç”¨æˆ·çº§è°ƒåº¦ï¼Œæé«˜å¹¶å‘èƒ½åŠ›ï¼Œå‡å°‘ç³»ç»Ÿèµ„æºå ç”¨ã€‚ç„¶è€Œï¼Œå¦‚æœæœåŠ¡å™¨åœ¨çŸ­æ—¶é—´å†…å»ºç«‹äº†å¤§é‡è¿æ¥ï¼Œå¯èƒ½å¯¼è‡´åˆ›å»ºè¿‡å¤šçš„goroutineï¼Œæ¶ˆè€—ç³»ç»Ÿèµ„æºã€‚","title":"I/O ä¸ Go ç½‘ç»œè½®è¯¢å™¨"},{"content":"init å‚è€ƒ ä¸€æ–‡è¯»æ‡‚ Golang init å‡½æ•°æ‰§è¡Œé¡ºåº\nç‰¹ç‚¹ å¯é€‰çš„ï¼Œæ— å…¥å‚å’Œè¿”å›å€¼ï¼Œè‡ªåŠ¨æ‰§è¡Œä¸èƒ½è¢«è°ƒç”¨ï¼Œæ²¡æœ‰æ•°é‡é™åˆ¶\nè°ƒç”¨é¡ºåº åŒä¸€åŒ… åŒä¸€æºæ–‡ä»¶ åŒä¸€æ–‡ä»¶ä¸­æœ‰å¤šä¸ªinitå‡½æ•°ï¼Œä»ä¸Šåˆ°ä¸‹æ‰§è¡Œ\nä¸åŒæºæ–‡ä»¶ æ ¹æ®æ–‡ä»¶åçš„å­—å…¸åºç¡®å®šæ‰§è¡Œé¡ºåº\nä¸åŒåŒ… æ— ä¾èµ–å…³ç³» æŒ‰ç…§main.goä¸­importé¡ºåºåˆ†åˆ«è°ƒç”¨åŒ…çš„initï¼Œæœ€åå†è°ƒç”¨mainåŒ…çš„initã€‚å¦‚æœæ²¡æœ‰è¢«importï¼Œåˆ™åŒ…ä¸­çš„initä¸ä¼šæ‰§è¡Œ\næ— ä¾èµ–å…³ç³»æŒ‡åŒ…ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œåœ¨mainæ–‡ä»¶ä¸­è¢«importï¼Œå¹¶ä½¿ç”¨å ä½ç¬¦\u0026rsquo;_\u0026lsquo;æ¥æ”¶ï¼šimport _ \u0026quot;proj/a\u0026quot; æœ‰ä¾èµ–å…³ç³» ä»ä¾èµ–æœ€åº•å±‚çš„åŒ…ä¸€å±‚å±‚å‘ä¸Šè°ƒç”¨ï¼Œä¾‹å¦‚ï¼šmain \u0026gt; a \u0026gt; b \u0026gt; cï¼Œinité¡ºåºåº”ä¸º c \u0026gt; b \u0026gt; a \u0026gt; main\né¡¹ç›®åˆå§‹åŒ–æµç¨‹ åŒ…å†…ï¼šå¸¸é‡ \u0026gt; å˜é‡ \u0026gt; init\næ•´ä½“ï¼šä»ä¾èµ–æœ€åº•å±‚çš„åŒ…é€å±‚å‘ä¸Šåˆå§‹åŒ–\nå†™è¿‡çš„bug åŒä¸€ä¸ªåŒ…ï¼Œä¸»å‡½æ•°è¯»å–å‘½ä»¤è¡Œå‚æ•°ç¡®å®šå…¨å±€å˜é‡ isProd çš„å€¼ï¼Œè€Œrediså’Œpgå®¢æˆ·ç«¯çš„åˆå§‹åŒ–æ”¾åœ¨äº†å„è‡ªçš„initå‡½æ•°ä¸­ï¼Œå¯¼è‡´å…¨å±€å˜é‡çš„æ”¹å˜æ²¡æœ‰è¢«initå‡½æ•°ä½¿ç”¨ã€‚ï¼ˆå³ä½¿å½“è¯»å–å‚æ•°çš„ä»£ç æ”¾åœ¨main.goçš„initä¸­ï¼Œå­—å…¸åºå°äºmainçš„æ‰€æœ‰goæ–‡ä»¶ä¸­çš„initå‡½æ•°éƒ½ä¸èƒ½æ„ŸçŸ¥åˆ°main.goä¸­è¯»å–åˆ°çš„å‚æ•°ï¼‰\n","permalink":"http://localhost:1313/posts/golang/init/","summary":"ä»‹ç»äº†initå‡½æ•°çš„ç‰¹ç‚¹ã€è°ƒç”¨é¡ºåºå’Œé¡¹ç›®åˆå§‹åŒ–æµç¨‹ã€‚","title":"Go initå‡½æ•°"},{"content":"Collector å‚è€ƒ dravenessåƒåœ¾æ”¶é›†å™¨\ngoè¯­è¨€åŸæœ¬-åƒåœ¾å›æ”¶\ngoç¨‹åºå‘˜é¢è¯•ç¬”è¯•å®å…¸-åƒåœ¾å›æ”¶å™¨20é—®\næ¸è¿›å¼åƒåœ¾å›æ”¶-CSDN\nå¥‡ä¼¢äº‘å­˜å‚¨-golangæ··åˆå†™å±éšœ\nè®¾è®¡åŸåˆ™ åƒåœ¾æ”¶é›†ç®—æ³• è¿½è¸ªå¼ï¼šä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œä¸€æ­¥æ­¥æ‰«æå›æ”¶å¯¹è±¡\nå¼•ç”¨è®¡æ•°å¼ï¼šå¯¹è±¡è‡ªèº«åŒ…å«ä¸€ä¸ªè¢«å¼•ç”¨çš„è®¡æ•°å™¨\næ ¹å¯¹è±¡æ˜¯ä»€ä¹ˆï¼šå…¨å±€å˜é‡ã€æ‰§è¡Œæ ˆã€å¯„å­˜å™¨ åˆ†ä»£å¼ æ ¹æ®å¯¹è±¡çš„å­˜æ´»æ—¶é—´è¿›è¡Œåˆ†ç±»ã€‚ï¼ˆJAVAï¼šå¹´è½»ä»£ã€è€å¹´ä»£ã€æ°¸ä¹…ä»£ï¼‰\nä¼˜ç‚¹ï¼šç›¸æ¯”ä¼ ç»Ÿæ ‡è®°æ¸…é™¤ STW æ›´å°ï¼Œåˆ†ä»£é€‰å–ä¸åŒåƒåœ¾æ”¶é›†ç­–ç•¥ï¼Œæ•ˆç‡é«˜ã€‚ ç¼ºç‚¹ï¼šé¢å¤–å¼€é”€ï¼Œå†…å­˜å ç”¨ï¼Œä¸”golangä¸­ç¼–è¯‘å™¨ä¼šé€šè¿‡é€ƒé€¸åˆ†æå°†å¤§éƒ¨åˆ†æ–°ç”Ÿå¯¹è±¡å­˜å‚¨åœ¨æ ˆä¸Šï¼ˆæ ˆç›´æ¥è¢«å›æ”¶ï¼‰ï¼Œå› æ­¤æ²¡å¿…è¦ã€‚ æ ‡è®°æ¸…é™¤ ä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œå°†ç¡®å®šå­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œå¹¶æ¸…æ‰«å¯ä»¥å›æ”¶çš„å¯¹è±¡ã€‚\nä¼˜ç‚¹ï¼šç®€å• ç¼ºç‚¹ï¼šéœ€è¦é•¿æ—¶é—´ STW ä¸‰è‰²æ ‡è®°æ¸…é™¤ ä¼˜åŒ–çš„æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œå°†å¯¹è±¡åˆ†ä¸ºä¸‰ç±»ï¼šé»‘ã€ç™½ã€ç°ï¼Œä¿è¯ä¸ç”¨æˆ·ç¨‹åºå¹¶å‘æ‰§è¡Œæ—¶ç¨‹åºçš„æ­£ç¡®æ€§ï¼ˆå¯¹è±¡ä¸ä¼šè¢«é”™è¯¯å›æ”¶ï¼‰\nä¼˜ç‚¹ï¼šåˆ©ç”¨å¹¶å‘çš„ä¼˜åŠ¿ï¼Œå¤§å¹…å‡å° STW æ—¶é—´ ç¼ºç‚¹ï¼šå¤æ‚ï¼Œéœ€è¦é…åˆå±éšœæŠ€æœ¯ï¼Œå¦åˆ™ä¼šå‡ºç°æ‚¬æŒ‚æŒ‡é’ˆé—®é¢˜ï¼ˆä¸€ä¸ªè¿˜åœ¨ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡è¢«é”™è¯¯å›æ”¶äº†ï¼‰ æ”¶é›†ç­–ç•¥ å¹¶å‘å’Œå¢é‡ç­–ç•¥éƒ½éœ€è¦é…åˆå±éšœæŠ€æœ¯ä¿è¯å›æ”¶çš„æ­£ç¡®æ€§\nå¢é‡ å¢é‡å¼æ”¶é›†æ˜¯å°†ä¸€ä¸ªå®Œæ•´çš„ GC è¿‡ç¨‹åˆ‡æˆå¤šä¸ªæ›´å°çš„ GC æ—¶é—´ç‰‡ï¼Œç©¿æ’åœ¨ç”¨æˆ·ç¨‹åºä¹‹é—´æ‰§è¡Œï¼Œåœ¨æ‰§è¡Œæ—¶ä»éœ€è¦ STWã€‚ ç›®çš„ï¼šå‡å°‘äº†æ¯æ¬¡ STW ç”¨æˆ·ç¨‹åºéœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼Œå°†æ€»ç­‰å¾…æ—¶é—´åˆ†æ•£åˆ°å¤šä¸ªæ—¶é—´ç‰‡ä¸­ã€‚ å¹¶å‘ åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿åœ¨éƒ¨åˆ†é˜¶æ®µä¸ç”¨æˆ·ç¨‹åºå¹¶è¡Œæ‰§è¡Œ ç›®çš„ï¼šå‡å°‘äº†æ€»çš„ STW æ—¶é—´ ä¸‰è‰²æŠ½è±¡ æ¦‚å¿µ ä¸‰ç±»å¯¹è±¡ï¼š\nç™½è‰²å¯¹è±¡ï¼šæœªè¢«å›æ”¶å™¨æ‰«æåˆ°çš„å¯¹è±¡ã€‚å›æ”¶å¼€å§‹é˜¶æ®µå…¨éƒ¨å¯¹è±¡éƒ½ä¸ºç™½è‰²ï¼Œæ‰«æç»“æŸåå­˜åœ¨çš„ç™½è‰²å¯¹è±¡ä¸ºä¸å¯è¾¾å¯¹è±¡ã€‚ ç°è‰²å¯¹è±¡ï¼šå·²ç»è¢«å›æ”¶å™¨æ‰«æä½†å­˜åœ¨æŒ‡é’ˆæŒ‡å‘ä¸€äº›è¿˜æ²¡è¢«æ‰«æç™½è‰²å¯¹è±¡ã€‚ï¼ˆæ³¢é¢ï¼‰ é»‘è‰²å¯¹è±¡ï¼šå¯¹è±¡æœ¬èº«ä»¥åŠå…¶æ‰€æœ‰æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡éƒ½è¢«æ‰«æè¿‡ï¼Œç¡®å®šå­˜æ´»çš„å¯¹è±¡ã€‚ ä¸‰è‰²ä¸å˜æ€§ æƒ³è¦åœ¨å¹¶å‘æˆ–è€…å¢é‡çš„æ ‡è®°ç®—æ³•ä¸­ä¿è¯æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬éœ€è¦è¾¾æˆä»¥ä¸‹ä¸¤ç§ä¸‰è‰²ä¸å˜æ€§ï¼ˆTri-color invariantï¼‰ä¸­çš„ä¸€ç§ï¼š\nå¼ºä¸‰è‰²ä¸å˜æ€§ â€” é»‘è‰²å¯¹è±¡ä¸ä¼šæŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œåªä¼šæŒ‡å‘ç°è‰²å¯¹è±¡æˆ–è€…é»‘è‰²å¯¹è±¡ï¼›ï¼ˆé»‘è‰²ä¸èƒ½æŒ‡å‘ç™½è‰²ï¼‰ å¼±ä¸‰è‰²ä¸å˜æ€§ â€” é»‘è‰²å¯¹è±¡æŒ‡å‘çš„ç™½è‰²å¯¹è±¡å¿…é¡»åŒ…å«ä¸€æ¡ä»ç°è‰²å¯¹è±¡ç»ç”±å¤šä¸ªç™½è‰²å¯¹è±¡çš„å¯è¾¾è·¯å¾„ï¼›ï¼ˆé»‘è‰²å¯ä»¥æŒ‡å‘ç™½è‰²ï¼Œå‰ææ˜¯å¿…é¡»è¦æœ‰å¦å¤–çš„ç°è‰²å¯¹è±¡ç›´æ¥æˆ–é—´æ¥æŒ‡å‘è¿™ä¸ªç™½è‰²ï¼‰ ä¸ºä»€ä¹ˆè¦ä¸‰ä¸ªè‰²ï¼Ÿ ä¸ºäº†é…åˆå±éšœæŠ€æœ¯ï¼Œä¿è¯åœ¨å¹¶å‘æˆ–è€…å¢é‡æ‰§è¡Œæ—¶ä¸ä¼šå‡ºç°æ‚¬æŒ‚æŒ‡é’ˆï¼ˆæœ¬æ¥ä¸åº”è¯¥è¢«å›æ”¶çš„å¯¹è±¡å´è¢«å›æ”¶äº†ï¼‰ã€‚\nå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯è¦ä¿è¯è¾¾æˆè‡³å°‘ä¸€ç§ä¸‰è‰²ä¸å˜æ€§ã€‚\nå±éšœæŠ€æœ¯ æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œä½¿ç”¨æˆ·ç¨‹åºåœ¨è¿›è¡ŒæŒ‡é’ˆå†™æ“ä½œæ—¶ï¼Œèƒ½å¤Ÿâ€œé€šçŸ¥â€å›æ”¶å™¨ï¼Œè¿›è€Œä¸ä¼šç ´åä¸‰è‰²ä¸å˜æ€§ï¼Œä¿è¯åœ¨å¢é‡æˆ–å¹¶å‘å›æ”¶æ—¶ç¨‹åºçš„æ­£ç¡®æ€§\nDijkstra æ’å…¥å†™å±éšœ åœ¨ä¿®æ”¹å¼•ç”¨æ—¶ï¼Œå°†æ–°æŒ‡å‘çš„å¯¹è±¡ç½®ç°ã€‚æ¢å¥è¯è¯´ï¼Œç›®çš„æ˜¯å°†æœ‰å­˜æ´»å¯èƒ½çš„å¯¹è±¡éƒ½æ ‡è®°æˆç°è‰²\nwritePointer(slot, ptr): shade(ptr) *slot = ptr slotæ˜¯ä»£ç ä¸­çš„æ¥æ”¶ä½ç½®ï¼ˆdestinationï¼‰ï¼Œptræ˜¯è¢«æŒ‡å‘çš„å¯¹è±¡ï¼Œptréœ€è¦è¿›å…¥slotä¸­ï¼ˆgoes into the slotï¼‰\nå¦‚å›¾æ‰€ç¤ºï¼Œç”¨æˆ·ç¨‹åºä¿®æ”¹Açš„æŒ‡é’ˆï¼Œå°†å…¶æŒ‡å‘Cï¼Œè¿™æ—¶å†™å±éšœè§¦å‘å°†Cæ ‡è®°ä¸ºç°è‰²ï¼Œåœ¨æ”¶é›†å™¨å¯åŠ¨æ—¶ï¼Œå°†ä»B C ä¸¤ä¸ªå¯¹è±¡å‡ºå‘è¿›è¡Œæ‰«æã€‚\nä¿è¯äº†å¼ºä¸‰è‰²ä¸å˜æ€§ã€‚ æ˜¯ä¸€ç§ä¿å®ˆçš„å±éšœæŠ€æœ¯ã€‚ å¯èƒ½ä¼šé—ç•™ä¸å†å­˜æ´»çš„å¯¹è±¡ï¼Œå¦‚å›¾ä¸­çš„Bï¼Œæˆ–è€…å½“å›¾ä¸­ç¬¬äºŒä¸‰æ­¥é—´é‡æ–°æ”¹å˜AæŒ‡å‘Båçš„Cã€‚ æ ˆä¸Šå¯¹è±¡ä¹Ÿéœ€è¦ä¿è¯å›æ”¶æ­£ç¡®æ€§ï¼Œå› æ­¤éœ€è¦ä¸ºæ ˆå¯¹è±¡æ·»åŠ å†™å±éšœæˆ–STWå¹¶é‡æ–°æ‰«ææ ˆä¸Šå¯¹è±¡ï¼ŒGO1.7ç‰ˆæœ¬ä»¥å‰é‡‡ç”¨äº†åè€…ã€‚ Yuasa åˆ é™¤å†™å±éšœ åœ¨åˆ é™¤å¼•ç”¨æ—¶ï¼Œå¦‚æœåŸæ¥æŒ‡å‘çš„å¯¹è±¡ä¸ºç™½è‰²ï¼Œåˆ™å°†å…¶ç½®ç°ã€‚ç›®çš„æ˜¯é—´æ¥ä¿ç•™åŸæœ‰çš„å¼•ç”¨å…³ç³»ä½¿å¾—æ‰«æå¯ä»¥è¿›è¡Œä¸‹å»ã€‚\nwritePointer(slot, ptr) shade(*slot) *slot = ptr ç¬¬äºŒæ­¥ç”±äºBæœ¬æ¥å°±æ˜¯ç°è‰²çš„ï¼Œæ‰€ä»¥ä¸ç”¨æ”¹ï¼›ç¬¬ä¸‰æ­¥å°†BæŒ‡å‘Cçš„å¼•ç”¨åˆ é™¤ï¼Œè¿™æ—¶å¦‚æœä¸å°†CæŸ“æˆç°è‰²ï¼Œåç»­æ”¶é›†å™¨å°±ä¸ä¼šæ‰«æç™½è‰²çš„Cå’ŒDï¼Œäºæ˜¯CDè¢«é”™è¯¯çš„å›æ”¶äº†ã€‚\nå¦‚æœç¬¬äºŒæ­¥ A æŒ‡å‘äº†å¦å¤–ä¸€ä¸ªç‹¬ç«‹çš„ç™½è‰²å¯¹è±¡ E å²‚ä¸æ˜¯å‡ºé”™äº†ï¼Ÿ è¿™ç§æƒ…å†µä¸å¯èƒ½å‡ºç°ï¼ŒåŸå› è§ä¸‹è¾¹ç¬¬ä¸‰ç‚¹ã€‚ ä¿è¯äº†å¼±ä¸‰è‰²ä¸å˜æ€§ã€‚ åŒæ ·ä¼šé—ç•™ä¸å†å­˜æ´»çš„å¯¹è±¡ã€‚ ã€very importantï¼ã€‘æŒ‡é’ˆæ›´æ–°ä¸€å®šæ˜¯ä»ä¸€ä¸ªæ´»åŠ¨å¯¹è±¡æŒ‡å‘å¦ä¸€ä¸ªæ´»åŠ¨å¯¹è±¡ï¼Œå› ä¸ºéæ´»åŠ¨å¯¹è±¡æ˜¯æ²¡æœ‰ä»»ä½•æŒ‡é’ˆå¼•ç”¨çš„ï¼Œç”¨æˆ·ç¨‹åºä¸å¯èƒ½å†å¼•ç”¨åˆ°å®ƒã€‚æ¢å¥è¯è¯´ï¼Œä¸å¯èƒ½æ–°å¢ä¸€ä¸ªæŒ‡å‘å­¤ç«‹çš„ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ æ··åˆå†™å±éšœ æ’å…¥å’Œåˆ é™¤å†™å±éšœéƒ½å­˜åœ¨çš„é—®é¢˜ï¼šå¯¹æ ˆå¯¹è±¡åŠ å±éšœä¸¥é‡æ‹–ç´¯æ€§èƒ½ï¼Œå°¤å…¶å¯¹äºgoæ¥è¯´ï¼ˆgoroutineå¯ä»¥å¾ˆå¤šï¼‰\nå¦‚æœä¸å¯¹æ ˆå¯¹è±¡åŠ å±éšœï¼Œé‚£ä¹ˆä¼šå¯¼è‡´çš„é—®é¢˜ï¼š\nåªç”¨æ’å…¥å±éšœï¼šä¸€ä¸ªé»‘è‰²æ ˆå¯¹è±¡æŒ‡å‘ä¸€ä¸ªç™½è‰²å †å¯¹è±¡ï¼Œå¹¶ä¸”åŸæ¥ç°è‰²å¯¹è±¡æŒ‡å‘è¯¥ç™½å¯¹è±¡çš„æŒ‡é’ˆè¢«åˆ é™¤äº†ï¼Œçš„ä¼šå¯¼è‡´æ‚¬æŒ‚æŒ‡é’ˆé—®é¢˜ï¼Œéœ€è¦æ ‡è®°å STW é‡æ–°æ‰«ææ‰€æœ‰æ ˆå¯¹è±¡ã€‚ åªç”¨åˆ é™¤å±éšœï¼šæ ‡è®°ç»“æŸåä¸éœ€è¦é‡æ‰«æ ˆï¼Œä½†æ˜¯å›¾1-\u0026gt;å›¾2è¿‡ç¨‹ä¼šå¯¼è‡´æ‚¬æŒ‚æŒ‡é’ˆã€‚ å› æ­¤ï¼Œé€‰æ‹©æ··åˆå†™å±éšœï¼ˆæ’å…¥+åˆ é™¤ï¼‰å¯ä»¥é¿å…æŒ‡é’ˆæ‚¬æŒ‚é—®é¢˜ï¼Œä¸”ä¸ç”¨æ ‡è®°ç»“æŸåé‡æ–°æ‰«æ ˆï¼Œæé«˜äº†æ•ˆç‡ã€‚\nwritePointer(slot, ptr): shade(*slot) if current stack is grey: shade(ptr) *slot = ptr æ­¤å¤–ï¼Œè¦å°†åˆ›å»ºçš„æ‰€æœ‰æ–°å¯¹è±¡éƒ½æ ‡è®°æˆé»‘è‰²ï¼Œé˜²æ­¢æ–°åˆ†é…çš„å¯¹è±¡è¢«é”™è¯¯åœ°å›æ”¶ã€‚\nåƒåœ¾å›æ”¶çš„è§¦å‘ è§¦å‘é˜ˆå€¼ é€šè¿‡ç¯å¢ƒå˜é‡ GOGC è®¾ç½®ï¼Œé»˜è®¤ä¸º100ï¼Œå³å¢é•¿ 100% çš„å †å†…å­˜æ‰ä¼šè§¦å‘ GCã€‚\nä¸åŒäºè¿›å…¥ STW ä»¥åè¿›è¡Œåƒåœ¾æ”¶é›†çš„æ–¹æ³•ï¼Œå¹¶å‘æ”¶é›†å™¨å¹¶ä¸èƒ½ç­‰åˆ°å †å†…å­˜è¾¾åˆ°è§¦å‘é˜ˆå€¼æ—¶æ‰å¼€å§‹è¿è¡Œï¼Œå› ä¸ºåœ¨ GC æœŸé—´è¿˜ä¼šæœ‰ç”¨æˆ·ç¨‹åºåœ¨åˆ†é…æ–°çš„å †å†…å­˜ã€‚\næ‰€ä»¥ä½¿ç”¨ Pacing ç®—æ³•è®¡ç®—è§¦å‘ GC çš„æœ€ä½³æ—¶é—´ï¼Œä½¿å¾—æ”¶é›†ï¼ˆæ ‡è®°æ‰«æï¼‰ç»“æŸæ—¶å †å†…å­˜è¿‘ä¼¼è¾¾åˆ°é˜ˆå€¼\nè§¦å‘æ—¶æœº å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š\nåå°å®šæ—¶æ£€æŸ¥ï¼Œå½“ä¸€å®šæ—¶é—´å†…æ²¡æœ‰è§¦å‘ï¼ˆé»˜è®¤2minï¼‰ï¼Œå°±ä¼šè§¦å‘æ–°çš„ GC å¾ªç¯ã€‚ ç”¨æˆ·ç¨‹åºæ‰‹åŠ¨è§¦å‘ï¼Œå¦‚æœå½“å‰æ²¡æœ‰å¼€å¯ GC ï¼Œåˆ™è§¦å‘æ–°çš„å¾ªç¯ã€‚ ç”³è¯·å†…å­˜æ—¶æ ¹æ®å †å¤§å°è§¦å‘ï¼Œå½“å †å†…å­˜è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œåˆ™è§¦å‘æ–°çš„å¾ªç¯ã€‚ åå°è§¦å‘ è¿è¡Œæ—¶åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºçš„ä¸€ä¸ªä¸“é—¨ç”¨äºè§¦å‘åƒåœ¾æ”¶é›†çš„goroutineï¼Œå¤§å¤šæ•°æ—¶é—´æ˜¯åœ¨ä¼‘çœ çš„ï¼Œç”± sysmon åœ¨æ»¡è¶³è§¦å‘æ¡ä»¶çš„æ—¶å€™å”¤é†’ã€‚\næ‰‹åŠ¨è§¦å‘ ç”¨æˆ·ç¨‹åºé€šè¿‡ runtime.GC å‡½æ•°ä¸»åŠ¨é€šçŸ¥è¿è¡Œæ—¶æ‰§è¡Œ\nåˆ†é…å†…å­˜ åœ¨åˆ†é…å¾®å¯¹è±¡å’Œå°å¯¹è±¡çš„å†…å­˜æ—¶ï¼Œå¦‚æœmcacheä¸­æ‰¾ä¸åˆ°ç©ºé—²å†…å­˜å•å…ƒï¼Œåˆ™ä¼šå‘ä¸‹å±‚ç”³è¯·mspanå¹¶è§¦å‘ GCã€‚\nåœ¨åˆ†é…å¤§å¯¹è±¡ä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆè§¦å‘ GC å›æ”¶å†…å­˜ã€‚\nGC å®ç° æ ¸å¿ƒå‡½æ•° runtime.gcStartï¼Œå¼€å¯ä¸€ä¸ª GC å¾ªç¯ã€‚\nåƒåœ¾å›æ”¶ä¸‰çŠ¶æ€ åƒåœ¾å›æ”¶å™¨é€šè¿‡ _GCoffã€_GCMark å’Œ _GCMarktermination ä¸‰ä¸ªæ ‡è®°æ¥ç¡®å®šå†™å±éšœçŠ¶æ€\n_GCoff ----\u0026gt; _GCmark ----\u0026gt; _GCmarktermination /\\ | |___________________________________| _GCoffï¼šæ¸…ç†çŠ¶æ€; å†™å±éšœå…³é—­\n_GCmarkï¼šæ ‡è®°çŠ¶æ€ï¼›å†™å±éšœå¼€å¯\n_GCmarkterminationï¼šæ ‡è®°ç»ˆæ­¢çŠ¶æ€ï¼›å†™å±éšœå¼€å¯\nåƒåœ¾å›æ”¶å››é˜¶æ®µ æ¸…ç†ç»ˆæ­¢é˜¶æ®µï¼ˆSTWï¼‰\u0026ndash;\u0026gt; æ ‡è®°é˜¶æ®µ \u0026ndash;\u0026gt; æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼ˆSTWï¼‰\u0026ndash;\u0026gt; æ¸…ç†é˜¶æ®µ\næ¸…ç†ç»ˆæ­¢é˜¶æ®µ çŠ¶æ€ _GCoffï¼›æ‰€æœ‰å¤„ç†å™¨åœ¨è¿™æ—¶è¿›å…¥å®‰å…¨ç‚¹ï¼›å¯¹ä¸Šä¸ªåƒåœ¾å›æ”¶é˜¶æ®µè¿›è¡Œä¸€äº›æ”¶å°¾å·¥ä½œï¼ˆä¾‹å¦‚æ¸…ç†ç¼“å­˜æ± ã€æ¸…ç†å·²ç»è¢«æ ‡è®°çš„å†…å­˜å•å…ƒã€æ¸…ç†æ ‡è®°ç­‰ç­‰ï¼‰ï¼Œ ä»¥åŠå®Œæˆè¿›å…¥æ ‡è®°é˜¶æ®µå‰çš„ä¸€äº›å‡†å¤‡å·¥ä½œï¼ˆå¯åŠ¨åå°æ ‡è®°ä»»åŠ¡ã€æ›´æ–° GC ç»„ä»¶ä¸­ç›¸å…³å˜é‡ï¼‰ï¼Œè¿›å…¥ STW çŠ¶æ€ã€‚\næ ‡è®°é˜¶æ®µ çŠ¶æ€åˆ‡æ¢è‡³ _GCmarkï¼›æ‰«ææ ˆä¸Šã€å…¨å±€å˜é‡ç­‰æ ¹å¯¹è±¡å¹¶å°†å®ƒä»¬åŠ å…¥é˜Ÿåˆ—ï¼Œå°†æ‰€æœ‰Pçš„å¾®åˆ†é…å™¨ä¸­çš„å¯¹è±¡ç½®ç°ï¼Œä»¥åŠå¼€å¯å†™å±éšœï¼Œé€€å‡º STW çŠ¶æ€ï¼Œç¨‹åºæ¢å¤æ‰§è¡Œï¼Œåå°æ ‡è®°ä»»åŠ¡å¼€å§‹æ¢å¤è¿›è¡Œã€‚\næ ‡è®°ç»ˆæ­¢é˜¶æ®µ å½“æ‰€æœ‰çš„æ ‡è®°ä»»åŠ¡éƒ½å®Œæˆåï¼Œè¿›å…¥ STW çŠ¶æ€ï¼ŒçŠ¶æ€åˆ‡æ¢è‡³ _GCmarkterminationï¼›ä»¥åŠå®Œæˆæ ‡è®°çš„æ”¶å°¾å·¥ä½œï¼ˆç»Ÿè®¡æ•°æ®ã€é‡åˆ¶çŠ¶æ€ç­‰ï¼‰ï¼Œå…³é—­å†™å±éšœã€‚\næ¸…ç†é˜¶æ®µ çŠ¶æ€åˆ‡æ¢è‡³ _GCoffï¼›é€€å‡º STW çŠ¶æ€ï¼Œåå°å¹¶å‘æ¸…ç†æ‰€æœ‰çš„å†…å­˜ç®¡ç†å•å…ƒ\næ€»ä¹‹ï¼Œåœ¨è®¿é—®å…¬å…±èµ„æºæ—¶éœ€è¦è¿›å…¥ STW çŠ¶æ€ï¼Œè¿›è¡Œæ‰«ææ ‡è®°æ—¶è¦å¼€å¯å†™å±éšœ å¦‚ä½•æš‚åœå’Œæ¢å¤ç¨‹åº æš‚åœï¼šæŠ¢å æ‰€æœ‰çš„å¤„ç†å™¨Pï¼Œå°†ä»–ä»¬æ›´æ–°è‡³ _Pgcstop çŠ¶æ€\næ¢å¤ï¼šä¾æ¬¡å”¤é†’æ‰€æœ‰çš„å¤„ç†å™¨\nåå°æ ‡è®°æ¨¡å¼ åœ¨æ­¥éª¤1ï¼ˆæ ‡è®°é˜¶æ®µå¼€å§‹å‰ï¼‰ï¼Œè¿è¡Œæ—¶ä¼šä¸ºå…¨å±€æ¯ä¸ªå¤„ç†å™¨åˆ›å»ºä¸€ä¸ªç”¨äºåå°æ ‡è®°ä»»åŠ¡çš„ Goroutineï¼ˆéå† runtime.allpï¼‰ï¼Œè¿™äº› Goroutine éƒ½ä¼šä¸Pç»‘å®šæˆä¸º nodeç»“æ„ä½“ è¢«åŠ å…¥ runtime.gcBgMarkWorkerPool çº¿ç¨‹æ± å¹¶é™·å…¥ä¼‘çœ ç­‰å¾…è°ƒåº¦å™¨çš„å”¤é†’ï¼›ç¨‹åºæ¢å¤ååœ¨è°ƒåº¦å¾ªç¯ä¸­å¯»æ‰¾å¯è¿è¡Œçš„G runtime.findrunnable çš„æ—¶å€™è¢«ä»æ± ä¸­å–å‡ºè°ƒåº¦åˆ°Pä¸Šè¿è¡Œã€‚\nè¿™äº›åå°æ ‡è®°ä»»åŠ¡è¢«ç§°ä¸º gcMarkWorker\nworkeræœ‰ä¸‰ç§æ¨¡å¼ï¼š\ngcMarkWorkerDedicatedModeï¼šå¤„ç†å™¨ä¸“é—¨è´Ÿè´£æ ‡è®°å¯¹è±¡ï¼Œä¸ä¼šè¢«è°ƒåº¦å™¨æŠ¢å  gcMarkWorkerFractionalModeï¼šå½“åƒåœ¾æ”¶é›†çš„åå°CPU ä½¿ç”¨ç‡è¾¾ä¸åˆ°é¢„æœŸæ—¶ï¼ˆé»˜è®¤ä¸º 25%ï¼‰ï¼Œå¯åŠ¨è¯¥ç±»å‹çš„å·¥ä½œåç¨‹å¸®åŠ©åƒåœ¾æ”¶é›†è¾¾åˆ°åˆ©ç”¨ç‡çš„ç›®æ ‡ gcMarkWorkerIdleModeï¼šå½“å¤„ç†å™¨æ²¡æœ‰å¯ä»¥æ‰§è¡Œçš„ Goroutine æ—¶ï¼Œå®ƒä¼šè¿è¡Œåƒåœ¾æ”¶é›†çš„æ ‡è®°ä»»åŠ¡ç›´åˆ°è¢«æŠ¢å  åœ¨è°ƒåº¦å¾ªç¯ä¸­ä¼šæ ¹æ®å…¨å±€å¤„ç†å™¨çš„ä¸ªæ•°ä»¥åŠåƒåœ¾æ”¶é›†çš„ CPU åˆ©ç”¨ç‡ç¡®å®šworkerçš„å·¥ä½œæ¨¡å¼\nä¸‰ç§æ¨¡å¼ç›¸äº’ååŒä¿è¯äº†æ ‡è®°çš„é€Ÿç‡ï¼Œåœ¨åˆ°è¾¾å †å†…å­˜è§¦å‘é˜ˆå€¼å‰å®Œæˆæ ‡è®°ä»»åŠ¡\nè¾…åŠ©æ ‡è®° åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µæœŸé—´ï¼Œå½“ Goroutine è°ƒç”¨ runtime.mallocgc åˆ†é…æ–°å¯¹è±¡æ—¶ï¼Œè¯¥å‡½æ•°ä¼šæ£€æŸ¥ç”³è¯·å†…å­˜çš„ Goroutine æ˜¯å¦å¤„äºå…¥ä¸æ•·å‡ºçš„çŠ¶æ€ï¼šå®ƒéµå¾ªä¸€æ¡éå¸¸ç®€å•å¹¶ä¸”æœ´å®çš„åŸåˆ™ï¼Œåˆ†é…å¤šå°‘å†…å­˜å°±éœ€è¦å®Œæˆå¤šå°‘æ ‡è®°ä»»åŠ¡ã€‚\nå‡è®¾å¦‚æœæœ‰ä¸ªGoroutineä¸€ç›´å¤§é‡çš„åˆ†é…å†…å­˜ï¼Œè¿™æ ·æœ‰å¯èƒ½æ°¸è¿œéƒ½æ‰«æä¸å®Œæ‰€æœ‰å¯¹è±¡ï¼Œæˆ–è€…å½“æ‰«æç»“æŸæ—¶å †å†…å­˜å·²ç»åˆ°äº†ä¸€ä¸ªå¾ˆå¤¸å¼ çš„å¤§å°ã€‚æ‰€ä»¥è¾…åŠ©æ ‡è®°å°±æ˜¯ä¸ºäº†é¿å…è¿™ç§æƒ…å†µã€‚\nåå°æ ‡è®°æ¨¡å¼å’Œè¾…åŠ©æ ‡è®°åŒºåˆ«ï¼š\nåå°æ ‡è®°æ˜¯é€šè¿‡å¹¶å‘åŠ å¿«æ ‡è®°çš„é€Ÿåº¦ï¼Œä»¥ä¿è¯åˆ°è¾¾è§¦å‘é˜ˆå€¼æ—¶å®Œæˆæ ‡è®°ä»»åŠ¡ï¼›\nè¾…åŠ©æ ‡è®°æ˜¯åœ¨åå°å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå½“å‰ goroutine åˆ†é…å†…å­˜æ—¶ï¼Œé€šè¿‡æ§åˆ¶åˆ†é…ä¸æ ‡è®°çš„â€œåŠ¨æ€å¹³è¡¡â€ï¼Œä¿è¯åˆ°è¾¾è§¦å‘é˜ˆå€¼æ—¶å®Œæˆæ ‡è®°ä»»åŠ¡ï¼›\nè§‚å¯Ÿç¨‹åºGCçš„å››ç§æ–¹æ³• GODEBUG GODEBUG=gctrace=1 ./main è¾“å‡º\ngc 1 @0.000s 2%: 0.009+0.23+0.004 ms clock, 0.11+0.083/0.019/0.14+0.049 ms cpu, 4-\u0026gt;6-\u0026gt;2 MB, 5 MB goal, 12 P scvg: 8 KB released scvg: inuse: 3, idle: 60, sys: 63, released: 57, consumed: 6 (MB) å…¶ä¸­ï¼Œgcå¼€å¤´çš„æ˜¯ç”¨æˆ·ä»£ç å‘è¿è¡Œæ—¶ç”³è¯·å†…å­˜äº§ç”Ÿçš„åƒåœ¾å›æ”¶ï¼Œscvgå¼€å¤´çš„æ˜¯è¿è¡Œæ—¶å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼ˆå½’è¿˜å†…å­˜ï¼‰äº§ç”Ÿçš„åƒåœ¾å›æ”¶\ntrace func main() { f, _ := os.Create(\u0026#34;trace.out\u0026#34;) defer f.Close() trace.Start(f) defer trace.Stop() (...) } é€šè¿‡åœ¨ä»£ç å†…è°ƒç”¨trace API æ¥åœ¨ç½‘é¡µå†…è¿›è¡Œå¯è§†åŒ–è§‚å¯Ÿ\ndebug.ReadGCStats func printGCStats() { s := debug.GCStats{} debug.ReadGCStats(\u0026amp;s) fmt.Printf(\u0026#34;gc %d last@%v, PauseTotal %v\\n\u0026#34;, s.NumGC, s.LastGC, s.PauseTotal) } å¯ä»¥æ­é…è®¡æ—¶å™¨å®ç°å¯¹æŒ‡å®šæŒ‡æ ‡çš„å®šæ—¶ç›‘æ§\nruntime.ReadMemStats func printMemStats() { s := runtime.MemStats{} runtime.ReadMemStats(\u0026amp;s) fmt.Printf(\u0026#34;gc %d last@%v, next_heap_size@%vMB\\n\u0026#34;, s.NumGC, time.Unix(int64(time.Duration(s.LastGC).Seconds()), 0), s.NextGC/(1\u0026lt;\u0026lt;20)) } å’Œä¸Šè¾¹æ–¹æ³•ä¸€æ ·ï¼Œåªä¸è¿‡è¿™é‡Œç›´æ¥è°ƒç”¨äº†è¿è¡Œæ—¶çš„ç»“æ„ä½“\nGCè°ƒä¼˜ è°ƒä¼˜æ€æƒ³ï¼šä¼˜åŒ–å†…å­˜çš„ç”³è¯·é€Ÿåº¦ï¼ˆæ§åˆ¶ï¼‰ï¼Œå°½å¯èƒ½çš„å°‘ç”³è¯·å†…å­˜ï¼ˆå‡å°‘ï¼‰ï¼Œå¤ç”¨å·²ç”³è¯·çš„å†…å­˜ï¼ˆå¤ç”¨ï¼‰ï¼Œå‡å°‘GCè§¦å‘é¢‘ç‡ï¼ˆé¢‘ç‡ï¼‰\næ§åˆ¶ï¼šæé«˜èµ‹å€¼å™¨CPUä½¿ç”¨ç‡ï¼Œå‡å°‘èŠ±è´¹åœ¨è°ƒåº¦å™¨çš„ç­‰å¾…ä¸Šçš„æ—¶é—´ï¼ˆä½¿ç”¨ sync.WaitGroup ç­‰å¹¶å‘ç­–ç•¥é¿å…ç³»ç»Ÿä¸­å­˜åœ¨è¿‡å¤šçš„goroutineï¼Œå› ä¸ºæ¯ä¸ªgoroutineéƒ½ä¼šå ç”¨å†…å­˜ï¼‰ã€‚\nå‡å°‘ï¼šåˆç†ä½¿ç”¨æ•°æ®ç»“æ„\nå¤ç”¨ï¼šsync.Pool ç­‰æ± åŒ–æŠ€æœ¯\né¢‘ç‡ï¼šè°ƒæ•´GOGCä¸Šé™ï¼ˆGOGC=1000 ./mainï¼‰\n","permalink":"http://localhost:1313/posts/golang/collector/","summary":"è¯¥æ–‡ç« ä»‹ç»äº†Goè¯­è¨€ä¸­çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼ŒåŒ…æ‹¬ç®—æ³•ã€ç­–ç•¥å’Œä¼˜åŒ–æŠ€æœ¯ã€‚","title":"Go åƒåœ¾æ”¶é›†å™¨"},{"content":"git ç»“æ„ å·¥ä½œåŒºï¼šå®é™…ä»£ç ç›®å½•\nç‰ˆæœ¬åº“ï¼š.gitç›®å½•ï¼Œä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š\næš‚å­˜åŒºï¼ˆstage/indexï¼‰ï¼šä¿å­˜ git add \u0026lt;file\u0026gt; æ·»åŠ çš„æ›´æ”¹ æœ¬åœ°ä»“åº“ï¼ˆrespositoryï¼‰ï¼šä¿å­˜äº†é¡¹ç›®çš„æ‰€æœ‰å†å²è®°å½•å’Œå…ƒæ•°æ®ï¼ˆä¸Šå›¾ä¸­çš„objectsï¼‰ HEAD HEADæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æŸä¸ªæäº¤ï¼Œç”¨æ¥ç¡®å®šå½“å‰å·¥ä½œç›®å½•çš„çŠ¶æ€å’Œæ‰€åœ¨ä½ç½®\ngit rev-parse HEAD æŸ¥çœ‹HEADæŒ‡å‘çš„æäº¤Hash\nbranch ä½¿ç”¨branchè¿›è¡Œâ€œç‰ˆæœ¬æ§åˆ¶â€è€Œä¸æ˜¯è¿›è¡Œâ€œå¼€å‘â€ï¼Œbranchåªæ˜¯å¯¹ä»“åº“ä¸­æ‰€æœ‰commitsè¿›è¡Œç®¡ç†æ’åºï¼Œè€Œä¸æ˜¯å°†ä»£ç â€œæäº¤â€åˆ°åˆ†æ”¯ã€‚\n0 \u0026lt;- 1 \u0026lt;- 2 \u0026lt;-------------------- master \\ 3 \u0026lt;- 4 \u0026lt;- 5 \u0026lt;- 6 \u0026lt;------ A \\ 7 \u0026lt;- 8 \u0026lt;- 9 \u0026lt;-- B åœ¨å¦‚ä¸Šæ‰€ç¤ºçš„ä»“åº“ä¸­ï¼Œmasteråˆ†æ”¯åŒ…æ‹¬0ï½2æäº¤ï¼ŒAåˆ†æ”¯åŒ…æ‹¬0ï½6ï¼ŒBåˆ†æ”¯åŒ…æ‹¬0ï½9\nmerge å°†å¤šä¸ªå¼€å‘å†å²åˆå¹¶ï¼ˆJoin two or more development histories togetherï¼‰\nä¸»è¦æœ‰ä¸¤ç§mergeæ–¹æ³•ï¼š\n3-way mergeï¼šåˆ›å»ºä¸€ä¸ªâ€œåˆå¹¶æäº¤â€ä½œä¸ºä¸¤ä¸ªåˆ†æ”¯çš„äº¤ç‚¹ Fast forward mergeï¼šåªæ”¹å˜åˆ†æ”¯æŒ‡é’ˆï¼ˆé€‚ç”¨äºå½“å‰åˆ†æ”¯å’Œç›®æ ‡åˆ†æ”¯ä½äºä¸€æ¡çº¿æ€§å†å²ä¸Šï¼Œetc. rebaseè¿‡åï¼‰ ä¼˜åŠ¿ï¼šéç ´åæ€§æ“ä½œï¼Œæ–¹ä¾¿åä½œï¼›å¯ä»¥æŸ¥çœ‹ä¸Šæ¸¸æ›´æ”¹ã€‚\nç¼ºç‚¹ï¼šå¤§é‡åˆå¹¶æäº¤æ±¡æŸ“åˆ†æ”¯å†å²ã€‚\nå‘½ä»¤ git merge [ -ff | --no-ff | --ff-only ] \u0026lt;branch\u0026gt; [\u0026lt;target\u0026gt;] ç­‰ä»·\ngit checkout \u0026lt;target\u0026gt; git merge [ -ff | --no-ff | --ff-only ] \u0026lt;branch\u0026gt; \u0026lt;branch\u0026gt; è¦åˆå¹¶çš„åˆ†æ”¯\n\u0026lt;target\u0026gt; branchè¢«åˆå¹¶åˆ°çš„åˆ†æ”¯\nåˆå¹¶æ–¹æ³•å‚æ•°\n-ffï¼šä¼˜å…ˆå¿«é€Ÿåˆå¹¶ï¼Œå¦‚æœä¸¤åˆ†æ”¯ä¸æ˜¯çº¿æ€§å†å²åˆ™ä½¿ç”¨ 3-way merge --no-ffï¼šä½¿ç”¨ 3-way merge --ff-onlyï¼šåªä½¿ç”¨å¿«é€Ÿåˆå¹¶ï¼Œå¦åˆ™ç›´æ¥å¤±è´¥ rebase å°†æäº¤é‡æ–°åº”ç”¨åˆ°å¦ä¸€ä¸ªåŸºå‡†ç‚¹ä¹‹ä¸Šï¼ˆReapply commits on top of another base tipï¼‰ï¼Œç§°ä¸ºå˜åŸºï¼ˆæ”¹å˜åŸºå‡†ç‚¹ï¼‰\næ¯”å¦‚ï¼Œå½“å‰åˆ†æ”¯æ˜¯ä»ä¸»åˆ†æ”¯commit1èŠ‚ç‚¹forkå‡ºæ¥çš„ï¼Œæ­¤åä¸»åˆ†æ”¯åˆæ–°å¢äº†2ä¸ªæäº¤commit2å’Œcommit3ï¼Œè¿™æ—¶å€™ git rebase masterå¯ä»¥å°†å·¥ä½œåˆ†æ”¯ç›¸å¯¹äºä¸»åˆ†æ”¯çš„â€œåˆ†å‰ç‚¹â€æ”¹åˆ°commit3ä¸Šã€‚\n4\u0026#39; \u0026lt;- 5\u0026#39; \u0026lt;- 6\u0026#39; \u0026lt;---- A after rebase / 0 \u0026lt;- 1 \u0026lt;- 2 \u0026lt;- 3 \u0026lt;-------------------- master \\ 4 \u0026lt;- 5 \u0026lt;- 6 \u0026lt;------ A [abandon] ä¼˜åŠ¿ï¼šé¿å…äº†â€œåˆå¹¶æäº¤â€çš„æ±¡æŸ“ï¼›çº¿æ€§å†å²æ–¹ä¾¿è¿½æ ¹æº¯æº\nç¼ºç‚¹ï¼šå°†ä¸€ä¸ªå…¬å…±çš„åˆ†æ”¯è¿½åŠ åˆ°åˆ°è‡ªå·±çš„åˆ†æ”¯ä¼šå¯¼è‡´ä¸å…¶ä»–åä½œè€…çš„å…¬å…±åˆ†æ”¯ç›¸å¼‚ï¼›çœ‹ä¸åˆ°å½“å‰åˆ†æ”¯ä¸­å¹¶å…¥äº†ä¸Šæ¸¸çš„å“ªäº›æ›´æ”¹ã€‚\nå‘½ä»¤ git rebase [-i] [--onto \u0026lt;newbase\u0026gt; | --keep-base] [\u0026lt;upstream\u0026gt; [\u0026lt;branch\u0026gt;]] -i å¯ä»¥è¿›è¡Œäº¤äº’å¼æ“ä½œï¼Œåœ¨æ–‡æœ¬ç¼–è¾‘å™¨å†…è‡ªå®šä¹‰æäº¤.\n\u0026lt;upstream\u0026gt; è¦æ¯”è¾ƒçš„ä¸Šæ¸¸åˆ†æ”¯ã€‚ å¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„æäº¤ï¼Œè€Œä¸ä»…ä»…æ˜¯ç°æœ‰çš„åˆ†æ”¯åç§°ã€‚ é»˜è®¤ä¸ºå½“å‰åˆ†æ”¯é…ç½®çš„ä¸Šæ¸¸ã€‚\n\u0026lt;branch\u0026gt; å·¥ä½œåˆ†æ”¯ï¼›é»˜è®¤æ˜¯HEADã€‚\n--onto \u0026lt;newbase\u0026gt; ç›®æ ‡åˆ†æ”¯ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸ºupstream\n\u0026ndash;onto å‡è®¾æƒ³æŠŠcommits 7ï½9 rebaseåˆ°masterä¸Šï¼Œéœ€è¦ä½¿ç”¨onto\n0 \u0026lt;- 1 \u0026lt;- 2 \u0026lt;-------------------- master \\ 3 \u0026lt;- 4 \u0026lt;- 5 \u0026lt;- 6 \u0026lt;------ A \\ 7 \u0026lt;- 8 \u0026lt;- 9 \u0026lt;-- B é”™è¯¯å‘½ä»¤ï¼šgit rebase master B\noutputï¼šCurrent branch xx is up to date.\nåŸå› ï¼šæ­¤å‘½ä»¤ä¸ºâ€œå°†3ï½9æäº¤rebaseåˆ°2åè¾¹â€ï¼Œå½“ç„¶ä¸ç”¨å˜äº†ã€‚é”™è¯¯åœ¨äºå¯¹branchå«ä¹‰çš„ç†è§£ã€‚\næ­£ç¡®å‘½ä»¤ï¼šgit rebase --onto master A B\nè§£é‡Šï¼šnewbaseä¸ºmasterï¼ˆcommit 2ï¼‰ï¼Œupstream ä¸ºAï¼ˆç¡®å®šäº†è¦copyçš„èŒƒå›´ 7ï½9ï¼‰ï¼Œbranchä¸ºBï¼ˆå½“å‰å·¥ä½œåˆ†æ”¯ï¼‰\ncherry-pick åº”ç”¨æŸäº›å·²æœ‰æäº¤æ‰€å¼•å…¥çš„æ›´æ”¹ã€‚ç®€å•æ¥è¯´ï¼Œå°†æŸäº›æäº¤åº”ç”¨äºå½“å‰åˆ†æ”¯ã€‚\nå‘½ä»¤ git cherry-pick A..B\nAï¼ŒBæ˜¯æäº¤çš„Hashå€¼ï¼ŒèŒƒå›´æ˜¯ (A, B]ï¼Œå¦‚æœè¦åŒ…æ‹¬Aï¼Œåˆ™å–Açš„çˆ¶èŠ‚ç‚¹ A^\næäº¤ A å¿…é¡»æ—©äºæäº¤ B\nå‚è€ƒ atlassiançš„æ•™ç¨‹\ngit doc\nstackoverflow rebase onto vs rebase\n","permalink":"http://localhost:1313/posts/git/git/","summary":"æ–‡ç« è¯¦è¿°äº†Gitçš„åŸºç¡€æ¦‚å¿µå¦‚å·¥ä½œåŒºã€ç‰ˆæœ¬åº“ã€HEADä¸åˆ†æ”¯ï¼Œè¯¦è§£äº†åˆå¹¶æ“ä½œåŒ…æ‹¬mergeå’Œrebaseæ–¹æ³•åŠä¼˜åŠ£ï¼Œè¿˜è®²åˆ°äº†rebaseçš„\u0026ndash;ontoæ“ä½œå’Œcherry-pickæ–¹æ³•ã€‚è¯¦å°½ä»‹ç»äº†å¦‚ä½•æ“ä½œGitè¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œä½¿å·¥ä½œæ›´é«˜æ•ˆ.","title":"git åŸºç¡€æ¦‚å¿µä»¥åŠåˆå¹¶æ“ä½œ"},{"content":"å†…å­˜åˆ†é… å‚è€ƒ draveness å†…å­˜åˆ†é…å™¨\nGoè¯­è¨€åŸæœ¬ å†…å­˜åˆ†é…\nä¾‹å­ golangçš„å†…å­˜åˆ†é…æ¨¡å‹å¯ä»¥ä¸ç°å®ä¸­çš„ é›¶å”®åº—-ç»é”€å•†-å·¥å‚ æ¨¡å¼è¿›è¡Œç±»æ¯”ï¼Œç›®çš„éƒ½åœ¨äºå¯ä»¥åˆç†çš„åˆ†é…èµ„æºä»¥åŠä¿è¯é«˜æ•ˆç‡\nå…·ä½“è€Œè¨€ï¼Œé›¶å”®åº—ï¼ˆçº¿ç¨‹ç¼“å­˜mcacheï¼‰æ‹¥æœ‰å¾ˆå¤šç§ç±»çš„å•†å“ï¼ˆå¯ä»¥çœ‹åšæ˜¯ç©ºé—²å†…å­˜ç©ºé—´æˆ–è€…å†…å­˜é¡µï¼‰ï¼Œæ¯ç§å•†å“ç”±ä¸€ä¸ªå”®è´§å‘˜ï¼ˆmspanï¼‰è¿›è¡Œç®¡ç†ï¼ˆè®°å½•å”®å‡ºçŠ¶æ€ï¼‰å’Œè´Ÿè´£é”€å”®ï¼Œé›¶å”®åº—çš„ä¼˜åŠ¿å°±åœ¨äº\nç¦»é¡¾å®¢ï¼ˆgoroutineï¼‰å®¶å¾ˆè¿‘ï¼Œä¹°ä¸œè¥¿æ¯”è¾ƒä¾¿æ·ã€‚å½“é¡¾å®¢éœ€è¦ä¹°æ•°é‡è¾ƒå°‘çš„å•†å“æ—¶ï¼ˆå¾®å¯¹è±¡å°å¯¹è±¡ï¼‰ç›´æ¥å»é›¶å”®åº—å°±å¥½ï¼Œå¦‚æœè¦å¤§æ‰¹é‡è®¢è´§ï¼ˆå¤§å¯¹è±¡ï¼‰åˆ™éœ€è¦ç›´æ¥å»å·¥å‚ï¼Œé›¶å”®åº—çš„åº“å­˜è‚¯å®šä¸å¤Ÿã€‚\nå½“é›¶å”®åº—åº“å­˜ä¸è¶³æ—¶ï¼Œä¼šå‘ç»é”€å•†ï¼ˆmcentralï¼‰è¿›è´§ã€‚ç»é”€å•†æ‹¥æœ‰æ‰€æœ‰ç§ç±»çš„å•†å“ã€‚\nå½“ç»é”€å•†ä¹Ÿæ²¡æœ‰è¶³å¤Ÿçš„åº“å­˜æ—¶ï¼Œå°±è¦å‘å·¥å‚ï¼ˆmheapï¼‰è¿›è´§ã€‚å·¥å‚ä»“åº“ï¼ˆarenaï¼‰ä¸­å­˜ç€æ‰€æœ‰å·²ç»ç”Ÿäº§å®Œçš„å•†å“ï¼Œå½“ä»“åº“ä¸­æ‰€æœ‰çš„è´§éƒ½è¢«é¢„å®šäº†æ²¡æœ‰å¯å”®å•†å“æ—¶ï¼Œå°±ä¼šæ‰¾åŸæ–™ä¾›åº”å•†ï¼ˆæ“ä½œç³»ç»Ÿï¼‰è¿›è´§ã€‚\nè·å¾—åŸæ–™ï¼ˆpageï¼‰åï¼Œå°±ä¼šè¿›è¡ŒåŠ å·¥å¹¶ä¸”è§„åˆ’ä¸€äº›æ–°ä»“åº“å­˜æ”¾ï¼ˆå †æ‰©å®¹ï¼‰ã€‚\nä¾›è´§é“¾é‡‡ç”¨ä¸‰ä¸ªå±‚çº§çš„ç­–ç•¥ï¼Œå‡å°‘äº†é¡¾å®¢éœ€è¦äº²è‡ªå»å·¥å‚äº¤æ˜“çš„ç¹çï¼Œä¹Ÿä¿è¯äº†å·¥å‚ä¸ä¼šå°†å¤§é‡æ—¶é—´èŠ±åœ¨å¤„ç†å°è®¢å•ä¸Šè¾¹ï¼Œæé«˜äº†å•†å“æµé€šçš„æ•ˆç‡ã€‚\nè®¾è®¡åŸåˆ™ åˆ†é…å™¨ çº¿æ€§åˆ†é…å™¨ ä¾é æŒ‡é’ˆçš„å¢é‡æ¥ç¡®å®šä¸‹ä¸€ä¸ªå¯ç”¨çš„å†…å­˜ä½ç½®ï¼Œéœ€è¦æ­é…å…·æœ‰æ‹·è´ç‰¹æ€§çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼ˆæ ‡è®°å‹ç¼©ã€å¤åˆ¶å›æ”¶ã€åˆ†ä»£å›æ”¶ç­‰ï¼‰æ•´ç†å†…å­˜ç¢ç‰‡ï¼ŒJAVAé‡‡ç”¨çš„åˆ†é…æ–¹æ³•ï¼Œå¯¹äºC/C++ç­‰ç›´æ¥å¯¹å¤–æš´éœ²æŒ‡é’ˆçš„è¯­è¨€ä¸é€‚ç”¨ã€‚\nä¼˜ç‚¹ï¼šå¤æ‚åº¦è¾ƒä½\nç¼ºç‚¹ï¼šæ— æ³•é‡ç”¨å›æ”¶çš„å†…å­˜ï¼ˆæ•´ç†ç¢ç‰‡ä¹‹å‰ï¼‰\nç©ºé—²é“¾è¡¨åˆ†é…å™¨ å°†å†…å­˜å—é€šè¿‡æŒ‡é’ˆè¿æˆé“¾è¡¨ï¼Œç©ºé—²é“¾è¡¨åˆ†é…å™¨å¯ä»¥é€‰æ‹©ä¸åŒçš„ç­–ç•¥åœ¨é“¾è¡¨ä¸­çš„å†…å­˜å—ä¸­è¿›è¡Œé€‰æ‹©ã€‚\nä¼˜ç‚¹ï¼šå¯é‡ç”¨å›æ”¶çš„å†…å­˜\nç¼ºç‚¹ï¼šåˆ†é…æ—¶éœ€è¦éå†é“¾è¡¨\nå››ç§å†…å­˜åˆ†é…ç­–ç•¥ é¦–æ¬¡é€‚åº”ï¼ˆFirst-Fitï¼‰â€” ä»é“¾è¡¨å¤´å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼› å¾ªç¯é¦–æ¬¡é€‚åº”ï¼ˆNext-Fitï¼‰â€” ä»ä¸Šæ¬¡éå†çš„ç»“æŸä½ç½®å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼› æœ€ä¼˜é€‚åº”ï¼ˆBest-Fitï¼‰â€” ä»é“¾è¡¨å¤´éå†æ•´ä¸ªé“¾è¡¨ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å†…å­˜å—ï¼› éš”ç¦»é€‚åº”ï¼ˆSegregated-Fitï¼‰â€” å°†å†…å­˜åˆ†å‰²æˆå¤šä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­çš„å†…å­˜å—å¤§å°ç›¸åŒï¼Œç”³è¯·å†…å­˜æ—¶å…ˆæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é“¾è¡¨ï¼Œå†ä»é“¾è¡¨ä¸­é€‰æ‹©åˆé€‚çš„å†…å­˜å—ï¼› å…¶ä¸­ï¼Œéš”ç¦»é€‚åº”ä¸GOä½¿ç”¨çš„ç­–ç•¥ç›¸ä¼¼ï¼š åˆ†é…æ€æƒ³ åˆ†çº§åˆ†é… å®ƒå°†å¯¹è±¡åˆ’åˆ†ä¸ºå¤šä¸ªä¸åŒçš„å¤§å°çº§åˆ«ï¼ˆgoä¸­ä¸ºå¾®å¯¹è±¡ã€å°å¯¹è±¡ã€å¤§å¯¹è±¡ï¼‰ï¼Œå¹¶ä½¿ç”¨ä¸åŒçš„åˆ†é…å™¨æ¥ç®¡ç†æ¯ä¸ªçº§åˆ«çš„å†…å­˜åˆ†é…ã€‚é€šè¿‡åˆ†çº§åˆ†é…ï¼Œå¯ä»¥æ›´å¥½åœ°é€‚åº”ä¸åŒå¤§å°å¯¹è±¡çš„å†…å­˜éœ€æ±‚ï¼Œæé«˜æ•´ä½“çš„å†…å­˜ç®¡ç†æ•ˆç‡å’Œç©ºé—´åˆ©ç”¨ç‡ã€‚\næ³¨ï¼šåˆ†é…å™¨å’Œåˆ†é…æ€æƒ³æ˜¯ä¸¤ä¸ªä¸åŒå±‚é¢çš„æ¦‚å¿µï¼Œåˆ†çº§åˆ†é…æ˜¯åœ¨å®è§‚å±‚é¢ä¸ºæ–°å¯¹è±¡é€‰æ‹©åˆé€‚çš„ç¼“å­˜å­˜å‚¨çº§åˆ«ï¼Œè€Œåˆ†é…å™¨åˆ™é¢å‘åº•å±‚å†…å­˜åˆ†é…çš„å…·ä½“å®ç°ã€‚ å†…å­˜å¸ƒå±€ mspanæ˜¯å†…å­˜ç®¡ç†å•å…ƒï¼Œè´Ÿè´£ç®¡ç†å†…å­˜é¡µå’Œåˆ†é…çš„å¯¹è±¡\nmcacheä½œç”¨ç›¸å½“äºç¼“å­˜ï¼Œå®ƒç¼“å­˜äº†ä¸€äº›å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œç›´æ¥æ»¡è¶³å½“å‰çº¿ç¨‹çš„å†…å­˜éœ€æ±‚ï¼Œä¸ç”¨åŠ é”æ­¥éª¤ç®€å•é€Ÿåº¦å¾ˆå¿«ã€‚\nmcentralåƒæ˜¯ä¸€ä¸ªäºŒçº§ç¼“å­˜ï¼ŒæŒ‰ç§ç±»ä¸åŒæ¯ç±»ä¿å­˜ä¸€äº›å¯ä»¥æ‹¿æ¥ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œæ–¹ä¾¿mcacheå±‚å¿«é€Ÿè·å–æƒ³è¦çš„ç§ç±»ã€‚\nmheapç”±ä¸€ä¸ªä¸ªçš„arenaæ„æˆï¼Œarenaä½œä¸ºè™šæ‹Ÿå†…å­˜çš„ç´¢å¼•å¯ä»¥å¿«é€Ÿå®šä½å†…å­˜ä¸­çš„å‡ é¡µã€‚\næ³¨ï¼šä¸æ˜¯ä¸€ä¸ªmcacheå¯¹åº”ä¸€ä¸ªmcentralå“¦ go1.11ä»¥å‰å †å†…å­˜ç©ºé—´æ˜¯è¿ç»­çš„ï¼Œ1.11ä¸­æ”¹ä¸ºä½¿ç”¨ç¨€ç–å†…å­˜ï¼Œruntime.heapArena ç®¡ç† pagesPerArena ä¸ªé¡µï¼ˆä¸åŒå¹³å°å¯èƒ½ä¸åŒï¼Œä½†é¡µéƒ½æ˜¯8KBï¼‰\næ³¨ï¼šgoè¯­è¨€çš„é¡µï¼ˆ8KBï¼‰ç”±è¿è¡Œæ—¶è‡ªå·±å®šä¹‰çš„ï¼Œä¸æ“ä½œç³»ç»Ÿçš„é¡µï¼ˆå¤§éƒ¨åˆ†4KBï¼‰ä¸åŒã€‚æ›´å¤§çš„é¡µå¯ä»¥å‡å°‘å†…å­˜ç®¡ç†å¼€é”€ï¼ˆå°å¯¹è±¡å¯ä»¥æŒ¤ä¸€æŒ¤ï¼‰ã€æé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼ˆå¤§å¯¹è±¡ä¸ç”¨åˆ†å¤ªç¢ï¼‰ä»¥åŠæ»¡è¶³å¯¹é½éœ€æ±‚ã€‚ æ ¸å¿ƒç»„ä»¶ mspan runtime.mspan æ˜¯GOè¯­è¨€å†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒï¼Œæ¯ä¸ªmspanç®¡ç†npagesä¸ªGOé¡µå¹¶æŒæœ‰ç®¡ç†çš„é¡µçš„å ç”¨æƒ…å†µã€‚æ¯ä¸ªmspanä½œä¸ºç›¸åŒspanClasså¤§å°ç­‰çº§çš„åŒå‘é“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ç›¸äº’å¼•ç”¨ã€‚\næœ€å°åˆ†é…å•ä½æ˜¯å¯¹è±¡ï¼ˆobjectï¼‰è€Œä¸æ˜¯é¡µï¼Œobjectçš„å¤§å°æ˜¯ç”±mspançš„è·¨åº¦ç±»ï¼ˆspanClassï¼‰å†³å®šçš„ å¯¹è±¡é—´é€šè¿‡ FreeList é“¾è¡¨å½¢å¼è¿æ¥ã€‚\nFreelistæ˜¯ä¸€ç§ç‰¹æ®Šçš„é“¾è¡¨å½¢å¼ï¼Œé€šè¿‡èŠ‚ç‚¹å€¼çš„é«˜8å­—èŠ‚ç¡®å®šä¸‹ä¸ªèŠ‚ç‚¹çš„å†…å­˜åœ°å€ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„ä¿å­˜ä¸€ä¸ªNextæŒ‡é’ˆå­—æ®µã€‚å¯ä»¥èŠ‚çœå†…å­˜ã€‚ spanClass runtime.spanClass æ˜¯mspançš„è·¨åº¦ç±»ï¼Œå®ƒå†³å®šäº†å†…å­˜ç®¡ç†å•å…ƒä¸­å­˜å‚¨çš„å¯¹è±¡å¤§å°å’Œä¸ªæ•°ã€‚\næºç ä¸­é¢„å­˜å‚¨äº†67ä¸ªè·¨åº¦ç±»å°ºå¯¸ (size class)ï¼Œè¿è¡Œæ—¶ä¸­è¿˜åŒ…å«1ä¸ªidä¸º0çš„ç‰¹æ®Šè·¨åº¦ç±»ï¼Œå®ƒèƒ½å¤Ÿç®¡ç†å¤§äº 32KB çš„ç‰¹æ®Šå¯¹è±¡ã€‚\nè·¨åº¦ç±»ä¸€å…±æœ‰ 68 * 2 = 136 ä¸ªï¼š68ä¸ªå°ºå¯¸ï¼ˆsize classï¼‰ï¼Œæ¯ç§å°ºå¯¸æœ‰ä¸¤ä¸ªç±»å‹ï¼ˆ scan å’Œ noscan ï¼‰ï¼Œnoscanè¡¨ç¤ºå¯¹è±¡ä¸åŒ…å«æŒ‡é’ˆæ‰€ä»¥ä¸ä¼šè¢«GCæ‰«æï¼Œå¯ä»¥æé«˜GCæ•ˆç‡ã€‚\nä¸€ä¸ªspanClassç”±ä¸€ä¸ª uint8 è¡¨ç¤ºï¼Œå…¶ä¸­é«˜7ä½æ˜¯idï¼Œæœ€åä¸€ä½è¡¨ç¤º scan æˆ– noscanã€‚\nåœ¨è¿è¡Œæ—¶åˆ†é…å¯¹è±¡æ—¶ä¼šæ ¹æ®å¯¹è±¡å¤§å°é€‰æ‹©é€‚åˆçš„è·¨åº¦ç±»ã€‚ä¹Ÿæ­£æ˜¯ä¸ä¸Šè¿°éš”ç¦»é€‚åº”ç­–ç•¥çš„ç›¸ä¼¼ä¹‹å¤„ã€‚\nmcache çº¿ç¨‹ç¼“å­˜ï¼Œä¼šä¸å¤„ç†å™¨ P ä¸€ä¸€ç»‘å®šï¼Œä¸»è¦ç”¨æ¥ç¼“å­˜å¾®å°å¯¹è±¡ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜éƒ½åœ¨ mcache.alloc æ•°ç»„ä¸­æŒæœ‰ 68 * 2 ä¸ª runtime.mspanï¼Œæ¯ä¸€ä¸ªæ•°ç»„å…ƒç´ éƒ½æ˜¯æŸä¸€ä¸ªç‰¹å®šå¤§å°çš„ mspan çš„é“¾è¡¨å¤´æŒ‡é’ˆã€‚\næ‹¥æœ‰å¾®å¯¹è±¡åˆ†é…å™¨ï¼Œä¸“é—¨ç®¡ç†16Bä»¥ä¸‹çš„éæŒ‡é’ˆç±»å‹çš„å¯¹è±¡ï¼Œ\nä¼˜åŠ¿ï¼šç”±äºä¸Pç»‘å®šï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ï¼Œè®¿é—®æ—¶ä¸ç”¨åŠ é”ï¼Œæ•ˆç‡æ›´é«˜ã€‚ï¼ˆä¸ºä»€ä¹ˆä¸ä¸Mç»‘å®šï¼šMå¯èƒ½é™·å…¥ä¼‘çœ çŠ¶æ€ï¼ŒæœŸé—´æ— æ³•å¤ç”¨ç¼“å­˜ï¼‰\nåˆå§‹åŒ– åœ¨åˆå§‹åŒ–å¤„ç†å™¨Pæ—¶ä¼šè°ƒç”¨ runtime.allomcache åœ¨ç³»ç»Ÿæ ˆä¸­ä½¿ç”¨ mheap ä¸­çš„çº¿ç¨‹ç¼“å­˜åˆ†é…å™¨è¿›è¡Œåˆå§‹åŒ–ã€‚\nmcentral ä¸­å¿ƒç¼“å­˜ï¼Œæ¯ä¸ªä¸­å¿ƒç¼“å­˜ç®¡ç†ä¸€ç§è·¨åº¦ç±»å¯¹åº”çš„å†…å­˜ç®¡ç†å•å…ƒï¼ˆmspanï¼‰ï¼Œæ€»å…±136ä¸ªç”±mheapä¿å­˜ã€‚è¿™äº›mspanç”±å››ä¸ª spanSet å­˜å‚¨ï¼Œåˆ†åˆ«æ˜¯ï¼š\nåŒ…å«ç©ºé—²å¯¹è±¡çš„ partial set: [swept,unswept]\nä¸åŒ…å«ç©ºé—²å¯¹è±¡ full set: [swept,unswept]\nåƒåœ¾å›æ”¶å™¨å®Œæˆå¯¹æŸä¸ªå†…å­˜è·¨åº¦çš„æ‰«æå’Œæ ‡è®°æ“ä½œåï¼Œè¯¥å†…å­˜è·¨åº¦å°±è¢«è®¤ä¸ºæ˜¯ \u0026ldquo;swept\u0026rdquo; è®¿é—®ä¸­å¿ƒç¼“å­˜ä¸­çš„å†…å­˜ç®¡ç†å•å…ƒéœ€è¦ä½¿ç”¨äº’æ–¥é”ï¼š\nmheap é¡µå †ï¼Œä»¥å…¨å±€å˜é‡å½¢å¼ runtime.mheap_ å­˜å‚¨ï¼ŒåŒ…å«äº†é•¿åº¦ä¸º136ï¼ˆscan \u0026amp; noscanï¼‰çš„mcentralæ•°ç»„ï¼ŒæŒæœ‰çš„mspanåˆ—è¡¨ä»¥åŠæ‰€æœ‰çš„ heapArenaï¼ˆç”±äºŒç»´æ•°ç»„å­˜å‚¨ï¼‰ã€‚\nheapArena GOå †åœ¨é€»è¾‘ä¸Šåˆ’åˆ†ä¸ºå¤šä¸ª heapArena ï¼Œå¯ä»¥æŠŠ heapArena çœ‹ä½œâ€œå †å—â€ï¼Œ æ¯â€œå—â€é‡Œæœ‰ heapArenaBytes / pageSize ä¸ªé¡µï¼Œ åˆ†åˆ«ç”± mspan è¿›è¡Œç®¡ç†ã€‚\nå¯¹è±¡åˆ†é… å…¥å£: runtime.newobjectï¼Œnewå…³é”®å­—çš„å®ç°\nåœ¨åˆ†é…æ—¶ï¼Œä¼šå æœ‰mçº¿ç¨‹ï¼Œå¹¶æ ¹æ®å¯¹è±¡å¤§å°å’Œæ˜¯å¦ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆscanï¼‰ç¡®å®šåˆ†é…é€»è¾‘ï¼š\nif size \u0026lt;= 32KB { if noscan \u0026amp;\u0026amp; size \u0026lt; 16B { åˆ†é…å¾®å¯¹è±¡ } else { åˆ†é…å°å¯¹è±¡ } } else { åˆ†é…å¤§å¯¹è±¡ } å¤§å¯¹è±¡ å¯¹äºsize\u0026gt;32KBçš„å¯¹è±¡ï¼Œç›´æ¥åœ¨å †ä¸Šè¿›è¡Œåˆ†é…ã€‚\næµç¨‹ è®¡ç®—éœ€è¦çš„pagesï¼Œç„¶åè¿›å…¥ç³»ç»Ÿæ ˆå°è¯•è·å–æ–°çš„mspan\nåœ¨åˆ†é…ä¹‹å‰å…ˆå›æ”¶ä¸€éƒ¨åˆ†å†…å­˜ä»¥é¿å…å†…å­˜å¤§é‡å ç”¨\nã€mheapåŠ é”ã€‘å†…å­˜åˆ†é…ã€mspanåˆå§‹åŒ– ã€mheapè§£é”ã€‘\nä»å †ä¸Šåˆ†é…æ–°çš„å†…å­˜é¡µå’Œå†…å­˜ç®¡ç†å•å…ƒmspanï¼ˆidä¸º0çš„ç‰¹æ®Šmspanï¼‰ï¼Œå¦‚æœå †ç©ºé—´ä¸è¶³è¿˜è¦è€ƒè™‘æ‰©å®¹ï¼ˆå‘æ“ä½œç³»ç»Ÿç”³è¯·ç©ºé—´ï¼‰ï¼Œå¦‚æœp0ä¸Šçš„mspanç¼“å­˜ runtime.p.mspancache ä¸è¶³è¿˜è¦ç”¨ runtime.fixalloc åˆ†é…å™¨åˆ†é… é¡µå†…å­˜åˆ†é…ä½¿ç”¨çš„æ˜¯å…¨å±€çš„é¡µåˆ†é…å™¨ runtime.pageAllocï¼ˆRadix treeï¼‰ åˆå§‹åŒ–åˆšåˆšè·å¾—çš„mspanï¼Œå¹¶ä¸”å»ºç«‹mheapå’Œmspançš„å…³ç³»ï¼ˆåŠ å…¥heapArena.spansï¼‰\næ¸…ç†æ–°åˆ†é…çš„å†…å­˜ï¼Œè¿›è¡Œå½’é›¶æ“ä½œ\nè¿”å›mspanä¸­çš„baseåœ°å€ mspan.startAddr\nå°å¯¹è±¡ å¯¹äº16B\u0026lt;=size\u0026lt;=32KBçš„å¯¹è±¡å’Œsize\u0026lt;16ä½†åŒ…å«æŒ‡é’ˆBçš„å¯¹è±¡ï¼Œï¼Œå…ˆåå°è¯•ä»çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜ã€å †ä¸­è·å–mspanï¼Œå¦‚æœæ²¡æ‰¾åˆ°å¯ç”¨çš„åˆ™ä»æ“ä½œç³»ç»Ÿåˆ†é…æ–°é¡µ\næµç¨‹ æ ¹æ®å¯¹è±¡å¤§å°æ‰¾åˆ°å¯¹åº”çš„è·¨åº¦ç±»ï¼Œå°è¯•ä»mcacheçš„mspanæ•°ç»„ç¼“å­˜ï¼ˆmcache.allocï¼‰ä¸­çš„è·å–å¯¹åº”çš„mspanï¼Œé€šè¿‡ mspan.allocCacheï¼ˆä¿å­˜å¯¹è±¡ç©ºé—²çŠ¶æ€çš„ä½å›¾ï¼ŒåŸç†ï¼šå¾·å¸ƒé²å› åºåˆ—ï¼‰å¯»æ‰¾èƒ½å¤Ÿå®¹çº³å½“å‰å¯¹è±¡çš„ç©ºé—²å¯¹è±¡å†…å­˜ç©ºé—´ï¼Œå¦‚æœæœ‰åˆ™å®Œæˆåˆ†é…\nå¦‚æœä¸Šä¸€æ­¥æ²¡æœ‰æ‰¾åˆ°åˆ†é…ç©ºé—´ï¼Œåˆ™éœ€è¦è°ƒç”¨ runtime.refill å‘ä¸Šçº§ç»„ä»¶è·å–mspanæ›¿æ¢å·²ç»ä¸å­˜åœ¨å¯ç”¨å¯¹è±¡çš„å½“å‰mspan\nå°†å½“å‰çš„mspanï¼ˆå·²æ»¡ï¼‰æ”¾å…¥ mcentral çš„ full set\nå°è¯•ä» mcentralçš„ partial swept setè·å–ä¸€ä¸ªmspan\nå°è¯•ä» mcentralçš„ partial unswept setè·å–ä¸€ä¸ªmspanï¼Œå¹¶ä¸”sweepå®ƒ\nå°è¯•ä» mcentralçš„ full unswept setè·å–ä¸€ä¸ªmspanï¼Œå¹¶ä¸”sweepå®ƒï¼Œ å¦‚æœsweepåå‘ç°æ²¡æœ‰ç©ºé—²ç©ºé—´ï¼Œåˆ™æ”¾åˆ° full swept setä¸­\nå¦‚æœå°è¯•100æ¬¡è·å–åï¼ˆgo1.21ï¼‰ä¾æ—§æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„mspanï¼Œ åˆ™ç»§ç»­å‘å †ç”³è¯·\nå‘å †ç”³è¯·æµç¨‹ä¸å¤§å¯¹è±¡åˆ†é…æµç¨‹ä¸€è‡´ï¼ˆåªæœ‰span sizeä¸åŒï¼‰ åˆå§‹åŒ–mspanå­—æ®µä»¥åŠåˆå§‹åŒ–heapArenaä¸­è¯¥mspançš„ä½å›¾ä¿¡æ¯ç­‰å­—æ®µ è‡³æ­¤ï¼Œå¯»æ‰¾èƒ½ç”¨çš„mspançš„æµç¨‹ç»ˆäºç»“æŸäº†\nå°†æ–°è·å–åˆ°çš„mspanä¿å­˜åœ¨ï¼ˆmcache.allocï¼‰ä¸­ï¼Œå¹¶ä¸”è¿”å›æ–°mspanä¸­çš„ç©ºé—²å†…å­˜åœ°å€ï¼ˆfreeIndexï¼‰\nå¾®å¯¹è±¡ å¯¹äºsize\u0026lt;16ä¸”ä¸åŒ…å«æŒ‡é’ˆï¼ˆnoscanï¼‰Bçš„å¯¹è±¡ï¼Œä½¿ç”¨mcacheä¸­çš„å¾®åˆ†é…å™¨ï¼ˆmcache.tinyç­‰å­—æ®µï¼‰åˆ†é…ã€‚ä¸»è¦ç›®æ ‡æ˜¯çŸ­å­—ç¬¦ä¸²å’Œé€ƒé€¸çš„ä¸´æ—¶å˜é‡\nä¸€ä¸ªtinyå†…å­˜å—ï¼ˆç”±maxTinySizeå†³å®šï¼Œ16Bï¼‰ä¸­å¯ä»¥å­˜å¤šä¸ªå¾®å¯¹è±¡ï¼Œå¤§å®¶æŒ¤ä¸€æŒ¤ä»è€ŒèŠ‚çœäº†ç©ºé—´ã€‚è€Œé‡Šæ”¾å†…å­˜æ—¶ï¼Œè¦ç­‰å—ä¸­æ‰€æœ‰çš„å¯¹è±¡éƒ½è¢«æ ‡è®°ä¸ºåƒåœ¾æ—¶æ‰ä¼šè¿›è¡Œã€‚\né€ƒé€¸å˜é‡ï¼šå‡½æ•°å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡ï¼Œä½†åœ¨å‡½æ•°ç»“æŸåä»ç„¶è¢«å…¶ä»–å¯¹è±¡æˆ–å‡½æ•°å¼•ç”¨çš„å˜é‡ï¼ˆæŒ‡é’ˆä½œä¸ºè¿”å›å€¼ç­‰ï¼‰\nä¸ºä»€ä¹ˆå¿…é¡»è¦æ˜¯noscanï¼šä¸ºäº†ä¿è¯æ½œåœ¨æµªè´¹çš„å†…å­˜é‡æ˜¯æœ‰é™çš„ï¼ˆthe amount of potentially wasted memory is bounded.ï¼‰\næµç¨‹ å…ˆæ ¹æ®å¯¹è±¡çš„sizeè¿›è¡Œä¸€äº›å†…å­˜å¯¹é½çš„æ“ä½œï¼Œè°ƒæ•´ mcache.tinyoffset çš„å†…å­˜åœ°å€ ä¸ºä»€ä¹ˆè¦å†…å­˜å¯¹é½ï¼šå‡å°‘ CPU è®¿é—®å†…å­˜çš„æ¬¡æ•°ã€‚å› ä¸º CPU æ˜¯ä»¥å­—é•¿ä¸ºå•ä½è®¿é—®å†…å­˜çš„è€Œä¸æ˜¯å­—èŠ‚ã€‚ çœ‹çœ‹å½“å‰tinyå†…å­˜å—ä¸­æ˜¯å¦è£…å¾—ä¸‹ï¼ˆtinyoffset+size \u0026lt;= maxTinySizeï¼‰ï¼Œè£…å¾—ä¸‹åˆ™ç›´æ¥åˆ†é…ï¼Œè¿”å›å¯¹è±¡å†…å­˜åœ°å€\nå¦åˆ™ï¼ŒåŒå°å¯¹è±¡åˆ†é…æµç¨‹ä¸€æ ·è·å–ä¸€ä¸ªmspanæ›¿æ¢æ—§çš„tinyå—ï¼Œå”¯äºŒä¸åŒæ˜¯span sizeå’Œä¸ç”¨å¯¹æ–°åˆ†é…çš„å†…å­˜è¿›è¡Œæ¸…é›¶ï¼ˆwhyï¼Ÿï¼‰\nè¿”å›åˆ†é…åˆ°çš„å†…å­˜åœ°å€\næ€»ç»“ GOä¸­å†…å­˜å¸ƒå±€åˆ©ç”¨äº†å¤šçº§ç¼“å­˜ä»¥åŠéš”ç¦»é€‚åº”ç­–ç•¥ï¼ˆåˆ’åˆ†å¤šä¸ªsize classï¼‰ï¼Œä¼˜åŒ–äº†å†…å­˜åˆ†é…çš„æ•ˆç‡ï¼Œæé«˜äº†ç©ºé—´åˆ©ç”¨ç‡ï¼Œå¹¶ä¸”ç”±è¿è¡Œæ—¶å…¨æƒç®¡ç†å †åŒºå†…å­˜ï¼Œæ–¹ä¾¿äº†å¼€å‘è€…ã€‚è¿™ä¹Ÿæ­£æ˜¯golangå†…å­˜å ç”¨å°ã€è¿è¡Œé€Ÿåº¦å¿«ã€ä½¿ç”¨ç®€ä¾¿çš„åŸå› ä¹‹ä¸€ã€‚\n","permalink":"http://localhost:1313/posts/golang/memory/","summary":"ä»‹ç»äº†goå†…å­˜åˆ†é…çš„ä¸‰çº§æ¨¡å‹ï¼Œè¿˜è®¨è®ºäº†åˆ†é…å™¨çš„ç§ç±»å’Œè®¾è®¡åŸåˆ™ï¼Œä»¥åŠå†…å­˜å¸ƒå±€çš„ç»„ä»¶å’Œå¯¹è±¡åˆ†é…çš„æµç¨‹ã€‚æ•´ä½“è€Œè¨€ï¼ŒGoçš„å†…å­˜åˆ†é…å™¨é€šè¿‡å¤šçº§ç¼“å­˜å’Œåˆ†çº§åˆ†é…çš„æ€æƒ³ï¼Œæé«˜äº†å†…å­˜ç®¡ç†çš„æ•ˆç‡å’Œç©ºé—´åˆ©ç”¨ç‡ã€‚","title":"Go å†…å­˜åˆ†é…å™¨"},{"content":"goroutine å‚è€ƒ æ“ä½œç³»ç»Ÿ | è¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢é—®é¢˜\nDraveness è°ƒåº¦å™¨\nGo ç¨‹åºå‘˜é¢è¯•ç¬”è¯•å®å…¸ è°ƒåº¦å™¨\nGo ç‰¹æ®Šçš„goroutine\nçº¿ç¨‹å’Œè¿›ç¨‹å’Œgoroutine (è¿›ç¨‹-\u0026gt;çº¿ç¨‹-\u0026gt;goroutine) goroutineå’Œçº¿ç¨‹åŒºåˆ« ä¸»è¦ä¸‰æ–¹é¢ï¼šåˆ›å»ºå’Œé”€æ¯æˆæœ¬ã€å†…å­˜å ç”¨ã€åˆ‡æ¢æˆæœ¬\nè¿›ç¨‹ çº¿ç¨‹ goroutine åˆ›å»ºå’Œé”€æ¯ å†…æ ¸çº§ï¼ˆå†…å­˜ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦ç­‰ï¼‰ å†…æ ¸çº§ ï¼ˆä¼˜åŒ–ï¼šçº¿ç¨‹æ± ï¼‰ ç”¨æˆ·çº§ åˆ‡æ¢ åˆ‡æ¢é¡µè¡¨åˆ·æ–°TLBï¼ˆä¸»è¦å½±å“ï¼‰ã€PCBåˆ‡æ¢ï¼Œ æ…¢ ä¿å­˜å„ç§å¯„å­˜å™¨ï¼Œè¾ƒæ…¢ åªä¿å­˜ä¸‰ä¸ªï¼šPCï¼ŒSPï¼ŒBPï¼Œå¿« å†…å­˜å ç”¨ ç‹¬ç«‹çš„è™šæ‹Ÿå†…å­˜ 1MB+â€œguard pageâ€ åˆå§‹2KB è¿›ç¨‹åˆ‡æ¢ = æŒ‡ä»¤åºåˆ—åˆ‡æ¢ + èµ„æºåˆ‡æ¢ çº¿ç¨‹åˆ‡æ¢ = æŒ‡ä»¤åºåˆ—åˆ‡æ¢ + å…±äº«èµ„æº ä¸ºä»€ä¹ˆçº¿ç¨‹è½»é‡ åŒä¸€ä¸ªè¿›ç¨‹ä¸‹ï¼Œçº¿ç¨‹ä¹‹é—´çš„å…±äº«å†…å­˜ç©ºé—´ï¼ˆå†…å­˜å ç”¨ï¼‰ï¼Œæ‰€ä»¥åˆ›å»ºå’Œé”€æ¯æ—¶åªéœ€è¦å…³å¿ƒè‡ªå·±ç‹¬æœ‰çš„æ•°æ®ï¼Œè¿˜å¯ä»¥åˆ©ç”¨çº¿ç¨‹æ± è¿›ä¸€æ­¥å‡å°æˆæœ¬ï¼ˆåˆ›å»ºå’Œé”€æ¯ï¼‰ï¼Œè¿›è¡Œåˆ‡æ¢æ—¶ä¸éœ€è¦åˆ‡æ¢é¡µè¡¨ï¼ˆåˆ‡æ¢ï¼‰\nä¸ºä»€ä¹ˆgoroutineæ›´è½»é‡ åŒæ ·å…±äº«è¿›ç¨‹å†…å­˜ç©ºé—´ï¼Œä¸”æ ˆç©ºé—´ä¼šåŠ¨æ€å˜åŒ–ï¼Œå¯ä»¥å‡å°‘å†…å­˜æµªè´¹ï¼ˆå†…å­˜å ç”¨ï¼‰ï¼Œåˆ›å»ºå’Œé”€æ¯ç”± Go è¿è¡Œæ—¶ï¼ˆ Go runtime ï¼‰è´Ÿè´£ç®¡ç†ï¼Œæˆæœ¬å¾ˆå°æ˜¯ç”¨æˆ·çº§çš„ã€‚ï¼ˆåˆ›å»ºå’Œé”€æ¯ï¼‰åªéœ€è¦ä¿å­˜å’Œæ¢å¤ Goroutine çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦åˆ‡æ¢æ•´ä¸ªçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼ˆMï¼šNæ¨¡å‹ï¼‰ï¼Œå‡å°‘äº†é¢‘ç¹åˆ‡æ¢çš„å†…å­˜å¼€é”€ï¼ˆåˆ‡æ¢ï¼‰\nå…¶å®golangåšçš„ä¼˜åŒ–å°±æ˜¯ï¼šåŸæœ¬æ¯ä¸ªä»»åŠ¡éƒ½è¦å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯¹äºä¸€ä¸ªCPUæ¥è¯´é‡åˆ°å¤šä»»åŠ¡å¹¶å‘æ‰§è¡Œçš„æƒ…å†µå°±è¦é¢‘ç¹åˆ‡æ¢çº¿ç¨‹ï¼ˆè§£å†³ï¼šç­‰é‡Mï¼‰ï¼Œå¹¶ä¸”éœ€è¦ä»å…¨å±€é˜Ÿåˆ—å–ä»»åŠ¡ï¼Œæ¶‰åŠåˆ°åŠ è§£é”ï¼ˆè§£å†³ï¼šåŠ Pä¿å­˜æœ¬åœ°é˜Ÿåˆ—ï¼‰ï¼Œé€ æˆèµ„æºçš„æµªè´¹ã€‚è€Œ go ä¸­åªä½¿ç”¨ä¸æœºå™¨ CPU æ•°é‡ç›¸ç­‰ï¼ˆé»˜è®¤ï¼‰çš„çº¿ç¨‹ï¼Œå°†ç›¸æ¯”çº¿ç¨‹æ›´è½»é‡çš„ goroutine ä½œä¸ºå…·ä½“ä»»åŠ¡çš„æ‰§è¡Œè½½ä½“ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹åªéœ€è¦é€šè¿‡å¤„ç†å™¨ P å’Œè°ƒåº¦å™¨åœ¨ç”¨æˆ·æ€è¿›è¡Œè°ƒåº¦ï¼Œå‡å°‘äº†çº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„èµ„æºæŸè€—ã€‚ goç¨‹åºæ‰§è¡Œ go programï¼šç”¨æˆ·ç¨‹åº runtimeï¼šruntime æ˜¯ Go çš„è¿è¡Œæ—¶ç³»ç»Ÿï¼Œå®ƒæ˜¯ä¸€ä¸ªåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´è´Ÿè´£ç®¡ç†å’Œæ”¯æŒ Go è¯­è¨€ç‰¹æ€§çš„åº•å±‚ç³»ç»Ÿç»„ä»¶ï¼Œç”¨äºæ”¯æŒ Goroutine çš„è°ƒåº¦ã€å†…å­˜ç®¡ç†ã€åƒåœ¾å›æ”¶ã€å¹¶å‘åŸè¯­ç­‰å…³é”®åŠŸèƒ½ã€‚ Goroutine çš„è°ƒåº¦åŠŸèƒ½å°±æ˜¯é€šè¿‡è¿è¡Œæ—¶ä¸­çš„ scheduler å®ç°çš„ã€‚\nè°ƒåº¦å™¨ scheduler åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œruntime.schedt å¯¹è±¡åªæœ‰ä¸€ä»½å®ä½“ï¼Œå®ƒè´Ÿè´£åè°ƒå’Œç®¡ç† goroutine çš„æ‰§è¡Œã€‚\næ•°æ®ç»“æ„ runtime.schedt ç»“æ„ä½“ç»´æŠ¤äº†ç©ºé—² M åˆ—è¡¨ã€ç©ºé—² P åˆ—è¡¨ï¼Œå…¨å±€ G é˜Ÿåˆ—ã€dead G ç¼“å­˜ç­‰ç­‰ã€‚\næ‰€æœ‰ M æ‰€æœ‰ P æ‰€æœ‰ G ä¿å­˜åœ¨å…¨å±€å˜é‡ä¸­ï¼ˆallm, allp, allgsï¼‰ï¼Œ è°ƒåº¦å™¨ä¸­åªæ˜¯ç©ºé—²çš„åˆ—è¡¨ åˆå§‹åŒ– ä¸€äº›é…ç½®çš„åˆå§‹åŒ– è·å– g0ï¼ˆ g0 åœ¨è¿è¡Œæ—¶ç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºï¼‰ åˆå§‹åŒ– m0ï¼ˆåˆå§‹åŒ–idä»¥åŠgsignalç­‰ç­‰ï¼‰ ã€åŠ é”ã€‘ åˆå§‹åŒ– GOMAXPROCS ä¸ª P ã€è§£é”ã€‘ å…³äº m0 å’Œ g0 GMP M -\u0026gt; P -\u0026gt; G\nMï¼šMachineï¼Œå†…æ ¸çº¿ç¨‹ï¼Œå³ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„çº¿ç¨‹ Pï¼šProcessorï¼Œå¤„ç†å™¨ï¼Œè¿è¡Œåœ¨Mä¸Šè´Ÿè´£æœ¬åœ°è°ƒåº¦ï¼Œå‡ç¼“äº†å…¨å±€é”çš„è°ƒç”¨é¢‘ç‡ Gï¼šGoroutineï¼Œå¾…æ‰§è¡Œä»»åŠ¡ G åªå­˜åœ¨äº Go è¯­è¨€çš„è¿è¡Œæ—¶ï¼Œæ˜¯ç”¨æˆ·æ€çº¿ç¨‹\næ•°æ®ç»“æ„ runtime.g ç»“æ„ä½“ä¸­åŒ…æ‹¬ä½¿ç”¨çš„æ ˆä¿¡æ¯ã€å½“å‰ç»‘å®šçš„Mï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ã€æŠ¢å ç›¸å…³ä¿¡æ¯ã€è°ƒåº¦ç›¸å…³ä¿¡æ¯ç­‰ç­‰\nçŠ¶æ€ ä¸€ä¸ª G æœ€ä¸»è¦çš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰ä¸ªçŠ¶æ€ï¼š\né˜»å¡ä¸­ ä¾‹å¦‚ï¼šæ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ _Gsyscallï¼Œè¿è¡Œæ—¶é˜»å¡ï¼ˆchannelä¹‹ç±»çš„ï¼‰_Gwaitingï¼Œè¢«æŠ¢å  _Gpreempted å¯è¿è¡Œ ä¾‹å¦‚ï¼šå­˜å‚¨åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ _Grunnable è¿è¡Œä¸­ ä¾‹å¦‚ï¼šè¢«èµ‹äºˆäº†Må’ŒP _Grunnable æ­¤å¤–ï¼Œè¿˜æœ‰ GC ç›¸å…³çŠ¶æ€ã€åˆå§‹åŒ–çŠ¶æ€ï¼ˆ_Gidleã€_Gdeadï¼‰ç­‰ã€‚ å°†ç©ºé—²çš„Gç½®ä¸º _Gdead çŠ¶æ€å¯ä»¥é¿å… GC æ‰«ææœªåˆå§‹åŒ–çš„æ ˆï¼ˆä¸çŸ¥é“å•¥æ„æ€ï¼Œæ€»ä¹‹æ˜¯å’Œé¿å…GCå¹²å•¥æœ‰å…³ï¼‰\nåˆå§‹åŒ– è·å–è°ƒç”¨æ–¹ G ä»¥åŠ PCï¼›\nã€é”ä½m0 é¿å…æŠ¢å ã€‘ç”¨ g0 ç³»ç»Ÿæ ˆï¼ˆsystemstackï¼‰åˆ›å»ºæ–°çš„ Gã€è§£é”m0ã€‘ï¼ˆä½¿ç”¨ç³»ç»Ÿæ ˆç›®çš„æ˜¯å‡å°‘æ ˆå¸§çš„å¤åˆ¶å’Œç®¡ç†å¼€é”€ï¼Œä»è€Œæé«˜å¤§å‹å‡½æ•°è°ƒç”¨çš„æ€§èƒ½ï¼‰ï¼š\nè·å– g0ï¼ˆå¯åŠ¨æ—¶åˆ›å»ºçš„ï¼‰ã€p0ï¼ˆschedtåˆå§‹åŒ–æ—¶åˆ›å»ºï¼‰ å°è¯•ä»æœ¬åœ°æˆ–è€…å…¨å±€ dead G åˆ—è¡¨ä¸­è·å–ç©ºé—²çš„ Goroutine (runtime.p.gFree, runtime.schedt.gFree)ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ G è®¾ç½®å…¶çŠ¶æ€ä¸º dead å¹¶åŠ å…¥å…¨å±€ G åˆ—è¡¨ åˆå§‹åŒ– G çš„è¿è¡Œç°åœºä»¥åŠéœ€è¦çš„å‚æ•° æ”¾åˆ°è¿è¡Œé˜Ÿåˆ—ä¸­ï¼ˆæœ¬åœ°p/å…¨å±€schedtï¼‰ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•° nextï¼š\nnext ä¸º trueï¼šå°† G æ”¾åˆ°å¤„ç†å™¨çš„ p.runnext ä¸Šä½œä¸ºä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¦‚æœ p.runnext ä¸ŠåŸæ¥æœ‰ G ï¼Œåˆ™æŠŠä»–è¸¢åˆ°è¿è¡Œé˜Ÿåˆ—ä¸­ï¼› next ä¸º falseï¼šå¦‚æœæœ¬åœ°é˜Ÿåˆ—æœ‰ç©ºé—´åˆ™æ”¾æœ¬åœ°ï¼Œå¦åˆ™ï¼Œå°±ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­çš„ä¸€éƒ¨åˆ† Goroutine å’Œå¾…åŠ å…¥çš„ Goroutine æ·»åŠ åˆ°è°ƒåº¦å™¨æŒæœ‰çš„å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸Šï¼› æ£€æŸ¥ç©ºé—²çš„ Pï¼Œå¦‚æœæœ‰ï¼Œå°†å…¶å”¤é†’ï¼ˆæé«˜è°ƒåº¦å’Œæ‰§è¡Œæ•ˆç‡ï¼‰\nM æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œè°ƒåº¦å™¨æœ€å¤šå¯ä»¥åˆ›å»º 10000 ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯æœ€å¤šåªä¼šæœ‰å½“å‰æœºå™¨å†…æ ¸æ•° GOMAXPROCS ä¸ªæ´»è·ƒçº¿ç¨‹èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚ è¿è¡Œæ—¶å¯åŠ¨æ—¶ä¸ä¼šä¸€ä¸‹åˆ›å»ºå†…æ ¸æ•°ä¸ªM\næ•°æ®ç»“æ„ runtime.m ç»“æ„ä½“ä¸­åŒ…æ‹¬äº†è°ƒåº¦çº¿ç¨‹ g0 ï¼Œå½“å‰è¿è¡Œçš„goroutine curg ä»¥åŠä¸€äº›å¤„ç†å™¨ç›¸å…³å­—æ®µã€çŠ¶æ€ä¿¡æ¯ã€è°ƒåº¦ç›¸å…³ä¿¡æ¯ç­‰ç­‰\nçŠ¶æ€ ä¸¤ç§ï¼šè‡ªæ—‹å’Œéè‡ªæ—‹ è‡ªæ—‹çš„æ—¶å€™ï¼Œä¼šåŠªåŠ›æ‰¾å·¥ä½œï¼ˆæ£€æŸ¥å…¨å±€é˜Ÿåˆ—ï¼ŒæŸ¥çœ‹ network pollerï¼Œè¯•å›¾æ‰§è¡Œ gc ä»»åŠ¡ï¼Œæˆ–è€…â€œå·â€å·¥ä½œï¼‰ï¼›æ‰¾ä¸åˆ°çš„æ—¶å€™ä¼šè¿›å…¥éè‡ªæ—‹çŠ¶æ€ï¼Œä¹‹åä¼šä¼‘çœ ï¼Œç›´åˆ°æœ‰å·¥ä½œéœ€è¦å¤„ç†æ—¶ï¼Œè¢«å…¶ä»–å·¥ä½œçº¿ç¨‹å”¤é†’ï¼Œåˆè¿›å…¥è‡ªæ—‹çŠ¶æ€ã€‚ åˆå§‹åŒ– åˆ›å»ºæ—¶æœºï¼šè¿è¡Œæ—¶ç³»ç»Ÿå¯åŠ¨æ—¶ï¼ˆåˆ›å»ºm0ã€åˆ›å»ºsysmonçº¿ç¨‹\u0026hellip;ï¼‰ã€è°ƒåº¦Må»è¿è¡ŒPæ—¶ï¼ˆæ²¡æœ‰ç©ºé—²Måˆ™åˆ›å»ºæ–°çš„ï¼‰\nruntime.newm ä¸ºåˆ›å»ºæ–°çš„Mçš„é¡¶å±‚å‡½æ•°ï¼Œæ‰§è¡Œäº†åˆ†é…å†…å­˜ã€åˆå§‹åŒ–éƒ¨åˆ†å˜é‡ã€è°ƒç”¨åº•å±‚å‡½æ•°æ–°å»ºæ“ä½œç³»ç»Ÿçº¿ç¨‹ç­‰ã€‚\nç”±æ±‡ç¼–è¯­è¨€è°ƒç”¨ runtime.mstart å¯åŠ¨çº¿ç¨‹ï¼Œåˆå§‹åŒ–PCã€SPå’Œsignalç­‰è¿è¡Œç°åœºï¼Œè¿›å…¥è°ƒåº¦å¾ªç¯ã€‚\nP P åªæ˜¯å¤„ç†å™¨çš„æŠ½è±¡ï¼Œè€Œéå¤„ç†å™¨æœ¬èº«ã€‚è´Ÿè´£è°ƒåº¦æœ¬åœ°é˜Ÿåˆ—ä¸­çš„goroutineã€‚\næ•°æ®ç»“æ„ runtime.p ç»“æ„ä½“åå‘å­˜å‚¨ç€çº¿ç¨‹ m ï¼Œæœ¬åœ°Gé˜Ÿåˆ—ï¼ˆç¯å½¢é“¾è¡¨ï¼‰ã€çº¿ç¨‹ç¼“å­˜ï¼ˆmcacheï¼‰ä»¥åŠä¸€äº›è°ƒè¯•ã€GC è¾…åŠ©çš„å­—æ®µ\nçŠ¶æ€ ä¸€å…±æœ‰äº”ä¸ªçŠ¶æ€ï¼š\n_Pidleï¼šP å¤„äºç©ºé—² _Prunningï¼šè¢« M æŒæœ‰ï¼Œæ­£åœ¨æ‰§è¡Œ _Psyscallï¼šG é™·å…¥ç³»ç»Ÿè°ƒç”¨ _Pgcstopï¼šè¢« M æŒæœ‰ï¼Œç”±äº GC è¢«åœæ­¢ _Pdeadï¼šç”±äº GOMAXPROCS shrankï¼Œå½“å‰ P ä¸å†è¢«ä½¿ç”¨ åˆå§‹åŒ– æ—¶æœºï¼šè¿è¡Œæ—¶å¯åŠ¨æ—¶ï¼Œå†…æ ¸æ•°å˜åŒ–æ—¶ï¼ˆå¾ˆå°‘è§ï¼‰ runtime.procresize è´Ÿè´£pçš„åˆå§‹åŒ–ï¼Œè°ƒç”¨æ—¶è¿›å…¥ world stopped çŠ¶æ€ï¼›\næ ¹æ®æ–°çš„å†…æ ¸æ•°æ‰©å®¹æˆ–ç¼©å‡ allp å…¨å±€påˆ—è¡¨ æ‰©å®¹ï¼šç”³è¯·æ–°çš„På¯¹è±¡ã€åšä¸€äº›åˆå§‹åŒ–æ“ä½œ ç¼©å‡ï¼šé‡Šæ”¾è¢«ç¼©å‡çš„Pæ‰€æŒæœ‰çš„èµ„æºï¼Œå¹¶ç½®å…¶ä¸º _Pdead çŠ¶æ€ åˆ¤æ–­å½“å‰Gä½¿ç”¨çš„Pæ˜¯å¦åº”è¯¥è¢«é‡Šæ”¾ï¼ˆPåœ¨è¢«ç¼©å‡çš„èŒƒå›´å†…ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†å½“å‰Pæ›´æ¢ä¸º allp[0]ï¼› éå†å…¨å±€Påˆ—è¡¨ å¦‚æœæœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ç½®ä¸º _Pidle çŠ¶æ€ï¼Œæ”¾å…¥ schedt è°ƒåº¦å™¨çš„ç©ºé—²Påˆ—è¡¨ å¦‚æœæœ¬åœ°é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™ç»‘å®šä¸€ä¸ªMï¼ŒåŠ å…¥å¯è¿è¡Œçš„Pé“¾è¡¨ è¿”å›å¯è¿è¡Œçš„Pé“¾è¡¨ è°ƒåº¦ è§¦å‘è°ƒåº¦çš„æ¡ä»¶ æ ¹æ® runtime.schedule å‡½æ•°çš„è°ƒç”¨æ–¹ï¼Œå¯åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š\nçº¿ç¨‹å¯åŠ¨ runtime.mstart å’Œ Goroutine æ‰§è¡Œç»“æŸæ—¶ å†…å­˜åŒæ­¥è®¿é—®æ—¶ï¼ˆmutexï¼Œchannelç­‰é˜»å¡æ—¶ï¼‰ï¼Œä¸»åŠ¨æŒ‚èµ· ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒG å¯¹åº”çš„ M å’Œ P ä¹Ÿé˜»å¡åœ¨ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ä¸ä¼šç«‹åˆ»å‘ç”ŸæŠ¢å ï¼Œåªæœ‰å½“è¿™ä¸ªé˜»å¡æŒç»­æ—¶é—´è¿‡é•¿ï¼ˆ10 msï¼‰æ—¶ï¼Œæ‰ä¼šå°† Pï¼ˆåŠä¹‹ä¸Šçš„å…¶ä»– Gï¼‰æŠ¢å å¹¶åˆ†é…åˆ°ç©ºé—²çš„ M ä¸Š åä½œå¼è°ƒåº¦ï¼Œä¸»åŠ¨è®©å‡ºPï¼Œå‘ç”Ÿåœ¨Gæ—¶é—´ç‰‡è€—å°½ ç³»ç»Ÿç›‘æ§ã€GCç­‰ è°ƒåº¦å¾ªç¯ è°ƒåº¦å‡½æ•° runtime.schedule æ˜¯ä¸€ä¸ªæ°¸ä¸è¿”å›çš„å‡½æ•°ï¼Œæ˜¯ç”±æ¯ä¸ªç³»ç»Ÿçº¿ç¨‹Mçš„g0è°ƒç”¨çš„ï¼Œä¸æ–­å¯»æ‰¾å¾…è¿è¡Œçš„Gå¹¶æ‰§è¡Œï¼Œåœ¨Gç»“æŸåä¼šè¿”å›è°ƒåº¦å‡½æ•°å¼€å¤´å¼€å§‹ä¸‹ä¸€è½®å¾ªç¯ï¼›\nå¦‚ä½•å¯»æ‰¾å¯è¿è¡Œçš„goroutineï¼ˆåºå·ä¸ºå¯»æ‰¾ä¼˜å…ˆçº§ï¼‰ ä¸ºä¿è¯å…¬å¹³ï¼Œæ¯61æ¬¡è°ƒåº¦å°†é¦–å…ˆä»è°ƒåº¦å™¨ï¼ˆruntime.schedï¼‰å…¨å±€é˜Ÿåˆ—ä¸­è·å–Gï¼›å–1ä¸ªç›´æ¥è¿”å›ã€‚ ä»pæœ¬åœ°é˜Ÿåˆ—è·å–ï¼›å–runnextï¼Œä¸è¡Œå†å–é˜Ÿé¦–ã€‚ ä»å…¨å±€é˜Ÿåˆ—è·å–ï¼›å·å–çš„Gæ•°é‡æœ€å¤šä¸ºæœ¬åœ°é˜Ÿåˆ—å®¹é‡çš„ä¸€åŠï¼Œæœ€å°‘ä¸ºå…¨å±€é˜Ÿåˆ—ä¸­çš„Gè¢«æ¯ä¸ªPå¹³åˆ†åˆ°çš„æ•°é‡ã€‚ ä»netpollè·å–ï¼› ä»å…¶ä»–På·å–ï¼› å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™å°†måˆ‡æ¢è‡³ä¼‘çœ çŠ¶æ€ï¼Œåœ¨åˆ‡æ¢æœŸé—´è¿˜ä¼šä¸€æ­¥ä¸‰å›å¤´åœ°å†ç¡®è®¤ä¸€éç¡®å®æ²¡æœ‰å¯è¿è¡Œçš„Gäº†ï¼› æ­¥éª¤1å’Œ3éƒ½æ˜¯ä»å…¨å±€é˜Ÿåˆ—è·å–ï¼Œä½†æ˜¯æ­¥éª¤3ä¼šè·å–å¤šä¸ªGï¼Œè¿”å›å…¨å±€é˜Ÿåˆ—çš„é˜Ÿé¦–Gï¼Œå‰©ä¸‹çš„æ”¾åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚ æ€ä¹ˆå· å·å– ç‰¹æŒ‡ä»å…¶ä»–Pä¸­è·å–Gã€‚ æ€»å…±å°è¯•å››æ¬¡ï¼Œæ¯æ¬¡éƒ½ä¼šä»¥éšæœºçš„é¡ºåºéå†æ‰€æœ‰Pï¼Œç›´åˆ°å·åˆ°ã€‚\nå‰ä¸‰æ¬¡ä¼šé€‰æ‹©ä¸åœ¨ç©ºé—²çŠ¶æ€çš„Pï¼ˆä»ç©ºé—²çš„Pè‚¯å®šè·å–ä¸åˆ°Gï¼‰ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æœ‰Gçš„è¯ï¼Œä¼šå°†ä¸€åŠçš„Gå·åˆ°è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—é‡Œæ¥ï¼›\nå¦‚æœå‰ä¸‰æ¬¡éƒ½æ²¡å·åˆ°ï¼Œæœ€åä¸€æ¬¡ä¼šå…ˆçœ‹runnextä½ç½®ä¸Šæœ‰æ²¡æœ‰Gï¼Œå†çœ‹æœ¬åœ°é˜Ÿåˆ—ï¼Œæœ‰å°±å·ä¸€ä¸ªï¼Œè¿˜å¯èƒ½çªƒå–å¤„ç†å™¨çš„è®¡æ—¶å™¨ï¼›\næ€ä¹ˆæ‰§è¡Œ å·åˆ°Gä»¥åï¼Œè°ƒç”¨ runtime.execute è®©Gåœ¨Mä¸Šè·‘èµ·æ¥\nç»‘å®šMå’ŒGï¼Œå°†Gç½®ä¸º _Grunning çŠ¶æ€ é€šè¿‡ runtime.gogo å°†Gè°ƒåº¦åˆ°å½“å‰çº¿ç¨‹ä¸Šï¼Œæ˜¯ç”±æ±‡ç¼–æŒ‡ä»¤å®ç°çš„ Gæ‰§è¡Œå®Œæˆåï¼Œè½¬æ¢GçŠ¶æ€ä¸º _Gdeadï¼Œè§£ç»‘G/Mï¼Œå°†GåŠ å…¥gFreeåˆ—è¡¨ï¼Œåˆ‡æ¢å›g0å¼€å§‹æ–°ä¸€è½®çš„è°ƒåº¦ æ€»ç»“ä¸€ä¸‹ è§¦å‘è°ƒåº¦ä¼šå°†å½“å‰Gåˆ‡æ¢å›g0ï¼Œç”±g0è¿›è¡Œè°ƒåº¦æ“ä½œï¼Œå¾…æ‰¾åˆ°å¾…è¿è¡Œçš„Gåï¼Œå°†Gåˆ‡æ¢åˆ°å½“å‰Mä¸Š\nTODO ä¿¡å·å¤„ç†æœºåˆ¶ï¼Œåä½œä¸æŠ¢å \n","permalink":"http://localhost:1313/posts/golang/goroutine/","summary":"ä»‹ç»äº†goroutineå’Œçº¿ç¨‹çš„åŒºåˆ«ï¼ŒåŒ…æ‹¬åˆ›å»ºé”€æ¯æˆæœ¬ã€å†…å­˜å ç”¨å’Œåˆ‡æ¢æˆæœ¬ã€‚è®²è¿°äº†Goç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹å’Œè°ƒåº¦å™¨çš„ç»“æ„åŠè°ƒåº¦è¿‡ç¨‹ã€‚","title":"Go è°ƒåº¦å™¨"},{"content":"å‡½æ•°å‚æ•°å€¼ä¼ é€’ å‚è€ƒï¼šDravenessåšå®¢\nsliceä½œä¸ºå‚æ•° func TestPtr(t *testing.T) { a := []int{1, 2, 3} m := map[int]int{1: 1, 2: 2, 3: 3} t.Log(unsafe.Sizeof(a), unsafe.Sizeof(m)) // 24 8 t.Log(unsafe.Pointer(\u0026amp;a), unsafe.Pointer(\u0026amp;m)) // 0xc000134c78 0xc0001287d0 f := func(sl []int, mp map[int]int) { t.Log(unsafe.Pointer(\u0026amp;sl), unsafe.Pointer(\u0026amp;mp)) // 0xc000134c90 0xc0001287d8 sl[0] = 0 sl = append(sl, 4) // åŠ ä¸åˆ°aä¸Š m[1] = 0 m[4] = 4 } f(a, m) t.Log(a) // [0 2 3] t.Log(m) // map[1:0 2:2 3:3 4:4] } ç–‘æƒ‘ï¼š\nä¸ºå•¥ä¿®æ”¹å¯ä»¥åº”ç”¨åˆ°åŸåˆ‡ç‰‡ä½†æ˜¯ä¸èƒ½appendï¼Ÿ mapä¸ºå•¥åœ¨å‡½æ•°å†…éƒ¨å‘ç”Ÿæ‰©å®¹ï¼Œè¿™ä¸ªåŠ¨ä½œä¹Ÿä¼šåº”ç”¨åˆ°å¤–éƒ¨çš„mapä¸­? åŸå› ï¼š\nå‚æ•°å€¼ä¼ é€’ sliceåº•å±‚ç»“æ„ mapå˜é‡å®è´¨ å‚æ•°ä¼ é€’ ä¼ é€’åŸºæœ¬ç±»å‹æ—¶ï¼Œä¼šæ‹·è´å…¶å€¼ï¼› ä¼ é€’åˆ‡ç‰‡æˆ–æ•°ç»„æ—¶ï¼Œä¼šæ‹·è´åˆ‡ç‰‡æˆ–æ•°ç»„ä¸­çš„æ‰€æœ‰å€¼ï¼› ä¼ é€’ç»“æ„ä½“æ—¶ï¼šä¼šæ‹·è´ç»“æ„ä½“ä¸­çš„å…¨éƒ¨å†…å®¹ï¼› ä¼ é€’ç»“æ„ä½“æŒ‡é’ˆæ—¶ï¼šä¼šæ‹·è´ç»“æ„ä½“æŒ‡é’ˆçš„å€¼ï¼› sliceæ•°æ®ç»“æ„ type SliceHeader struct { Data uintptr Len int Cap int } Data æ˜¯æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆ; Len æ˜¯å½“å‰åˆ‡ç‰‡çš„é•¿åº¦ï¼› Cap æ˜¯å½“å‰åˆ‡ç‰‡çš„å®¹é‡ï¼Œå³ Data æ•°ç»„çš„å¤§å°ï¼š åŸå›  åˆ‡ç‰‡åœ¨å‡½æ•°å‚æ•°ä¸­è¿›è¡Œä¼ é€’ï¼Œç›¸å½“äºä¼ é€’SliceHeaderç»“æ„ä½“ï¼Œä¼šæ‹·è´ç»“æ„ä½“ä¸­çš„å…¨éƒ¨å†…å®¹ã€‚\næ ¹æ®ç´¢å¼•è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šæ ¹æ®Dataå­—æ®µæ‰¾åˆ°åº•å±‚çš„æ•°ç»„å¹¶ä¿®æ”¹å¯¹åº”çš„å€¼ï¼›ç”±äºå‡½æ•°å†…çš„åˆ‡ç‰‡slå’Œå‡½æ•°å¤–çš„åˆ‡ç‰‡aè™½ç„¶ä¸æ˜¯åŒä¸€ä¸ªSliceHeaderç»“æ„ä½“ï¼Œä½†æ˜¯å…¶ä¸­çš„å…¨éƒ¨å†…å®¹éƒ½ç›¸åŒï¼Œå¯¹dataæŒ‡å‘çš„åº•å±‚æ•°æ®è¿›è¡Œä¿®æ”¹ä¼šåœ¨ä¸¤ä¸ªç»“æ„ä½“ä¹‹é—´å…±äº«ã€‚\nè€Œappendä¸ä¼šå½±å“å‡½æ•°å¤–åˆ‡ç‰‡açš„åŸå› æ˜¯ï¼Œåˆ‡ç‰‡çš„æ•°æ®æ˜¯æ ¹æ®DataæŒ‡å‘çš„é¦–åœ°å€å’ŒLenåœˆå®šçš„èŒƒå›´å…±åŒå†³å®šçš„ï¼Œæ— è®ºå‡½æ•°å†…éƒ¨å¦‚ä½•appendï¼Œå¤–è¾¹åŸåˆ‡ç‰‡çš„Lenæ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥ç¡®å®šçš„åº•å±‚æ•°ç»„é•¿åº¦ä¹Ÿæ˜¯ä¸å˜çš„ï¼Œæ·»åŠ åˆ°æ•°ç»„æœ«å°¾çš„å…ƒç´ ä¸åœ¨Lenåœˆå®šçš„èŒƒå›´ä¹‹å†…ã€‚\nmapå˜é‡å®è´¨ å› ä¸ºmapã€channelè¿™ä¸¤ç§ç±»å‹çš„å€¼å…¶å®æ˜¯æŒ‡å‘runtime.hmapä¸runtime.hchançš„æŒ‡é’ˆï¼Œè€Œsliceç±»å‹å°±æ˜¯runtime.sliceHeaderç±»å‹ã€‚\næ ¹æ®ä¸Šè¾¹ä»£ç ä¸­è¿™ä¸€è¡Œè¾“å‡ºå¯ä»¥çœ‹å‡ºï¼š\nt.Log(unsafe.Sizeof(a), unsafe.Sizeof(m)) // 24 8 è¾“å‡ºä¸­24ç­‰äºSliceHeaderä¸­ä¸‰ä¸ªå­—æ®µå¤§å°ä¹‹å’Œï¼Œè€Œ8åˆ™å¯¹åº”ç€ä¸€ä¸ª uintptr çš„å¤§å°\næ‰€ä»¥sliceå’Œmapä½œä¸ºå½¢å‚è¿›è¡Œä¼ é€’åˆ†åˆ«å¯¹åº”ç€ä¸Šæ–‡æåˆ°çš„å‚æ•°ä¼ é€’è§„åˆ™ï¼š\nä¼ é€’ç»“æ„ä½“æ—¶ï¼šä¼šæ‹·è´ç»“æ„ä½“ä¸­çš„å…¨éƒ¨å†…å®¹ï¼› // slice ä¼ é€’ç»“æ„ä½“æŒ‡é’ˆæ—¶ï¼šä¼šæ‹·è´ç»“æ„ä½“æŒ‡é’ˆçš„å€¼ï¼› // map ","permalink":"http://localhost:1313/posts/golang/function_paramter_passing/","summary":"è¿™ç¯‡æ–‡ç« è®¨è®ºäº†Goè¯­è¨€ä¸­çš„å‚æ•°ä¼ é€’æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†åˆ‡ç‰‡å’Œæ˜ å°„æ—¶çš„è¡Œä¸ºã€‚æ–‡ç« æåˆ°å‚æ•°ä¼ é€’è§„åˆ™ã€åˆ‡ç‰‡ç»“æ„å’Œå…±äº«ã€ä¿®æ”¹å’Œæ·»åŠ å…ƒç´ çš„å½±å“ï¼Œä»¥åŠæ˜ å°„çš„å®è´¨ã€‚","title":"Go å‚æ•°ä¼ é€’æœºåˆ¶"},{"content":"map å‚è€ƒ Dravenessåšå®¢\næ•°æ®ç»“æ„ runtime/map.go\n// A header for a Go map. type hmap struct { count int // # live cells == size of map. Must be first (used by len() builtin) flags uint8 // æšä¸¾å€¼: 1 2 4 8 B uint8 // log_2 of # of buckets (can hold up to loadFactor * 2^B items) noverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details hash0 uint32 // hash seed buckets unsafe.Pointer // array of 2^B Buckets. may be nil if count==0. oldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) extra *mapextra // optional fields } // mapextra holds fields that are not present on all maps. type mapextra struct { overflow *[]*bmap oldoverflow *[]*bmap // nextOverflow holds a pointer to a free overflow bucket. nextOverflow *bmap } // runtime.mapä¸­å®šä¹‰çš„ç»“æ„ A bucket for a Go map. type bmap struct { tophash [bucketCnt]uint8 // å­˜å‚¨äº†é”®çš„å“ˆå¸Œçš„é«˜ 8 ä½ } // è¿è¡ŒæœŸé—´é‡æ„çš„bmapç»“æ„ type bmap struct { topbits [8]uint8 keys [8]keytype values [8]valuetype pad uintptr overflow uintptr } åˆå§‹åŒ– æ ¹æ®å…ƒç´ æ•°é‡å’Œsizeè®¡ç®—å‡ºéœ€è¦çš„æœ€å°æ¡¶æ•°é‡ï¼Œæ¡ä»¶ï¼šä½äºè£…è½½å› å­ï¼ˆè£…è½½å› å­:=å…ƒç´ æ•°é‡Ã·æ¡¶æ•°é‡ï¼‰\næ¡¶çš„æ•°é‡å¤šäº 2^4 æ—¶ï¼Œä¼šé¢å¤–åˆ›å»º 2^(B-4) ä¸ªæº¢å‡ºæ¡¶\nåˆ†é…å†…å­˜ç©ºé—´ï¼Œæ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶åœ¨å†…å­˜ä¸­çš„å­˜å‚¨ç©ºé—´æ˜¯è¿ç»­çš„ï¼ˆåœ¨åˆå§‹åŒ–æ—¶ï¼Œåç»­å¯èƒ½å› ä¸ºæ‰©å®¹è€Œä¸è¿ç»­ï¼‰ï¼Œåªæ˜¯è¢« hmap ä¸­çš„ä¸åŒå­—æ®µå¼•ç”¨ï¼ˆhmap.buckets, hmap.extra.overflowï¼‰\nè¯»å†™æ“ä½œ è®¿é—® å¦‚æœåœ¨æ‰©å®¹è¿‡ç¨‹ä¸­ï¼ˆ h.oldbuckets ä¸ä¸ºç©ºï¼‰å¹¶ä¸”æ¡¶ä¸­æ•°æ®æ²¡æœ‰è¢«åˆ†æµï¼ˆ evacuated ï¼‰ï¼Œåˆ™ä¸‹è¿°æ­¥éª¤1.2.3åˆ™åœ¨ h.oldbucketsï¼Œ h.extra.oldoverflow æ•°ç»„ä¸­å¯»æ‰¾ã€‚\næ ¹æ® hmap.B bucketçš„æ¬¡æ–¹æ•°ï¼ˆ2^Bï¼‰è®¡ç®—æ©ç ï¼ˆæ¯”å¦‚B=3ï¼Œåˆ™æ©ç ä¸ºâ€¦â€¦0111ï¼‰ï¼Œé€šè¿‡\u0026amp;è¿ç®—è®¡ç®—å‡ºkeyå“ˆå¸Œå€¼çš„ä½Bï¼ˆä¸æ˜¯8æ˜¯Bï¼‰ä½ï¼Œå¾—åˆ°å¯¹åº”æ¡¶åœ¨ hmap.buckets æ•°ç»„ä¸­çš„ç´¢å¼•å€¼ï¼Œä»è€Œå¯ä»¥é€šè¿‡æ•°ç»„é¦–åœ°å€å’Œç´¢å¼•å€¼å’Œå…ƒç´ ç±»å‹ä¸‰è€…è®¡ç®—å‡ºæ‰€æ±‚bucketå…ƒç´ ï¼ˆ bmap ï¼‰å†…å­˜åœ°å€ï¼›\næ‹¿åˆ°ç›¸åº”çš„bucketåï¼Œä¾æ¬¡éå†æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ä¸­çš„ bmap.tophash ï¼Œå…ˆæ¯”è¾ƒkeyçš„é«˜8ä½å’Œ tophash[i] ï¼Œåæ¯”è¾ƒä¼ å…¥çš„å’Œæ¡¶ä¸­çš„å€¼ä»¥åŠ é€Ÿæ•°æ®çš„è¯»å†™ï¼ˆtophashçš„ä½œç”¨ï¼Œç±»ä¼¼äºç´¢å¼•ï¼‰ã€‚\næ‰¾åˆ°keyåï¼Œå†ç”¨ bmap å†…å­˜åœ°å€åŠ ä¸Šåç§»é‡æ‰¾åˆ°å¯¹åº”çš„valueå€¼\nå†™å…¥ é¦–å…ˆæ ¹æ® hmap.flags åˆ¤æ–­æ˜¯å¦æœ‰å¹¶å‘å†™å…¥ï¼Œæœ‰åˆ™panicï¼›å¹¶å°†flagsç½®ä¸ºå†™å…¥çŠ¶æ€ï¼›\nå¦‚æœmapåœ¨æ‰©å®¹è¿‡ç¨‹ä¸­ï¼ˆ h.oldbuckets ä¸ä¸ºç©ºï¼‰ï¼Œåˆ™éœ€è¦å…ˆè¿›è¡Œå¢é‡åˆ†æµï¼ˆå°†æ—§æ¡¶åˆ†æµï¼ˆå¦‚æœæ²¡è¢«åˆ†æµè¿‡ï¼‰å¹¶é¢å¤–åˆ†æµ hmap.nevacuate å¯¹åº”çš„æ¡¶ï¼Œå³ç¬¬ä¸€ä¸ªè¿˜æ²¡è¢«åˆ†æµçš„æ¡¶ï¼‰ã€‚\næ¥ä¸‹æ¥ä¸»è¦é€»è¾‘å’Œè®¿é—®ç›¸ä¼¼ï¼Œä¾æ¬¡éå†æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ï¼š\nå¦‚æœé‡åˆ°ç›¸åŒçš„ tophash[i] ï¼Œåˆ™å‘ä¸‹å¯»æ‰¾å¯¹åº”çš„keyï¼Œè‹¥keyå€¼ç›¸åŒåˆ™è¿”å›å¯¹åº”çš„valueå†…å­˜åœ°å€ã€‚å¦‚æœä¸åŒåˆ™è·³è¿‡ï¼ˆè¿™é‡Œä¹Ÿè¯´æ˜tophashæ•°ç»„æ˜¯å¯èƒ½ä¼šæœ‰é‡å¤å€¼çš„ï¼Œä½†æ˜¯ä¸ä¼šå¤§é‡é‡å¤ï¼Œå› ä¸ºåœ¨é€‰æ‹©bukectæ—¶æ˜¯æŒ‰ç…§å“ˆå¸Œä½Bä½åˆ†æ¡¶çš„ï¼Œå‡å°‘åŒä¸€ä¸ªæ¡¶ä¸­æœ‰å¤§é‡ç›¸ç­‰ tophash çš„æ¦‚ç‡å½±å“æ€§èƒ½ã€‚ï¼‰ï¼›\nå¦‚æœé‡åˆ°ç©ºçš„tophash[i]ï¼Œåˆ™è·å–åˆ°keyå’Œå¾…èµ‹å€¼çš„valueä»¥åŠtophash[i]çš„å†…å­˜åœ°å€ï¼Œå¹¶åœ¨é€»è¾‘ä¸­æ ‡è®°çŠ¶æ€ä¸ºå·²å¡«å…¥ï¼Œé¿å…é‡å¤å†™å…¥ï¼›\nå¦‚æœæ‰€æœ‰æ¡¶ä¸­éƒ½æ²¡æœ‰ç©ºä½ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„æº¢å‡ºæ¡¶ä½œä¸ºæ¥æ”¶çš„æ¡¶ï¼›\nåœ¨å‡½æ•°æœ€åæœ€åè¿”å›valueå†…å­˜åœ°å€ã€‚è€ŒçœŸæ­£çš„èµ‹å€¼æ“ä½œæ˜¯åœ¨ç¼–è¯‘æœŸé—´æ’å…¥çš„ã€‚ æ‰©å®¹ ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰©å®¹ é€šè¿‡ hmap.oldbuckets æ˜¯å¦ä¸ºç©ºåˆ¤æ–­mapæ˜¯å¦åœ¨æ‰©å®¹è¿‡ç¨‹ä¸­ï¼›ï¼ˆmapæ‰©å®¹ä¸æ˜¯ä¸€ä¸ªåŸå­è¿‡ç¨‹ï¼‰\næ»¡è¶³ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€\nè£…è½½å› å­å·²ç»è¶…è¿‡6.5ï¼› -\u0026gt; ç¿»å€æ‰©å®¹\nå“ˆå¸Œä½¿ç”¨äº†å¤ªå¤šæº¢å‡ºæ¡¶ï¼› -\u0026gt; ç­‰é‡æ‰©å®¹\né—®ï¼šä¸ºä»€ä¹ˆä¼šç­‰é‡æ‰©å®¹ï¼Ÿ\nç­”ï¼šæŒç»­å‘å“ˆå¸Œä¸­æ’å…¥æ•°æ®å¹¶å°†å®ƒä»¬å…¨éƒ¨åˆ é™¤æ—¶ï¼Œå¦‚æœå“ˆå¸Œè¡¨ä¸­çš„æ•°æ®é‡æ²¡æœ‰è¶…è¿‡é˜ˆå€¼ï¼Œå°±ä¼šä¸æ–­ç§¯ç´¯æº¢å‡ºæ¡¶é€ æˆç¼“æ…¢çš„å†…å­˜æ³„æ¼ã€‚\næ‰©å®¹æ­¥éª¤ ç©ºé—´åˆ†é…ï¼šåœ¨å†™å…¥æ“ä½œä¸­ï¼ˆæ­¥éª¤2.3ä¹‹é—´ï¼‰ï¼Œå¦‚æœç¢°åˆ°éœ€è¦æ‰©å®¹çš„æƒ…å†µï¼Œåˆ™å°† hmap.buckets, hmap.extra.overflow ä¸­çš„æ•°æ®ç§»åˆ° h.oldbucketsï¼Œ h.extra.oldoverflow ä¸­ï¼Œ å¹¶åˆ›å»ºæ–°çš„æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶æ•°ç»„ï¼ˆç­‰é‡æˆ–ç¿»å€ï¼Œå› æ‰©å®¹ç±»å‹ä¸åŒè€Œå¼‚ï¼‰ã€‚è¿™ä¸€æ­¥éª¤åªæ˜¯åˆå§‹åŒ–äº†ç›¸åº”æ•°ç»„ï¼Œå®Œæˆåˆå§‹åŒ–åä¼šè¿”å›åˆ°å½“å‰å†™å…¥æ“ä½œå‡½æ•°å¼€å¤´çš„åˆ†æµå‡½æ•°ä½ç½®ï¼ˆå†™å…¥æ­¥éª¤2ï¼‰ï¼›\nå¢é‡åˆ†æµï¼š\nå£°æ˜ evacDst ç»“æ„ä½“ å¯¹äºç¿»å€æ‰©å®¹ï¼Œå£°æ˜ä¸¤ä¸ª evacDst ç»“æ„ä½“ä¿å­˜åˆ†é…ä¸Šä¸‹æ–‡å¹¶æŒ‡å‘æ–°æ¡¶ï¼ˆå…¶å®å°±æ˜¯ä¿å­˜äº†ä¸‹ä¸€ä¸ªåˆ†æµå‡ºçš„å…ƒç´ åº”è¯¥æ’å…¥çš„ä½ç½®ï¼ˆevacuation destinationï¼‰ï¼ŒåŒ…æ‹¬é”®/å€¼åœ°å€ã€ç´¢å¼•å€¼ã€æ–°æ¡¶åœ°å€ï¼‰ï¼›\nå¯¹äºç­‰é‡æ‰©å®¹ï¼Œå£°æ˜ä¸€ä¸ª evacDst ç»“æ„ä½“ï¼›\néå†æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼Œåˆ†æµåˆ° evacDst æŒ‡å‘çš„ä½ç½®ï¼Œå¦‚æœåˆ†æµæ¡¶è£…æ»¡äº†å°±æ–°å»ºä¸€ä¸ªæº¢å‡ºæ¡¶ï¼›\nå¦‚æœ h.nevacurate ç­‰äºå½“å‰æ¡¶åºå·ï¼Œè¯´æ˜å½“å‰åºå·ä¹‹å‰çš„æ¡¶å·²ç»åˆ†æµå®Œäº†ï¼Œåˆ™æ›´æ–°åˆ†æµè¿›åº¦ï¼ˆ h.nevacurate++ ç›´åˆ°ç¢°åˆ°ä¸€ä¸ªæ²¡è¢«åˆ†æµçš„æ—§æ¡¶ï¼‰ï¼›\nå¦‚æœ h.nevacurate ç­‰äºæ—§æ¡¶æ•°é‡ï¼Œè¯´æ˜mapä¸­æ‰€æœ‰æ¡¶éƒ½åˆ†æµå®Œäº†ï¼Œæ‰€ä»¥å°† h.oldbucketsï¼Œ h.extra.oldoverflow ç½®ç©ºé‡Šæ”¾å†…å­˜ï¼›\nåˆ é™¤ ä¸»è¦é€»è¾‘å’Œå†™å…¥åŸºæœ¬ç›¸åŒï¼Œéå†æ‰¾åˆ°é”®/å€¼åœ°å€ï¼Œé‡Šæ”¾å†…å­˜ï¼Œæ›´æ”¹tophash[i]çš„çŠ¶æ€ã€‚\n","permalink":"http://localhost:1313/posts/golang/map/","summary":"ä»‹ç»äº†mapçš„åº•å±‚ç»“æ„ä»¥åŠæ‰©å®¹è¿‡ç¨‹","title":"Go map"}]